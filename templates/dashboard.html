{% extends 'base.html' %}
{% block title %}Dashboard ‚Äì Second Brain{% endblock %}
{% block head_extra %}
  <link rel="stylesheet" href="/static/css/design-system.css">
  <link rel="stylesheet" href="/static/css/components.css">
  <link rel="stylesheet" href="/static/css/dashboard-enhanced.css">
  <style>
    body { background: #0f172a; font-family: 'Inter', Arial, sans-serif; }
    ::-webkit-scrollbar { width: 8px; background: #0b1220; }
    ::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 6px; }
    .card-surface { background: rgba(255,255,255,.04); border: 1px solid rgba(255,255,255,.08); }
    .muted { color: #a5b4fc; opacity: .8; }
    .pill { background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.12); }
    
    /* Additional footer centering to ensure perfect alignment */
    .footer {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
    }
    .footer-content {
      text-align: center;
      width: 100%;
      max-width: 768px;
      margin: 0 auto;
    }
    .footer-description {
      text-align: center;
      margin: 0 auto;
    }
    .footer-links {
      display: flex;
      justify-content: center;
      align-items: center;
    }
  </style>
{% endblock %}
{% block body_class %}min-h-screen text-slate-100 bg-slate-900{% endblock %}
{% block content %}

  <!-- Ultra-Compact Header / Logo / Top Bar -->
  <header class="w-full py-2 flex flex-col lg:flex-row lg:justify-between lg:items-center relative max-w-7xl mx-auto px-6">
    <!-- Page title for accessibility - brand is in global header -->
    <h1 class="sr-only">Dashboard</h1>
    
    <!-- Integrated Obsidian sync in header -->
    <div class="flex items-center gap-3 text-xs text-slate-400">
      <span>Obsidian</span>
      <span id="syncStatus">{% if last_sync %}Last: {{ last_sync }}{% else %}Never synced{% endif %}</span>
      <button id="syncBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold px-3 py-1.5 rounded-md transition">Sync</button>
      <!-- Three-dot menu wrapped to position dropdown relative to the trigger -->
      <span class="relative inline-block">
        <button id="syncMore" title="More options" class="px-2 py-1 rounded-md border border-slate-600 hover:bg-slate-800 text-slate-200 transition">‚ãØ</button>
        <div id="syncMenu" class="hidden absolute right-0 top-full mt-2 z-50 bg-slate-900 border border-slate-700 rounded-lg shadow-xl text-slate-100 w-48">
          <button data-dir="from_obsidian" class="w-full text-left px-3 py-2 hover:bg-slate-800">Sync from Obsidian</button>
          <button data-dir="bidirectional" class="w-full text-left px-3 py-2 hover:bg-slate-800 rounded-b-lg">Bidirectional sync</button>
        </div>
      </span>
    </div>
  </header>


  <!-- Main Content - Optimized 2-Column Layout -->
  <section class="w-full max-w-7xl mx-auto px-6 mb-4">
    <!-- Full-width search bar for symmetry -->
    <div class="mb-4">
      <form method="get" class="flex items-center gap-3">
        <input type="text" name="q" placeholder="Search your notes..." value="{{ q or '' }}" class="flex-1 rounded-lg border border-slate-700 bg-slate-800 text-slate-100 px-4 py-2 focus:ring-2 focus:ring-indigo-400 focus:outline-none placeholder:text-slate-400"/>
        <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-4 py-2 rounded-lg transition">Search</button>
        {% if q %}
          <a href="/" class="text-pink-300 underline text-sm">Clear</a>
        {% endif %}
        {% if tag %}
          <span class="text-green-300 text-sm">Tag: #{{ tag }}</span>
          <a href="/" class="text-yellow-300 underline text-sm">Clear filter</a>
        {% endif %}
      </form>
    </div>
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
      <!-- Left Column: Quick Capture (7 columns) -->
      <div class="lg:col-span-7">
        
        <!-- Quick Capture Form -->
        <div class="card-surface rounded-xl p-4 shadow-xl quick-capture-form">
          <form id="quickCaptureForm" method="post" action="/capture" enctype="multipart/form-data" class="space-y-4" autocomplete="off" role="form" aria-label="Quick note capture form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
            <!-- Hidden consolidated file input populated by JS -->
            <input type="file" name="file" id="file" class="hidden" />
            
            <!-- Text Input Row -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
              <div class="md:col-span-2">
                <label for="note" class="text-slate-300 text-xs font-semibold mb-2 block">Quick Note</label>
                <textarea name="note" id="note" rows="3" placeholder="Write a quick thought‚Ä¶" class="w-full rounded-lg border border-slate-700 bg-slate-800 text-slate-100 px-3 py-2 placeholder:text-slate-400 focus:ring-2 focus:ring-indigo-400 focus:outline-none"></textarea>
              </div>
              <div>
                <label for="tags" class="text-slate-300 text-xs font-semibold mb-2 block">Tags</label>
                <input type="text" name="tags" id="tags" placeholder="comma,separated" class="w-full rounded-lg border border-slate-700 bg-slate-800 text-slate-100 px-3 py-2 placeholder:text-slate-400 focus:ring-2 focus:ring-indigo-400 focus:outline-none">
              </div>
            </div>
            <!-- Action Buttons Row -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              <!-- Text Note Save -->
              <div>
                <button id="saveTextBtn" type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold px-4 py-2.5 rounded-lg transition flex items-center justify-center gap-2">
                  <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M15.854.146a.5.5 0 0 1 0 .708L11.707 6H14.5a.5.5 0 0 1 0 1h-4a.5.5 0 0 1-.5-.5v-4a.5.5 0 0 1 1 0v2.793L15.146.146a.5.5 0 0 1 .708 0z"/>
                  </svg>
                  <span id="saveTextSpinner" class="spinner" style="width:14px;height:14px;display:none;border-width:2px"></span>
                  <span id="saveTextText">Save Note</span>
                </button>
              </div>
              
              <!-- Audio Recording -->
              <div>
                <button type="button" id="recordBtn" class="w-full record-btn-enhanced" aria-describedby="recordStatus">
                  <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8 1a3 3 0 0 0-3 3v4a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3zM6 4a2 2 0 1 1 4 0v4a2 2 0 1 1-4 0V4z"/>
                    <path d="M4 9a4 4 0 0 0 8 0v2a6 6 0 1 1-12 0V9a1 1 0 0 1 2 0z"/>
                  </svg>
                  <span class="record-text">Record Audio</span>
                </button>
              </div>
            </div>
            
            <!-- Multi-File Upload -->
            <div class="space-y-2">
              <label for="file" class="text-slate-300 text-xs font-semibold">Upload File</label>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-2 text-xs">
                <label class="flex items-center gap-2 cursor-pointer bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 hover:bg-slate-700 transition">
                  <svg width="14" height="14" fill="currentColor" class="text-green-400" viewBox="0 0 16 16">
                    <path d="M8 1a3 3 0 0 0-3 3v4a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3zM6 4a2 2 0 1 1 4 0v4a2 2 0 1 1-4 0V4z"/>
                    <path d="M4 9a4 4 0 0 0 8 0v2a6 6 0 1 1-12 0V9a1 1 0 0 1 2 0z"/>
                  </svg>
                  <span class="text-slate-200">Audio</span>
                  <input type="file" id="audioFile" accept="audio/*" class="hidden" onchange="handleFileSelect(this, 'audio')">
                </label>
                <label class="flex items-center gap-2 cursor-pointer bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 hover:bg-slate-700 transition">
                  <svg width="14" height="14" fill="currentColor" class="text-blue-400" viewBox="0 0 16 16">
                    <path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
                    <path d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2h-12zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.062L1.002 12V3a1 1 0 0 1 1-1h12z"/>
                  </svg>
                  <span class="text-slate-200">Image</span>
                  <input type="file" id="imageFile" accept="image/*" class="hidden" onchange="handleFileSelect(this, 'image')">
                </label>
                <label class="flex items-center gap-2 cursor-pointer bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 hover:bg-slate-700 transition">
                  <svg width="14" height="14" fill="currentColor" class="text-red-400" viewBox="0 0 16 16">
                    <path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5v2z"/>
                  </svg>
                  <span class="text-slate-200">PDF</span>
                  <input type="file" id="pdfFile" accept=".pdf,application/pdf" class="hidden" onchange="handleFileSelect(this, 'pdf')">
                </label>
              </div>
              <div id="selectedFile" class="hidden bg-slate-800/50 border border-slate-600 rounded-lg p-2">
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-2 text-xs">
                    <span id="fileIcon"></span>
                    <span id="fileName" class="text-slate-200"></span>
                    <span id="fileSize" class="text-slate-400"></span>
                  </div>
                  <button type="button" onclick="clearFileSelection()" class="text-slate-400 hover:text-red-400 transition">
                    <svg width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                      <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM5.354 4.646a.5.5 0 1 0-.708.708L7.293 8l-2.647 2.646a.5.5 0 0 0 .708.708L8 8.707l2.646 2.647a.5.5 0 0 0 .708-.708L8.707 8l2.647-2.646a.5.5 0 0 0-.708-.708L8 7.293 5.354 4.646z"/>
                    </svg>
                  </button>
                </div>
              </div>
            </div>
            
            <!-- Recording Status Indicators -->
            <div class="audio-recording-container">
              <span id="recordingBadge" class="text-red-400 text-xs hidden flex items-center gap-1">
                <span class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>Recording...
              </span>
              <div id="waveformVisualizer" class="waveform-visualizer hidden">
                <!-- Waveform bars will be created by JavaScript -->
              </div>
              <div id="recordingTimer" class="recording-timer hidden">00:00</div>
              <div id="recordStatus" class="audio-status"></div>
            </div>
          </form>
          
          <!-- Compact Tips -->
          <div class="bg-slate-800/30 rounded-lg p-2 mt-2">
            <p class="text-xs text-slate-400"><strong>üí° Tips:</strong> Save notes with text ‚Ä¢ Record audio for transcription ‚Ä¢ Use tags for organization ‚Ä¢ Ctrl/Cmd + Enter to save</p>
          </div>
        </div>
      </div>

      <!-- Right Column: Recent Notes (5 columns, slightly larger) -->
      <div class="lg:col-span-5">
        <aside id="recent-panel" class="recent-panel-enhanced card-surface rounded-xl p-5 shadow-xl max-h-[70vh] overflow-auto sticky top-20">
          <div class="flex items-center justify-between mb-2">
            <div class="flex items-center gap-2">
              <h3 class="text-sm font-semibold text-slate-200">Recent Notes</h3>
              <span id="queueIndicator" class="hidden text-[11px] px-2 py-0.5 rounded-full border border-slate-600 text-slate-300">Queue: 0</span>
            </div>
            <a href="/search" class="text-xs text-indigo-300 hover:underline">View all</a>
          </div>
        <div class="recent-search-container mb-2">
          <input 
            type="text" 
            id="recentSearch" 
            class="recent-search-input" 
            placeholder="Search recent notes..."
            aria-label="Search recent notes"
          >
          <button 
            type="button" 
            id="recentSearchClear" 
            class="recent-search-clear" 
            style="display: none;"
            aria-label="Clear search"
          >
            <svg width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
              <path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/>
            </svg>
          </button>
        </div>
        <div class="recent-sort-controls mb-2">
          <span class="text-xs text-slate-400">Sort by:</span>
          <button type="button" class="sort-button active" data-sort="date">
            Date <span class="sort-icon">‚Üì</span>
          </button>
          <button type="button" class="sort-button" data-sort="title">
            Title <span class="sort-icon">‚Üì</span>
          </button>
          <button type="button" class="sort-button" data-sort="type">
            Type <span class="sort-icon">‚Üì</span>
          </button>
          <button type="button" class="sort-button" data-sort="pinned">
            Pinned <span class="sort-icon">‚Üì</span>
          </button>
        </div>
        <ul class="divide-y divide-slate-700/50">
          {% for n in recent_notes %}
          <li class="recent-note-item py-1.5{% if n.tags and 'pinned' in n.tags %} pinned{% endif %}">
            <div class="flex items-start gap-3">
              <a href="/detail/{{ n.id }}" class="mt-0.5">
                {% set _ft = (n.file_type or '') if n.file_type is defined else '' %}
                {% set _mt = (n.file_mime_type or '') if n.file_mime_type is defined else '' %}
                {% if n.type == 'audio' %}
                  <span class="note-type-icon audio-note">üé§</span>
                {% elif n.type == 'apple' %}
                  <span class="note-type-icon shortcut-note">‚ö°</span>
                {% elif n.type == 'image' or _ft == 'image' or _mt.startswith('image/') %}
                  <span class="note-type-icon text-note">üñºÔ∏è</span>
                {% else %}
                  <span class="note-type-icon text-note">üìù</span>
                {% endif %}
              </a>
              <div class="min-w-0 flex-1">
                <div class="flex items-center justify-between gap-3">
                  <a href="/detail/{{ n.id }}" class="text-sm text-slate-100 truncate hover:underline">{{ n.title or '(untitled)' }}</a>
                  <div class="flex items-center gap-2">
                    {% if n.type != 'audio' %}
                    <button class="text-xs text-indigo-300 hover:underline recent-edit" data-id="{{ n.id }}" data-title="{{ n.title or '' }}" data-tags="{{ n.tags or '' }}">Edit</button>
                    {% endif %}
                    <button class="text-xs recent-pin" title="Pin" data-id="{{ n.id }}" data-tags="{{ n.tags or '' }}">
                      {% if n.tags and 'pinned' in n.tags %}‚òÖ{% else %}‚òÜ{% endif %}
                    </button>
                  </div>
                </div>
                {% set _ft = (n.file_type or '') if n.file_type is defined else '' %}
                {% set _mt = (n.file_mime_type or '') if n.file_mime_type is defined else '' %}
                {% if n.file_filename and (_ft == 'image' or _mt.startswith('image/')) %}
                <div class="mt-1 rounded overflow-hidden border border-slate-700/60 bg-black/20">
                  <a href="/detail/{{ n.id }}">
                    <img src="{{ n.file_url or ('/files/' ~ n.file_filename) }}" alt="Image preview" style="max-height:80px; width:100%; object-fit:cover; display:block;">
                  </a>
                </div>
                {% endif %}
                {% if n.file_filename and (_ft == 'document' or _mt == 'application/pdf') %}
                <div class="mt-1 rounded overflow-hidden border border-slate-700/60 bg-white">
                  <a href="/detail/{{ n.id }}">
                    <embed src="{{ n.file_url or ('/files/' ~ n.file_filename) }}#toolbar=0" type="application/pdf" style="width:100%; height:80px; display:block; border:none;">
                  </a>
                </div>
                {% endif %}
                <div class="text-xs text-slate-400 flex items-center gap-2">{{ n.timestamp[11:16] if n.timestamp else '' }}
                  {% if n.get('tz_abbr') %}
                  <span>{{ n.get('tz_abbr') }}</span>
                  {% endif %}
                  {% if n.type == 'audio' and n.get('audio_duration_hms') %}
                  <span>‚Ä¢ {{ n.get('audio_duration_hms') }}</span>
                  {% endif %}
                  {% if n.status != 'complete' %}
                  <span>‚Ä¢ processing‚Ä¶</span>
                  <button type="button" class="recent-viewlog text-indigo-300 hover:underline" data-id="{{ n.id }}">View log</button>
                  {% endif %}
                </div>
                <!-- Enhanced Inline editor -->
                <div class="inline-edit-container hidden" id="recent-edit-{{ n.id }}">
                  <input type="text" class="inline-edit-field" placeholder="Title" value="{{ n.title or '' }}" aria-label="Edit title" />
                  <input type="text" class="inline-edit-field" placeholder="Tags (comma-separated)" value="{{ n.tags or '' }}" aria-label="Edit tags" />
                  <div class="inline-edit-actions">
                    <button class="btn btn-secondary btn-sm recent-cancel" data-id="{{ n.id }}" type="button">Cancel</button>
                    <button class="btn btn-primary btn-sm recent-save" data-id="{{ n.id }}" type="button">Save</button>
                  </div>
                </div>
              </div>
            </div>
          </li>
          {% endfor %}
          {% if not recent_notes %}
          <li class="py-6 text-center text-slate-400 text-sm">No recent notes</li>
          {% endif %}
        </ul>
        <!-- Dynamic log panels will be injected here under their items -->
      </aside>
      </div>
    </div>
  </section>

  <!-- Compact Timeline Section -->
  <section class="w-full max-w-6xl mx-auto px-4 mb-3">
    <div class="flex items-center justify-between border-b border-slate-700 pb-2">
      <div class="flex items-center gap-2">
        <svg class="w-5 h-5 text-pink-200" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <rect x="3" y="4" width="18" height="18" rx="4" fill="#232c4e"/>
          <path stroke="#fae1e9" stroke-width="2" d="M8 2v4m8-4v4M3 10h18"/>
        </svg>
        <h2 class="text-xl font-bold text-pink-200">Timeline</h2>
        <span class="text-xs text-blue-300 hidden sm:inline">All notes, voice memos, and shortcuts</span>
      </div>
    </div>
  </section>

  <!-- Processing Queue Section -->
  <section id="processing-queue-section" class="flex justify-center mb-4" style="display: none;">
    <div class="w-full max-w-2xl">
      <div class="bg-blue-900/20 border border-blue-400/30 rounded-xl p-4">
        <div id="processing-queue">
          <!-- Queue items will be populated by JavaScript -->
        </div>
      </div>
    </div>
  </section>

  <!-- Compact Timeline: Grouped by Day -->
  <main class="w-full max-w-6xl mx-auto px-4">
    {% for day, notes_on_day in notes_by_day.items() %}
      <!-- Compact Day Label -->
      <div class="flex items-center gap-2 mt-4 mb-2 animate-fade-in">
        <span class="w-3 h-3 rounded-full bg-gradient-to-r from-yellow-400 to-yellow-200"></span>
        <span class="font-semibold text-blue-100 text-lg">{{ day }}</span>
        <div class="flex-1 h-px bg-gradient-to-r from-blue-200/20 to-transparent"></div>
      </div>
      
      <!-- Compact Note Grid -->
      <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-3 mb-4">
        {% for note in notes_on_day %}
          <!-- Compact Note Card -->
          <div class="card-interactive bg-white/5 rounded-lg border border-white/10 p-3 hover:shadow-lg hover:border-white/20 transition-all duration-300 cursor-pointer animate-fade-in"
              onclick="window.location='/detail/{{ note['id'] }}'" data-status="{{ note['status'] }}" data-note-id="{{ note['id'] }}">
            <!-- Compact Card Header -->
            <div class="flex items-center justify-between mb-1.5">
              <div class="flex items-center gap-1">
                {% set _ft = (note.get('file_type') or '') %}
                {% set _mt = (note.get('file_mime_type') or '') %}
                {% if note['type'] == 'audio' %}
                  <span class="w-2 h-2 rounded-full bg-yellow-400"></span>
                  <span class="text-xs font-medium text-yellow-400">Audio</span>
                {% elif note['type'] == 'apple' %}
                  <span class="w-2 h-2 rounded-full bg-green-400"></span>
                  <span class="text-xs font-medium text-green-400">Shortcut</span>
                {% elif note['type'] == 'image' or _ft == 'image' or _mt.startswith('image/') %}
                  <span class="w-2 h-2 rounded-full bg-blue-400"></span>
                  <span class="text-xs font-medium text-blue-400">Image</span>
                {% else %}
                  <span class="w-2 h-2 rounded-full bg-blue-400"></span>
                  <span class="text-xs font-medium text-blue-400">Note</span>
                {% endif %}
              </div>
              <div class="flex items-center gap-1 text-xs text-slate-400">
                <span class="font-mono">{{ note['timestamp'][11:16] }}</span>
                {% if note.get('tz_abbr') %}
                  <span>{{ note.get('tz_abbr') }}</span>
                {% endif %}
                {% if note['type'] == 'audio' and note.get('audio_duration_hms') %}
                  <span>‚Ä¢ {{ note.get('audio_duration_hms') }}</span>
                {% elif note.get('word_count') %}
                  <span>‚Ä¢ {{ note.get('word_count') }} words</span>
                {% endif %}
                <a href="/edit/{{ note['id'] }}" onclick="event.stopPropagation();" class="text-blue-400 hover:underline ml-2">Edit</a>
              </div>
            </div>
            
            <!-- Compact Note Content -->
            <div class="space-y-1.5">
              <h4 class="font-medium text-slate-100 text-sm line-clamp-2">
                {{ note['title']|highlight(q) }}
              </h4>
              {% set _ft = (note.get('file_type') or '') %}
              {% set _mt = (note.get('file_mime_type') or '') %}
              {% if (note.get('file_url') or note.get('file_filename')) 
                    and (note.get('type') == 'image' or _ft == 'image' or _mt.startswith('image/')) %}
                <div class="mt-2 rounded-md overflow-hidden border border-white/10 bg-black/20">
                  <img src="{{ note.get('file_url') or ('/files/' ~ note.get('file_filename')) }}" alt="Image preview"
                       style="max-height:180px; width:100%; object-fit:contain; display:block;">
                </div>
              {% endif %}
              {% if (note.get('file_url') or note.get('file_filename')) 
                    and (_ft == 'document' or _mt == 'application/pdf') %}
                <div class="mt-2 rounded-md overflow-hidden border border-white/10 bg-white">
                  <embed src="{{ note.get('file_url') or ('/files/' ~ note.get('file_filename')) }}#toolbar=0" type="application/pdf"
                         style="width:100%; height:180px; display:block; border:none;" />
                </div>
              {% endif %}

              {% if note['status'] != 'complete' %}
                <div class="flex items-center gap-2 text-xs text-blue-400">
                  <svg class="spinner w-3 h-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="10"></circle>
                  </svg>
                  <span>Processing...</span>
                  <button type="button" class="timeline-viewlog text-indigo-300 hover:underline" data-id="{{ note['id'] }}" onclick="event.stopPropagation();">View log</button>
                </div>
              {% else %}
                <div class="text-xs text-slate-300 line-clamp-3">
                  {{ note['summary']|highlight(q) }}
                </div>
                {% if note['actions'] %}
                  <div class="text-xs text-slate-400 line-clamp-2">
                    {% for act in note['actions'].split('\n')[:2] if act.strip() %}
                      ‚Ä¢ {{ act|highlight(q) }}{% if not loop.last %}<br>{% endif %}
                    {% endfor %}
                  </div>
                {% endif %}
              {% endif %}
              
              {% if note['tags'] %}
                <div class="flex flex-wrap gap-1 mt-2">
                  {% for tag_ in note['tags'].split(',')[:3] if tag_.strip() %}
                    <span class="text-xs bg-slate-700 text-slate-300 px-2 py-1 rounded">{{ tag_.strip() }}</span>
                  {% endfor %}
                  {% if note['tags'].split(',')|length > 3 %}
                    <span class="text-xs text-slate-400">+{{ note['tags'].split(',')|length - 3 }}</span>
                  {% endif %}
                </div>
              {% endif %}
            </div>
          </div>
          {% endfor %}
      </div>
    {% endfor %}
    
    {% if not notes_by_day %}
      <div class="text-center py-12">
        <svg width="48" height="48" fill="none" stroke="currentColor" stroke-width="1" viewBox="0 0 24 24" class="mx-auto mb-4 text-slate-400">
          <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
        </svg>
        <h3 class="text-lg font-medium text-slate-300 mb-2">No notes found</h3>
        <p class="text-slate-400">Start capturing your thoughts above, or try searching for something else!</p>
      </div>
    {% endif %}
  </main>

  <!-- Footer -->
  <footer class="footer">
    <div class="footer-content">
      <p class="footer-description">
        Your thoughts - local, searchable, and AI-powered. Compatible with Obsidian & Apple Shortcuts
      </p>
      <div class="footer-links">
        <a href="/search" class="footer-link">Advanced Search</a>
      </div>
    </div>
  </footer>

  <!-- Enhanced Audio Recorder Script -->
  <script>
    // Signed token for SSE authentication (no headers required)
    window.SSE_TOKEN = '{{ sse_token }}';
  </script>
  <script>
    // Enhanced Recording System
    class AudioRecorder {
      constructor() {
        this.mediaRecorder = null;
        this.audioChunks = [];
        this.recording = false;
        this.recordingStartTime = null;
        this.timerInterval = null;
        
        this.recordBtn = document.getElementById('recordBtn');
        this.recordStatus = document.getElementById('recordStatus');
        this.recordingBadge = document.getElementById('recordingBadge');
        this.recordingTimer = document.getElementById('recordingTimer');
        this.waveformVisualizer = document.getElementById('waveformVisualizer');
        
        this.fileInput = document.getElementById('file');
        this.form = document.getElementById('quickCaptureForm');
        this.noteInput = document.getElementById('note');
        this.tagsInput = document.getElementById('tags');
        this.csrfInput = document.querySelector('input[name="csrf_token"]');
        
        this.saveTextBtn = document.getElementById('saveTextBtn');
        
        this.init();
      }
      
      init() {
        this.bindEvents();
        this.createWaveformBars();
      }
      
      bindEvents() {
        // Text-only save button
        if (this.saveTextBtn) {
          this.saveTextBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            if (this.recording) {
              this.showToast('Stop recording before saving text note', 'warning');
              return;
            }
            // Clear any saved draft before submitting
            localStorage.removeItem('second_brain_draft');
            await this.submitTextNote();
          });
        }
        
        // Form submission handler - only handle if no file input value
        if (this.form) {
          this.form.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (this.recording) {
              this.showToast('Stop recording before submitting', 'warning');
              return;
            }
            let file = (this.fileInput && this.fileInput.files && this.fileInput.files[0]) ? this.fileInput.files[0] : null;
            if (!file) {
              const altIds = ['imageFile','pdfFile','audioFile'];
              for (const id of altIds) {
                const el = document.getElementById(id);
                if (el && el.files && el.files[0]) { file = el.files[0]; break; }
              }
            }
            // Clear any saved draft before submitting
            localStorage.removeItem('second_brain_draft');
            await this.submitCapture(file);
          });
        }
        
        // Recording button
        if (this.recordBtn) {
          this.recordBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            if (!this.recording) {
              await this.startRecording();
            } else {
              await this.stopRecording();
            }
          });
        }
      }
      
      createWaveformBars() {
        if (!this.waveformVisualizer) return;
        
        this.waveformVisualizer.innerHTML = '';
        for (let i = 0; i < 20; i++) {
          const bar = document.createElement('div');
          bar.className = 'waveform-bar';
          bar.style.height = '8px';
          this.waveformVisualizer.appendChild(bar);
        }
      }
      
      async startRecording() {
        if (!navigator.mediaDevices || !window.MediaRecorder) {
          this.setStatus('Recording not supported in this browser', 'error');
          return;
        }
        
        try {
          this.setStatus('Starting recording...', 'processing');
          
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          
          // Choose the best supported audio format
          let mimeType = '';
          const supportedTypes = [
            'audio/webm;codecs=opus',
            'audio/ogg;codecs=opus',
            'audio/webm',
            'audio/mp4'
          ];
          
          for (const type of supportedTypes) {
            if (MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported(type)) {
              mimeType = type;
              break;
            }
          }
          
          this.audioChunks = [];
          this.mediaRecorder = new MediaRecorder(stream, mimeType ? { mimeType } : undefined);
          
          this.mediaRecorder.ondataavailable = (event) => {
            if (event.data.size > 0) {
              this.audioChunks.push(event.data);
            }
          };
          
          this.mediaRecorder.onstop = async () => {
            await this.handleRecordingStop();
          };
          
          this.mediaRecorder.onerror = (event) => {
            console.error('MediaRecorder error:', event.error);
            this.setStatus('Recording error occurred', 'error');
            this.setRecordingState(false);
          };
          
          this.mediaRecorder.start();
          this.setRecordingState(true);
          this.setStatus('Recording... Click stop when finished', 'processing');
          
        } catch (error) {
          console.error('Error starting recording:', error);
          this.setStatus('Microphone access denied', 'error');
          this.setRecordingState(false);
        }
      }
      
      async stopRecording() {
        if (!this.mediaRecorder || !this.recording) return;
        
        try {
          this.setStatus('Stopping recording...', 'processing');
          this.mediaRecorder.stop();
          
          // Stop all tracks to release microphone
          if (this.mediaRecorder.stream) {
            this.mediaRecorder.stream.getTracks().forEach(track => track.stop());
          }
        } catch (error) {
          console.error('Error stopping recording:', error);
          this.setStatus('Error stopping recording', 'error');
          this.setRecordingState(false);
        }
      }
      
      async handleRecordingStop() {
        try {
          this.setStatus('Processing recording...', 'processing');
          
          if (this.audioChunks.length === 0) {
            this.setStatus('No audio data recorded', 'error');
            this.setRecordingState(false);
            return;
          }
          
          const mimeType = this.mediaRecorder.mimeType || 'audio/webm';
          const audioBlob = new Blob(this.audioChunks, { type: mimeType });
          
          // Generate appropriate filename
          const ext = mimeType.includes('ogg') ? 'ogg' : 
                     mimeType.includes('mp4') ? 'm4a' : 'webm';
          const filename = `recording-${Date.now()}.${ext}`;
          
          const audioFile = new File([audioBlob], filename, { type: mimeType });
          
          this.setStatus('Uploading audio...', 'processing');
          await this.submitCapture(audioFile);
          
        } catch (error) {
          console.error('Error processing recording:', error);
          this.setStatus('Failed to process recording', 'error');
        } finally {
          this.setRecordingState(false);
        }
      }
      
      setRecordingState(isRecording) {
        this.recording = isRecording;
        
        if (isRecording) {
          this.recordingStartTime = Date.now();
          this.startTimer();
          this.startWaveformAnimation();
          
          // Update UI for recording state
          if (this.recordBtn) {
            this.recordBtn.classList.add('recording');
            const recordText = this.recordBtn.querySelector('.record-text');
            if (recordText) recordText.textContent = 'Stop Recording';
          }
          
          if (this.recordingBadge) this.recordingBadge.classList.remove('hidden');
          if (this.recordingTimer) this.recordingTimer.classList.remove('hidden');
          if (this.waveformVisualizer) this.waveformVisualizer.classList.remove('hidden');
          if (this.fileInput) this.fileInput.disabled = true;
          if (this.saveTextBtn) this.saveTextBtn.disabled = true;
          
        } else {
          this.stopTimer();
          this.stopWaveformAnimation();
          
          // Update UI for stopped state
          if (this.recordBtn) {
            this.recordBtn.classList.remove('recording');
            const recordText = this.recordBtn.querySelector('.record-text');
            if (recordText) recordText.textContent = 'Record Audio';
          }
          
          if (this.recordingBadge) this.recordingBadge.classList.add('hidden');
          if (this.recordingTimer) {
            this.recordingTimer.classList.add('hidden');
            this.recordingTimer.textContent = '00:00';
          }
          if (this.waveformVisualizer) this.waveformVisualizer.classList.add('hidden');
          if (this.fileInput) this.fileInput.disabled = false;
          if (this.saveTextBtn) this.saveTextBtn.disabled = false;
        }
      }
      
      startTimer() {
        this.timerInterval = setInterval(() => {
          if (this.recordingStartTime && this.recordingTimer) {
            const elapsed = Math.floor((Date.now() - this.recordingStartTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            this.recordingTimer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
          }
        }, 1000);
      }
      
      stopTimer() {
        if (this.timerInterval) {
          clearInterval(this.timerInterval);
          this.timerInterval = null;
        }
      }
      
      startWaveformAnimation() {
        if (!this.waveformVisualizer) return;
        
        const bars = this.waveformVisualizer.querySelectorAll('.waveform-bar');
        
        const animate = () => {
          if (!this.recording) return;
          
          bars.forEach(bar => {
            const height = Math.random() * 32 + 8;
            bar.style.height = `${height}px`;
          });
          
          setTimeout(() => requestAnimationFrame(animate), 100);
        };
        
        animate();
      }
      
      stopWaveformAnimation() {
        if (!this.waveformVisualizer) return;
        
        const bars = this.waveformVisualizer.querySelectorAll('.waveform-bar');
        bars.forEach(bar => {
          bar.style.height = '8px';
        });
      }
      
      async submitTextNote() {
        const noteText = this.noteInput?.value?.trim() || '';
        const tagsText = this.tagsInput?.value?.trim() || '';
        
        if (!noteText) {
          this.showToast('Please enter some text before saving', 'warning');
          this.noteInput?.focus();
          return;
        }
        
        await this.submitCapture(null);
      }
      
      async submitCapture(file) {
        try {
          this.setSavingState(true);
          
          // Enhanced debugging for form submission
          console.log('=== FRONTEND FORM SUBMISSION DEBUG ===');
          console.log('Current URL:', window.location.href);
          console.log('CSRF Input Element:', this.csrfInput);
          console.log('CSRF Token Value:', this.csrfInput?.value || 'NOT FOUND');
          console.log('Note Content:', (this.noteInput?.value || '').trim());
          console.log('Tags Content:', (this.tagsInput?.value || '').trim());
          console.log('File Upload:', file ? `${file.name} (${file.type}, ${file.size} bytes)` : 'None');
          
          const formData = new FormData();
          if (this.csrfInput) formData.append('csrf_token', this.csrfInput.value || '');
          formData.append('note', (this.noteInput?.value || '').trim());
          formData.append('tags', (this.tagsInput?.value || '').trim());
          if (file) formData.append('file', file);
          
          // Debug FormData contents
          console.log('FormData contents:');
          for (let [key, value] of formData.entries()) {
            if (key === 'csrf_token') {
              console.log(`  ${key}: ${typeof value === 'string' ? value.substring(0, 10) + '...' : value}`);
            } else if (key === 'file') {
              console.log(`  ${key}: File(${value.name}, ${value.size} bytes)`);
            } else {
              console.log(`  ${key}: ${value}`);
            }
          }
          
          console.log('Making fetch request to /capture');
          
          // Don't set custom headers when sending FormData - let browser handle it
          const response = await fetch('/capture', {
            method: 'POST',
            body: formData,
            credentials: 'same-origin',
            headers: {
              'Accept': 'application/json'
            }
          });
          
          console.log('Response status:', response.status);
          console.log('Response headers:', [...response.headers.entries()]);

          // Handle redirects (e.g., auth required) gracefully
          if (response.redirected || (response.status === 302 || response.status === 401)) {
            const loc = response.url || '/login';
            this.showToast('Session expired. Redirecting to login‚Ä¶', 'warning');
            setTimeout(() => { window.location.href = loc; }, 500);
            return;
          }

          if (!response.ok) {
            const responseText = await response.text();
            console.log('Error response body:', responseText);
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          
          const contentType = response.headers.get('content-type') || '';
          if (!contentType.includes('application/json')) {
            // If server returned HTML (e.g., login page), redirect
            this.showToast('Redirecting‚Ä¶', 'info');
            try { const text = await response.text(); console.log('Non-JSON body preview:', text.slice(0,200)); } catch {}
            if (response.url) { window.location.href = response.url; return; }
            throw new Error('Unexpected response format');
          }
          
          const result = await response.json();
          console.log('Success response:', result);
          console.log('=== FRONTEND FORM SUBMISSION DEBUG END ===');
          
          this.showToast(file ? 'Uploaded successfully!' : 'Note saved successfully!', 'success');
          this.setStatus('', '');
          
          // Clear the form
          if (this.noteInput) this.noteInput.value = '';
          if (this.tagsInput) this.tagsInput.value = '';
          if (this.fileInput) this.fileInput.value = '';
          
          // Clear any saved draft
          localStorage.removeItem('second_brain_draft');
          
          // Clear form inputs
          if (this.noteInput) this.noteInput.value = '';
          if (this.tagsInput) this.tagsInput.value = '';
          if (this.fileInput) this.fileInput.value = '';
          
          // Reload page after short delay to show new note
          setTimeout(() => window.location.reload(), 1000);
          
        } catch (error) {
          console.error('=== FRONTEND FORM SUBMISSION ERROR ===');
          console.error('Error type:', error.constructor.name);
          console.error('Error message:', error.message);
          console.error('Full error:', error);
          console.error('=== FRONTEND FORM SUBMISSION ERROR END ===');
          this.showToast('Failed to save. Please try again.', 'error');
          this.setStatus('Upload failed - please try again', 'error');
        } finally {
          this.setSavingState(false);
        }
      }
      
      setSavingState(saving) {
        if (this.saveTextBtn) {
          const spinner = document.getElementById('saveTextSpinner');
          const text = document.getElementById('saveTextText');
          
          this.saveTextBtn.disabled = saving;
          if (spinner) spinner.style.display = saving ? 'inline-block' : 'none';
          if (text) text.textContent = saving ? 'Saving...' : 'Save Note';
        }
      }
      
      setStatus(message, type = '') {
        if (!this.recordStatus) return;
        
        this.recordStatus.textContent = message;
        this.recordStatus.className = `audio-status ${type}`;
      }
      
      showToast(message, type = 'info') {
        if (window.showToast) {
          window.showToast(message, type);
        } else {
          // Fallback notification
          console.log(`${type.toUpperCase()}: ${message}`);
        }
      }
    }
    
    // Initialize when DOM is ready
    let audioRecorder;
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        audioRecorder = new AudioRecorder();
      });
    } else {
      audioRecorder = new AudioRecorder();
    }
    
    // Make available globally for debugging
    window.audioRecorder = audioRecorder;
    
    // Simple Toast Notification System (fallback if not available)
    if (!window.showToast) {
      window.showToast = function(message, type = 'info', duration = 4000) {
        // Remove existing toasts
        const existingToasts = document.querySelectorAll('.toast-notification');
        existingToasts.forEach(toast => toast.remove());
        
        const toast = document.createElement('div');
        toast.className = `toast-notification toast-${type}`;
        toast.innerHTML = `
          <div class="toast-content">
            <div class="toast-icon">
              ${type === 'success' ? '‚úì' : 
                type === 'error' ? '‚úó' : 
                type === 'warning' ? '‚ö†' : '‚Ñπ'}
            </div>
            <div class="toast-message">${message}</div>
            <button class="toast-close" onclick="this.parentElement.parentElement.remove()">√ó</button>
          </div>
        `;
        
        // Add styles
        toast.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          z-index: 9999;
          max-width: 400px;
          background: ${type === 'success' ? '#10b981' : 
                       type === 'error' ? '#ef4444' : 
                       type === 'warning' ? '#f59e0b' : '#3b82f6'};
          color: white;
          border-radius: 8px;
          box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
          transform: translateX(100%);
          transition: transform 0.3s ease;
        `;
        
        const content = toast.querySelector('.toast-content');
        content.style.cssText = `
          display: flex;
          align-items: center;
          gap: 12px;
          padding: 16px;
        `;
        
        const icon = toast.querySelector('.toast-icon');
        icon.style.cssText = `
          font-size: 20px;
          font-weight: bold;
        `;
        
        const messageEl = toast.querySelector('.toast-message');
        messageEl.style.cssText = `
          flex: 1;
          font-size: 14px;
          line-height: 1.4;
        `;
        
        const closeBtn = toast.querySelector('.toast-close');
        closeBtn.style.cssText = `
          background: none;
          border: none;
          color: white;
          font-size: 20px;
          cursor: pointer;
          padding: 0;
          margin-left: 8px;
          opacity: 0.7;
          transition: opacity 0.2s;
        `;
        
        closeBtn.addEventListener('mouseover', () => closeBtn.style.opacity = '1');
        closeBtn.addEventListener('mouseout', () => closeBtn.style.opacity = '0.7');
        
        document.body.appendChild(toast);
        
        // Animate in
        requestAnimationFrame(() => {
          toast.style.transform = 'translateX(0)';
        });
        
        // Auto remove
        setTimeout(() => {
          if (toast.parentNode) {
            toast.style.transform = 'translateX(100%)';
            setTimeout(() => {
              if (toast.parentNode) {
                toast.remove();
              }
            }, 300);
          }
        }, duration);
        
        return toast;
      };
    }
  </script>
  <script>
    // Inline edit for recent notes (title/tags)
    const csrfToken = '{{ csrf_token }}';
    document.querySelectorAll('.recent-edit').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.dataset.id;
        const panel = document.getElementById(`recent-edit-${id}`);
        if (panel) panel.classList.toggle('hidden');
      });
    });
    document.querySelectorAll('.recent-cancel').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.dataset.id;
        const panel = document.getElementById(`recent-edit-${id}`);
        if (panel) panel.classList.add('hidden');
      });
    });
    document.querySelectorAll('.recent-save').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = btn.dataset.id;
        const panel = document.getElementById(`recent-edit-${id}`);
        if (!panel) return;
        const [titleInput, tagsInput] = panel.querySelectorAll('input');
        const payload = { title: titleInput.value, tags: tagsInput.value };
        try {
          const res = await fetch(`/api/notes/${id}/update`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken },
            body: JSON.stringify(payload)
          });
          if (!res.ok) throw new Error('Save failed');
          // Update UI
          const link = panel.parentElement.querySelector('a.text-sm');
          if (link) link.textContent = payload.title || link.textContent;
          panel.classList.add('hidden');
          if (window.showToast) showToast('Note updated', 'success');
        } catch (e) {
          if (window.showToast) showToast('Could not save changes', 'error');
        }
      });
    });

    // Pin/Unpin by toggling 'pinned' tag
    document.querySelectorAll('.recent-pin').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = btn.dataset.id;
        let tags = (btn.dataset.tags || '').split(',').map(t=>t.trim()).filter(Boolean);
        const hasPinned = tags.includes('pinned');
        if (hasPinned) tags = tags.filter(t => t !== 'pinned'); else tags.push('pinned');
        try {
          const res = await fetch(`/api/notes/${id}/update`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken },
            body: JSON.stringify({ tags: tags.join(',') })
          });
          if (!res.ok) throw new Error('Failed');
          // Update button and dataset
          btn.dataset.tags = tags.join(',');
          btn.textContent = tags.includes('pinned') ? '‚òÖ' : '‚òÜ';
          if (window.showToast) showToast(tags.includes('pinned') ? 'Pinned' : 'Unpinned', 'info');
        } catch (e) {
          if (window.showToast) showToast('Pin toggle failed', 'error');
        }
      });
    });

    // View log via SSE for processing notes
    const openStreams = {};
    function renderLogPanel(id) {
      let panel = document.getElementById('recent-log-' + id);
      if (panel) return panel;
      // Insert after the item's container
      const li = document.querySelector(`.recent-note-item .recent-viewlog[data-id="${id}"]`)?.closest('li');
      if (!li) return null;
      panel = document.createElement('div');
      panel.id = 'recent-log-' + id;
      panel.className = 'mt-2 p-2 rounded-md border border-slate-700 bg-slate-800/60';
      panel.innerHTML = `
        <div class="flex items-center justify-between">
          <div class="text-xs text-slate-300">Processing log</div>
          <button type="button" class="text-xs text-slate-300 hover:underline close-log" data-id="${id}">Hide</button>
        </div>
        <div class="w-full h-2 bg-slate-700 rounded mt-2"><div class="h-2 bg-indigo-500 rounded" style="width:0%" id="log-progress-${id}"></div></div>
        <ul class="mt-2 space-y-1 text-xs text-slate-300" id="log-messages-${id}"></ul>
      `;
      li.appendChild(panel);
      panel.querySelector('.close-log').addEventListener('click', ()=>{
        if (openStreams[id]) { openStreams[id].close(); delete openStreams[id]; }
        panel.remove();
      });
      return panel;
    }
    function appendMessage(id, text){
      const ul = document.getElementById('log-messages-' + id);
      if (!ul) return;
      const li = document.createElement('li');
      li.textContent = text;
      ul.appendChild(li);
    }
    function setProgress(id, pct){
      const bar = document.getElementById('log-progress-' + id);
      if (bar) bar.style.width = Math.min(100, Math.max(0, pct)) + '%';
    }
    document.querySelectorAll('.recent-viewlog').forEach(btn => {
      btn.addEventListener('click', ()=>{
        const id = btn.dataset.id;
        const panel = renderLogPanel(id);
        if (!panel) return;
        if (openStreams[id]) return; // already open

        let attempts = 0;
        async function connect(){
          const tok = (window.SSE_TOKEN && typeof window.SSE_TOKEN === 'string') ? ('?token=' + encodeURIComponent(window.SSE_TOKEN)) : '';
          const es = new EventSource('/api/status/stream/' + id + tok);
          openStreams[id] = es;
          es.onmessage = (evt)=>{
            try {
              const data = JSON.parse(evt.data);
              if (data.keepalive) return;
              if (data.error) { appendMessage(id, 'Error: ' + data.error); return; }
              if (data.message) appendMessage(id, data.message);
              if (typeof data.progress === 'number') setProgress(id, data.progress);
              if (data.completed || data.stage === 'complete') {
                appendMessage(id, 'Done');
                setProgress(id, 100);
                es.close(); delete openStreams[id];
                setTimeout(()=> window.location.reload(), 800);
              }
            } catch (e) {}
          };
          es.onerror = async ()=>{
            try { es.close(); } catch{}
            attempts += 1;
            const delay = attempts === 1 ? 1000 : attempts === 2 ? 2000 : attempts === 3 ? 5000 : 10000;
            // Try to refresh SSE token before reconnecting
            try {
              const r = await fetch('/api/sse-token', { credentials: 'same-origin' });
              if (r.ok) {
                const d = await r.json();
                if (d && d.token) window.SSE_TOKEN = d.token;
              }
            } catch {}
            setTimeout(()=>{
              if (document.getElementById('recent-log-' + id)) connect();
            }, delay);
          };
        }
        connect();
      });
    });

    // Queue indicator polling
    async function updateQueueIndicator(){
      try {
        const res = await fetch('/api/queue/status', { credentials: 'same-origin' });
        if (!res.ok) return;
        const data = await res.json();
        const ind = document.getElementById('queueIndicator');
        if (!ind) return;
        const total = (data.pending || 0) + (data.processing || 0);
        if (total > 0) {
          ind.textContent = `Queue: ${data.pending || 0} ‚Ä¢ Proc: ${data.processing || 0}`;
          ind.classList.remove('hidden');
        } else {
          ind.classList.add('hidden');
        }
      } catch {}
    }
    updateQueueIndicator();
    setInterval(updateQueueIndicator, 3000);
  </script>
  <script>
    const syncBtn = document.getElementById('syncBtn');
    const syncStatus = document.getElementById('syncStatus');
    const syncMore = document.getElementById('syncMore');
    const syncMenu = document.getElementById('syncMenu');

    function closeMenu() { if (syncMenu) syncMenu.classList.add('hidden'); }
    function openMenu() { if (syncMenu) syncMenu.classList.remove('hidden'); }
    document.addEventListener('click', (e) => {
      if (syncMenu && !syncMenu.contains(e.target) && e.target !== syncMore) closeMenu();
    });
    if (syncMore) {
      syncMore.addEventListener('click', (e) => {
        e.stopPropagation();
        if (syncMenu.classList.contains('hidden')) openMenu(); else closeMenu();
      });
    }

    async function performSync(dir) {
      syncStatus.textContent = 'Starting sync‚Ä¶';
      try {
        const res = await fetch(`/api/obsidian/sync?direction=${encodeURIComponent(dir)}`, { method: 'POST', credentials: 'same-origin' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        if (data.status === 'sync_started' || data.status === 'completed') {
          syncStatus.textContent = 'Sync started. Checking status‚Ä¶';
          setTimeout(async () => {
            try {
              const st = await fetch('/api/obsidian/status');
              if (st.ok) {
                const s = await st.json();
                syncStatus.textContent = `Last: ${s.last_sync || 'n/a'}`;
                if (window.showToast) {
                  const msg = dir === 'from_obsidian' ? 'Synced from Obsidian' : (dir === 'bidirectional' ? 'Bidirectional sync complete' : 'Synced to Obsidian');
                  showToast(msg, 'success');
                }
              }
            } catch {}
          }, 1500);
        } else {
          syncStatus.textContent = 'Sync request acknowledged';
          if (window.showToast) showToast('Sync requested', 'info');
        }
      } catch (e) {
        syncStatus.textContent = 'Sync failed';
        if (window.showToast) showToast('Sync failed', 'error');
      }
    }
    if (syncBtn) syncBtn.addEventListener('click', () => performSync('to_obsidian'));
    if (syncMenu) syncMenu.querySelectorAll('button[data-dir]').forEach(btn => {
      btn.addEventListener('click', () => { closeMenu(); performSync(btn.dataset.dir); });
    });
  </script>

  <!-- Real-time Status Updates -->
  <script src="/static/js/realtime-status.js"></script>
  <script>
    // Initialize real-time status for any pending notes
    document.addEventListener('DOMContentLoaded', function() {
      // Monitor pending notes automatically
      const pendingElements = document.querySelectorAll('[data-status="pending"]');
      
      // Show processing queue section if there are pending notes
      if (pendingElements.length > 0) {
        document.getElementById('processing-queue-section').style.display = 'flex';
      }
      
      pendingElements.forEach(element => {
        const noteId = element.dataset.noteId;
        if (noteId) {
          console.log('Starting real-time monitoring for note', noteId);
          
          // Add progress container to the note card
          const progressContainer = document.createElement('div');
          progressContainer.id = `progress-container-${noteId}`;
          progressContainer.className = 'mt-2';
          element.appendChild(progressContainer);
          
          realtimeStatus.monitorNote(parseInt(noteId), {
            progressContainer: progressContainer,
            onComplete: (data) => {
              console.log('Note processing complete:', data);
              // Refresh page after completion
              setTimeout(() => window.location.reload(), 2000);
            },
            onError: (error) => {
              console.error('Processing error for note', noteId, error);
              // Fall back to page refresh
              setTimeout(() => window.location.reload(), 3000);
            }
          });
        }
      });
      
      // Initialize queue monitoring
      realtimeStatus.setupQueueMonitor();
    });
  </script>
  <script>
    // After redirect with flash, surface a toast and scroll to Recent
    document.addEventListener('DOMContentLoaded', function(){
      const flashEl = document.getElementById('flash-container');
      if (!flashEl) return;
      const msg = flashEl.textContent.trim();
      if (msg && /Note queued/i.test(msg)) {
        if (window.showToast) showToast(msg, 'success');
        const recent = document.getElementById('recent-panel');
        if (recent && recent.scrollIntoView) setTimeout(()=>recent.scrollIntoView({behavior:'smooth', block:'start'}), 250);
      }
    });
  </script>

  <!-- Enhanced Dashboard JavaScript -->
  <script src="/static/js/dashboard-enhanced.js"></script>
  
  <script>
    // File handling for multi-file upload
    let selectedFileInput = null;
    
    function handleFileSelect(input, type) {
      const file = input.files[0];
      if (!file) return;
      
      // Clear other file inputs
      ['audioFile', 'imageFile', 'pdfFile'].forEach(id => {
        if (id !== input.id) {
          document.getElementById(id).value = '';
        }
      });
      
      // Set the main form file input
      const mainFileInput = document.getElementById('file');
      if (mainFileInput) {
        // Create a new FileList with our selected file
        const dt = new DataTransfer();
        dt.items.add(file);
        mainFileInput.files = dt.files;
      }
      
      // Store reference
      selectedFileInput = input;
      
      // Show file info
      showSelectedFile(file, type);

      // Auto-submit for audio, image, and PDF attachments
      if (type === 'audio' || type === 'image' || type === 'pdf') {
        try {
          // Prefer JSON flow via AudioRecorder helper if available
          if (window.audioRecorder && typeof window.audioRecorder.submitCapture === 'function') {
            // Slight delay to allow UI to update
            setTimeout(() => window.audioRecorder.submitCapture(file), 50);
          } else {
            // Fallback: submit the form normally (will redirect)
            const form = document.getElementById('quickCaptureForm');
            if (form) form.submit();
          }
        } catch (e) {
          console.error('Auto-submit (file) failed:', e);
        }
      }
    }
    
    function showSelectedFile(file, type) {
      const container = document.getElementById('selectedFile');
      const icon = document.getElementById('fileIcon');
      const name = document.getElementById('fileName');
      const size = document.getElementById('fileSize');
      
      // Set icon based on type
      const icons = {
        audio: 'üéµ',
        image: 'üñºÔ∏è',
        pdf: 'üìÑ'
      };
      
      icon.textContent = icons[type] || 'üìé';
      name.textContent = file.name;
      size.textContent = formatFileSize(file.size);
      
      container.classList.remove('hidden');
    }
    
    function clearFileSelection() {
      // Clear all file inputs
      ['audioFile', 'imageFile', 'pdfFile', 'file'].forEach(id => {
        const input = document.getElementById(id);
        if (input) input.value = '';
      });
      
      // Hide file info
      document.getElementById('selectedFile').classList.add('hidden');
      selectedFileInput = null;
    }
    
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }
    
    // Update form submission to handle different file types
    const originalSubmit = document.getElementById('quickCaptureForm').onsubmit;
    document.getElementById('quickCaptureForm').addEventListener('submit', function(e) {
      // Add file type info if available
      if (selectedFileInput) {
        const fileType = selectedFileInput.id.replace('File', '');
        console.log('Submitting with file type:', fileType);
      }
    });
  </script>

  <!-- Footer -->
  <footer class="footer w-full mt-12 py-8 border-t border-slate-700/50 bg-slate-900/50">
    <div class="footer-content max-w-4xl mx-auto px-6">
      <p class="footer-description text-center text-slate-300 text-sm">
        <span class="font-semibold text-blue-100">Second Brain</span> - Your thoughts - local, searchable, and AI-powered. Compatible with Obsidian &amp; Apple Shortcuts
      </p>
    </div>
  </footer>

{% endblock %}
