<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
    <title>Second Brain - Mobile Knowledge Management</title>
    
    <!-- Mobile-first meta tags -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Second Brain">
    <meta name="theme-color" content="#6366f1">
    <meta name="msapplication-navbutton-color" content="#6366f1">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    
    <!-- Preconnect for performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="manifest" href="/static/manifest.json">
    
    <!-- Static CSS Files -->
    <link rel="stylesheet" href="/static/css/design-system.css">
    <link rel="stylesheet" href="/static/css/components.css">
    <link rel="stylesheet" href="/static/css/dashboard-enhanced.css">
    <link rel="stylesheet" href="/static/css/dashboard-v3-animations.css">
    <link rel="stylesheet" href="/static/css/dashboard-v3-mobile.css">
    
    <!-- iOS splash screens -->
    <link rel="apple-touch-startup-image" href="/static/icons/splash-iphone6.png" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2)">
    <link rel="apple-touch-startup-image" href="/static/icons/splash-iphoneX.png" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3)">
    
    <!-- Safe area CSS variables -->
    <style>
        :root {
            --safe-area-inset-top: env(safe-area-inset-top, 0px);
            --safe-area-inset-bottom: env(safe-area-inset-bottom, 0px);
            --safe-area-inset-left: env(safe-area-inset-left, 0px);
            --safe-area-inset-right: env(safe-area-inset-right, 0px);
        }
    </style>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Inter', 'system-ui', 'sans-serif']
                    },
                    colors: {
                        // Dark theme color palette - sophisticated grays
                        slate: {
                            25: '#0a0e13',
                            50: '#0f1419',
                            100: '#16202b',
                            150: '#1a252f',
                            200: '#202c39',
                            250: '#283542',
                            300: '#334155',
                            350: '#3f4c5c',
                            400: '#4a5568',
                            450: '#5a6575',
                            500: '#64748b',
                            600: '#94a3b8',
                            700: '#cbd5e1',
                            750: '#d1d9e1',
                            800: '#e2e8f0',
                            850: '#f1f5f9',
                            900: '#f8fafc'
                        },
                        // Discord-inspired accents
                        discord: {
                            50: '#f0f4ff',
                            100: '#e0e7ff', 
                            200: '#c7d2fe',
                            300: '#a5b4fc',
                            400: '#818cf8',
                            500: '#6366f1', // Primary discord-like purple
                            600: '#5145cd',
                            700: '#4338ca',
                            800: '#3730a3',
                            900: '#312e81'
                        },
                        // Notion-inspired greens
                        notion: {
                            50: '#f0fdf4',
                            100: '#dcfce7',
                            200: '#bbf7d0',
                            300: '#86efac',
                            400: '#4ade80',
                            500: '#22c55e', // Notion green
                            600: '#16a34a',
                            700: '#15803d',
                            800: '#166534',
                            900: '#14532d'
                        },
                        // Spotify-inspired accent
                        spotify: {
                            50: '#f0fdf0',
                            100: '#dcfce7',
                            200: '#bbf7d0',
                            300: '#86efac',
                            400: '#4ade80',
                            500: '#1db954', // Spotify green
                            600: '#16a34a',
                            700: '#15803d',
                            800: '#166534',
                            900: '#14532d'
                        }
                    },
                    animation: {
                        'slide-in': 'slideIn 0.2s ease-out',
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'scale-in': 'scaleIn 0.2s ease-out',
                        'bounce-subtle': 'bounceSubtle 0.4s ease-out',
                        'pulse-skeleton': 'pulseKeleton 1.5s ease-in-out infinite',
                        'shake': 'shake 0.5s ease-in-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                        'slide-down': 'slideDown 0.3s ease-out'
                    },
                    boxShadow: {
                        'soft': '0 2px 12px -2px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03)',
                        'medium': '0 4px 20px -4px rgba(0, 0, 0, 0.08), 0 2px 8px -2px rgba(0, 0, 0, 0.04)',
                        'large': '0 8px 32px -8px rgba(0, 0, 0, 0.12), 0 4px 16px -4px rgba(0, 0, 0, 0.06)',
                        'glow': '0 0 20px rgba(99, 102, 241, 0.15)',
                        'glow-green': '0 0 20px rgba(34, 197, 94, 0.15)'
                    }
                }
            }
        }
    </script>

    <style>
        @keyframes slideIn {
            from { transform: translateX(-8px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes scaleIn {
            from { transform: scale(0.95); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        @keyframes bounceSubtle {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        
        @keyframes pulseKeleton {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-4px); }
            20%, 40%, 60%, 80% { transform: translateX(4px); }
        }
        
        @keyframes slideUp {
            from { transform: translateY(8px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes slideDown {
            from { transform: translateY(-8px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Custom scrollbar - Dark theme */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #16202b;
            border-radius: 4px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }

        /* Glassmorphism effects - Dark theme */
        .glass {
            backdrop-filter: blur(16px);
            background: rgba(22, 32, 43, 0.85);
            border: 1px solid rgba(148, 163, 184, 0.15);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .glass-light {
            backdrop-filter: blur(16px);
            background: rgba(26, 37, 47, 0.9);
            border: 1px solid rgba(148, 163, 184, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        .glass-dark {
            backdrop-filter: blur(16px);
            background: rgba(10, 14, 19, 0.95);
            border: 1px solid rgba(148, 163, 184, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
        }

        /* Dark theme hover effects */
        .notion-hover {
            transition: all 0.15s ease;
        }
        
        .notion-hover:hover {
            background: rgba(148, 163, 184, 0.08);
            transform: translateY(-1px);
            box-shadow: 0 8px 32px -4px rgba(0, 0, 0, 0.4);
        }

        /* Discord-style status indicators */
        .status-online { 
            background: linear-gradient(135deg, #22c55e, #16a34a);
            box-shadow: 0 0 8px rgba(34, 197, 94, 0.3);
        }
        
        .status-offline { 
            background: linear-gradient(135deg, #ef4444, #dc2626);
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.3);
        }

        /* Spotify-style progress bars */
        .progress-bar {
            background: linear-gradient(90deg, #1db954 0%, #22c55e 100%);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Modern input styles - Dark theme */
        .modern-input {
            background: rgba(22, 32, 43, 0.6);
            border: 2px solid rgba(148, 163, 184, 0.15);
            color: #cbd5e1;
            transition: all 0.2s ease;
        }
        
        .modern-input::placeholder {
            color: #64748b;
        }
        
        .modern-input:focus {
            background: rgba(26, 37, 47, 0.8);
            border-color: #6366f1;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.2);
            color: #e2e8f0;
        }
        
        /* Skeleton loading styles */
        .skeleton {
            background: linear-gradient(90deg, rgba(148, 163, 184, 0.1) 25%, rgba(148, 163, 184, 0.2) 50%, rgba(148, 163, 184, 0.1) 75%);
            background-size: 200% 100%;
            animation: pulseKeleton 1.5s ease-in-out infinite;
        }
        
        .skeleton-text {
            height: 0.875rem;
            border-radius: 0.25rem;
        }
        
        .skeleton-title {
            height: 1.25rem;
            border-radius: 0.375rem;
        }
        
        /* Toast notification styles */
        .toast {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 9999;
            max-width: 24rem;
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        /* Enhanced button states */
        .btn-loading {
            position: relative;
            color: transparent;
        }
        
        .btn-loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 1rem;
            height: 1rem;
            margin: -0.5rem 0 0 -0.5rem;
            border: 2px solid transparent;
            border-top-color: currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Tooltip styles */
        .tooltip {
            position: relative;
        }
        
        .tooltip::before {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-4px);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s, transform 0.2s;
            z-index: 1000;
        }
        
        .tooltip::after {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 4px solid transparent;
            border-top-color: rgba(0, 0, 0, 0.9);
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .tooltip:hover::before,
        .tooltip:hover::after {
            opacity: 1;
            transform: translateX(-50%) translateY(-8px);
        }
        
        .tooltip:hover::after {
            transform: translateX(-50%) translateY(-4px);
        }
        
        /* Enhanced hover effects */
        .hover-scale {
            transition: transform 0.2s ease;
        }
        
        .hover-scale:hover {
            transform: scale(1.02);
        }
        
        .hover-lift {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .hover-lift:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 32px -8px rgba(0, 0, 0, 0.2);
        }
        
        /* Error state styles */
        .error-shake {
            animation: shake 0.5s ease-in-out;
        }
        
        /* Focus indicators for accessibility */
        .focus-ring:focus {
            outline: 2px solid #6366f1;
            outline-offset: 2px;
        }
        
        /* Loading overlay */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 20, 25, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        .loading-overlay.show {
            opacity: 1;
            pointer-events: all;
        }
        
        /* Screen reader only */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        /* Responsive improvements */
        @media (max-width: 768px) {
            .toast {
                right: 1rem;
                left: 1rem;
                max-width: none;
            }
            
            .w-96 {
                width: 100%;
                max-width: 24rem;
            }
        }
        
        /* Touch improvements */
        @media (hover: none) and (pointer: coarse) {
            .hover-lift:hover,
            .hover-scale:hover,
            .notion-hover:hover {
                transform: none;
            }
            
            .tooltip:hover::before,
            .tooltip:hover::after {
                display: none;
            }
        }

        /* Testing Framework Styles */
        .help-highlight-pulse {
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.5);
            animation: pulse-highlight 2s ease-in-out infinite;
        }

        .help-highlight-default {
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.8);
            background: rgba(59, 130, 246, 0.1);
        }

        .help-tour-overlay {
            backdrop-filter: blur(4px);
        }

        .help-tour-tooltip {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .help-contextual-tip {
            backdrop-filter: blur(16px);
            z-index: 9999;
        }

        @keyframes pulse-highlight {
            0%, 100% { 
                box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.5); 
            }
            50% { 
                box-shadow: 0 0 0 8px rgba(59, 130, 246, 0.2); 
            }
        }

        /* Help overlay styles */
        .help-nav-item.active {
            background: rgba(59, 130, 246, 0.1);
            color: rgba(59, 130, 246, 1);
        }

        .help-search-result:hover {
            background: rgba(148, 163, 184, 0.05);
        }

        /* Testing indicators */
        .testing-error-boundary {
            border: 2px dashed #ef4444;
            background: rgba(239, 68, 68, 0.1);
            padding: 1rem;
            margin: 0.5rem 0;
        }

        .testing-performance-warning {
            border-left: 4px solid #f59e0b;
            background: rgba(245, 158, 11, 0.1);
            padding: 0.75rem 1rem;
            margin: 0.25rem 0;
        }

        .testing-accessibility-violation {
            outline: 2px solid #dc2626;
            outline-offset: 2px;
        }

        /* Accessibility improvements */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        .focus-visible {
            outline: 2px solid #2563eb;
            outline-offset: 2px;
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            .help-tour-tooltip {
                border: 2px solid;
            }
            
            .help-contextual-tip {
                border: 1px solid;
            }
        }

        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            .help-highlight-pulse,
            .animate-pulse,
            .animate-spin,
            .animate-bounce {
                animation: none;
            }
            
            .transition-all,
            .transition-colors,
            .transition-transform {
                transition: none;
            }
        }

        /* Dark mode adjustments for help system */
        @media (prefers-color-scheme: dark) {
            .help-tour-tooltip {
                background: rgba(30, 41, 59, 0.95);
                color: #f1f5f9;
                border: 1px solid rgba(148, 163, 184, 0.2);
            }
            
            .help-contextual-tip {
                background: rgba(15, 23, 42, 0.95);
                color: #f1f5f9;
                border: 1px solid rgba(148, 163, 184, 0.2);
            }
        }

        /* Smart suggestion styles */
        .smart-suggestion {
            backdrop-filter: blur(16px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .smart-suggestion:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        /* Content suggestion styles */
        .content-suggestions {
            backdrop-filter: blur(12px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        /* Auto-save indicator */
        .auto-save-indicator {
            backdrop-filter: blur(8px);
            transition: opacity 0.2s ease-in-out;
        }

        /* Drag and drop visual feedback for testing */
        .drag-active .drop-zone-visible {
            border: 2px dashed #3b82f6;
            background: rgba(59, 130, 246, 0.05);
        }

        .drag-over {
            border-color: #10b981 !important;
            background: rgba(16, 185, 129, 0.1) !important;
        }

        /* Performance testing visual indicators */
        .performance-regression {
            position: relative;
        }

        .performance-regression::after {
            content: "‚ö†Ô∏è";
            position: absolute;
            top: -8px;
            right: -8px;
            background: #fbbf24;
            color: #92400e;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            z-index: 10;
        }

        /* Memory usage indicator */
        .memory-usage-high {
            background: linear-gradient(45deg, transparent 49%, #ef4444 49%, #ef4444 51%, transparent 51%);
            background-size: 6px 6px;
            opacity: 0.3;
            pointer-events: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 9998;
        }
    </style>

    <!-- Chart.js for analytics visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.js"></script>
</head>

<body class="h-full bg-slate-50 font-sans text-slate-700" data-mobile-interface="enabled" style="overflow-x: hidden; overscroll-behavior: none;">
    <!-- App Container -->
    <div id="app" class="flex h-full overflow-hidden">
        
        <!-- Sidebar Navigation - Obsidian/Discord inspired -->
        <aside id="sidebar" class="w-64 bg-slate-100 border-r border-slate-250/80 flex flex-col shadow-large lg:relative fixed left-0 top-0 h-full z-40 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out">
            <!-- Logo Section -->
            <div class="flex items-center justify-between p-4 border-b border-slate-200/50">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-discord-500 to-discord-600 rounded-xl flex items-center justify-center shadow-medium">
                        <span class="text-white text-lg font-semibold">üß†</span>
                    </div>
                    <div>
                        <h1 class="font-bold text-slate-900">Second Brain</h1>
                        <div class="flex items-center space-x-2">
                            <span class="text-xs text-slate-500">v2.0</span>
                            <div class="w-2 h-2 status-online rounded-full"></div>
                        </div>
                    </div>
                </div>
                <button onclick="toggleSidebar()" class="lg:hidden p-2 rounded-lg hover:bg-slate-100 transition-colors tooltip focus-ring" data-tooltip="Toggle Sidebar" aria-label="Toggle sidebar navigation">
                    <svg class="w-5 h-5 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <!-- Navigation Menu -->
            <nav class="flex-1 p-3 space-y-1 custom-scrollbar overflow-y-auto">
                <!-- Main Navigation -->
                <div class="space-y-1">
                    <a href="#dashboard" onclick="showView('dashboard')" class="nav-item active flex items-center px-3 py-2.5 rounded-lg font-medium transition-all text-sm">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5a2 2 0 012-2h2a2 2 0 012 2v2H8V5z"></path>
                        </svg>
                        Dashboard
                    </a>
                    
                    <a href="#notes" onclick="showView('notes')" class="nav-item flex items-center px-3 py-2.5 rounded-lg font-medium transition-all text-sm">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                        Notes
                        <span class="ml-auto bg-slate-200 text-slate-600 px-2 py-0.5 rounded-full text-xs font-medium">23</span>
                    </a>
                    
                    <a href="#search" onclick="showView('search')" class="nav-item flex items-center px-3 py-2.5 rounded-lg font-medium transition-all text-sm">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        Search
                    </a>
                    
                    <a href="#analytics" onclick="showView('analytics')" class="nav-item flex items-center px-3 py-2.5 rounded-lg font-medium transition-all text-sm">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        Analytics
                        <span class="ml-auto">üìä</span>
                    </a>
                    
                    <a href="#discord" onclick="showView('discord')" class="nav-item flex items-center px-3 py-2.5 rounded-lg font-medium transition-all text-sm">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                        </svg>
                        Discord Bot
                        <div class="ml-auto flex items-center space-x-1">
                            <div id="discordBotStatus" class="w-2 h-2 bg-gray-400 rounded-full"></div>
                            <span>ü§ñ</span>
                        </div>
                    </a>
                </div>

                <!-- Divider -->
                <div class="border-t border-slate-200/60 my-4"></div>

                <!-- Tools Section -->
                <div class="space-y-1">
                    <p class="px-3 text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2">Tools</p>
                    
                    <button onclick="showQuickUpload()" class="nav-item flex items-center w-full px-3 py-2.5 rounded-lg font-medium transition-all text-sm text-left">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                        </svg>
                        Upload Files
                    </button>
                    
                    <button onclick="console.log('üé§ DEBUG: Sidebar Voice Note clicked'); showVoiceRecordingModal()" class="nav-item flex items-center w-full px-3 py-2.5 rounded-lg font-medium transition-all text-sm text-left">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                        </svg>
                        Voice Note
                    </button>
                    
                    <button onclick="showView('settings')" class="nav-item flex items-center w-full px-3 py-2.5 rounded-lg font-medium transition-all text-sm text-left">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        Settings
                    </button>
                </div>

                <!-- Divider -->
                <div class="border-t border-slate-200/60 my-4"></div>

                <!-- Recent Activity -->
                <div class="space-y-1">
                    <p class="px-3 text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2">Recent</p>
                    <div id="sidebarActivity" class="space-y-1">
                        <!-- Skeleton loading for sidebar activity -->
                        <div class="skeleton-activity">
                            <div class="px-3 py-2">
                                <div class="skeleton skeleton-text mb-2"></div>
                                <div class="skeleton skeleton-text w-3/4"></div>
                            </div>
                            <div class="px-3 py-2">
                                <div class="skeleton skeleton-text mb-2"></div>
                                <div class="skeleton skeleton-text w-2/3"></div>
                            </div>
                            <div class="px-3 py-2">
                                <div class="skeleton skeleton-text mb-2"></div>
                                <div class="skeleton skeleton-text w-4/5"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </nav>

            <!-- User Profile Section -->
            <div class="p-3 border-t border-slate-200/60 mt-auto">
                <div class="flex items-center space-x-3 p-2 rounded-lg hover:bg-slate-100 transition-colors cursor-pointer notion-hover">
                    <div class="w-8 h-8 bg-gradient-to-br from-notion-500 to-notion-600 rounded-full flex items-center justify-center">
                        <span id="userInitial" class="text-white text-sm font-medium">{{ current_user.username[0].upper() if current_user and current_user.username else 'U' }}</span>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p id="userName" class="text-sm font-medium text-slate-900 truncate">{{ current_user.username if current_user and current_user.username else 'User' }}</p>
                        <p class="text-xs text-slate-500">Online</p>
                    </div>
                    <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l4-4 4 4m0 6l-4 4-4-4"></path>
                    </svg>
                </div>
            </div>
        </aside>

        <!-- Mobile Sidebar Overlay -->
        <div id="sidebarOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 lg:hidden hidden" onclick="toggleSidebar()"></div>
        
        <!-- Main Content Area -->
        <main class="flex-1 flex flex-col overflow-hidden lg:ml-0">
            <!-- Top Navigation Bar -->
            <header class="bg-slate-100/90 backdrop-blur-sm border-b border-slate-300/30 px-6 py-4 flex items-center justify-between shadow-soft sticky top-0 z-40">
                <div class="flex items-center space-x-4">
                    <button onclick="toggleSidebar()" class="lg:hidden p-2 rounded-lg hover:bg-slate-200 transition-colors">
                        <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </button>
                    
                    <!-- Global Search - Spotify inspired -->
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="h-5 w-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                        <input type="text" 
                               id="globalSearch"
                               placeholder="Search everything... (‚åòK)"
                               class="modern-input w-full sm:w-80 md:w-96 lg:w-[28rem] max-w-[70vw] pl-10 pr-4 py-2.5 rounded-xl text-sm focus:outline-none focus-ring"
                               onkeypress="handleGlobalSearch(event)"
                               autocomplete="off"
                               spellcheck="false"
                               role="searchbox"
                               aria-label="Global search input"
                               aria-describedby="searchHint">
                    </div>
                </div>

                <!-- Top Right Actions -->
                <div class="flex items-center space-x-3">
                    <!-- Quick Actions Button -->
                    <button onclick="showGlobalQuickActions()" 
                            class="p-2.5 bg-discord-500 hover:bg-discord-600 text-white rounded-xl shadow-medium hover:shadow-glow hover-scale transition-all duration-200 tooltip focus-ring" 
                            data-tooltip="Open quick actions (‚åò‚áßA)" aria-label="Open quick actions menu">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                    </button>

                    <!-- Theme Toggle -->
                    <button id="theme-toggle" class="px-3 py-2 rounded-xl border border-slate-300 text-slate-700 hover:bg-slate-100 text-xs font-medium" aria-label="Toggle theme">Dark</button>

                    <!-- Notifications -->
                    <button class="relative p-2.5 hover:bg-slate-200 rounded-xl transition-colors">
                        <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-5-5 5-5H15l-5 5 5 5z"></path>
                        </svg>
                        <span class="absolute top-1 right-1 w-2 h-2 bg-spotify-500 rounded-full"></span>
                    </button>

                    <!-- Connection Status -->
                    <div class="flex items-center space-x-2 px-3 py-1.5 bg-slate-200 rounded-xl">
                        <div id="connectionDot" class="w-2 h-2 status-online rounded-full"></div>
                        <span id="connectionText" class="text-xs font-medium text-slate-300">Online</span>
                    </div>
                </div>
            </header>

            <!-- Main Content Views -->
            <div class="flex-1 overflow-hidden">
                <!-- Dashboard View -->
                <div id="dashboard-view" class="view active h-full p-6 custom-scrollbar overflow-y-auto">
                    <div class="max-w-7xl mx-auto space-y-6">
                        
                        <!-- Welcome Section -->
                        <div class="glass rounded-2xl p-6 shadow-large">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h1 id="dynamicGreeting" class="text-2xl font-bold text-slate-900 mb-2">
                                        Good morning! üëã
                                    </h1>
                                    <p class="text-slate-600">
                                        Ready to capture your thoughts and organize your knowledge?
                                    </p>
                                </div>
                                <div class="flex items-center space-x-3">
                                    <div class="text-right">
                                        <div id="progressLabel" class="text-sm font-medium text-slate-600">Knowledge Progress</div>
                                        <div class="flex items-center space-x-2 mt-1">
                                            <div class="w-16 h-2 bg-slate-200 rounded-full overflow-hidden">
                                                <div id="progressBar" class="progress-bar h-full rounded-full transition-all duration-500" style="width: 0%"></div>
                                            </div>
                                            <span id="progressPercentage" class="text-xs text-slate-500">0%</span>
                                        </div>
                                    </div>
                                    <div class="w-12 h-12 bg-gradient-to-br from-spotify-400 to-spotify-500 rounded-2xl flex items-center justify-center">
                                        <span class="text-white text-xl">üéØ</span>
                                    </div>
                                    <button id="refreshBtn" onclick="refreshDashboardData()" 
                                            class="w-10 h-10 bg-slate-200 hover:bg-slate-300 rounded-xl flex items-center justify-center transition-all hover-scale tooltip focus-ring" 
                                            data-tooltip="Refresh dashboard data" aria-label="Refresh dashboard data">
                                        <span class="text-slate-600 text-lg">‚Üª</span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Stats Grid -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div onclick="filterNotesByType('all')" class="glass rounded-xl p-4 shadow-medium notion-hover cursor-pointer hover:shadow-lg transition-all">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm font-medium text-slate-600">Total Notes</span>
                                    <span class="text-2xl">üìù</span>
                                </div>
                                <div id="totalNotesCount" class="text-2xl font-bold text-slate-900">-</div>
                                <div class="text-xs text-notion-600 flex items-center mt-1">
                                    <span id="totalNotesToday">‚ÜóÔ∏è - today</span>
                                </div>
                            </div>

                            <div onclick="filterNotesByType('audio')" class="glass rounded-xl p-4 shadow-medium notion-hover cursor-pointer hover:shadow-lg transition-all">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm font-medium text-slate-600">Audio Notes</span>
                                    <span class="text-2xl">üéµ</span>
                                </div>
                                <div id="audioNotesCount" class="text-2xl font-bold text-slate-900">-</div>
                                <div class="text-xs text-discord-600 flex items-center mt-1">
                                    <span id="audioPending">üé§ - pending</span>
                                </div>
                            </div>

                            <div class="glass rounded-xl p-4 shadow-medium notion-hover">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm font-medium text-slate-600">Files Processed</span>
                                    <span class="text-2xl">üìÅ</span>
                                </div>
                                <div class="text-2xl font-bold text-slate-900">156</div>
                                <div class="text-xs text-spotify-600 flex items-center mt-1">
                                    <span>üöÄ AI enhanced</span>
                                </div>
                            </div>

                            <div class="glass rounded-xl p-4 shadow-medium notion-hover">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm font-medium text-slate-600">Search Queries</span>
                                    <span class="text-2xl">üîç</span>
                                </div>
                                <div class="text-2xl font-bold text-slate-900">89</div>
                                <div class="text-xs text-slate-500 flex items-center mt-1">
                                    <span>üìä This week</span>
                                </div>
                            </div>
                        </div>

                        <!-- Main Content Grid -->
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            
                            <!-- Quick Capture - Notion inspired -->
                            <div class="lg:col-span-2 space-y-6">
                                
                                <!-- Quick Note Card -->
                                <div class="glass rounded-2xl p-6 shadow-large">
                                    <div class="flex items-center justify-between mb-4">
                                        <h2 class="text-lg font-semibold text-slate-900">Quick Capture</h2>
                                        <div class="flex items-center space-x-2">
                                            <span class="bg-gradient-to-r from-discord-500 to-notion-500 bg-clip-text text-transparent text-xs font-bold">
                                                AI Enhanced
                                            </span>
                                            <div class="w-2 h-2 bg-notion-500 rounded-full animate-pulse"></div>
                                        </div>
                                    </div>

                                    <!-- Quick Capture Form -->
                                    <form id="quickCaptureForm" class="space-y-4">
                                        <label for="quickTitle" class="sr-only">Note title (optional)</label>
                                        <input type="text" 
                                               id="quickTitle"
                                               name="title"
                                               placeholder="Note title (optional)"
                                               class="modern-input w-full px-4 py-3 rounded-xl text-sm font-medium focus:outline-none focus-ring hover-lift transition-all"
                                               autocomplete="off"
                                               aria-label="Note title">
                                        
                                        <label for="note" class="sr-only">Note content</label>
                                        <textarea id="note"
                                                  name="note"
                                                  placeholder="Start typing your thoughts... Use @ to mention, # for tags, or just brain dump!"
                                                  rows="6"
                                                  class="modern-input w-full px-4 py-3 rounded-xl text-sm resize-none focus:outline-none focus-ring hover-lift transition-all"
                                                  aria-label="Note content"
                                                  data-autosave
                                                  data-drop-zone
                                                  aria-describedby="noteHint"></textarea>
                                        <div id="noteHint" class="sr-only">Use @ to mention, # for tags, or just write your thoughts</div>
                                        
                                        <label for="tags" class="sr-only">Tags (optional)</label>
                                        <input type="text" 
                                               id="tags"
                                               name="tags"
                                               placeholder="Tags (comma separated)"
                                               class="modern-input w-full px-4 py-2 rounded-xl text-sm focus:outline-none focus-ring hover-lift transition-all"
                                               autocomplete="off"
                                               aria-label="Tags">
                                        
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center space-x-2">
                                                <button class="px-3 py-1.5 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-lg text-xs font-medium transition-colors">
                                                    üè∑Ô∏è Auto-tag
                                                </button>
                                                <button class="px-3 py-1.5 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-lg text-xs font-medium transition-colors">
                                                    ‚ú® AI Summary
                                                </button>
                                                <button class="px-3 py-1.5 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-lg text-xs font-medium transition-colors">
                                                    üìé Add Files
                                                </button>
                                            </div>
                                            <button onclick="saveQuickNote()" 
                                                    class="px-6 py-2.5 bg-gradient-to-r from-discord-500 to-discord-600 hover:from-discord-600 hover:to-discord-700 text-white rounded-xl font-medium shadow-medium hover:shadow-glow transition-all duration-200">
                                                Save Note
                                            </button>
                                        </div>
                                    </form>
                                </div>

                                <!-- Enhanced Drag & Drop Upload Zone -->
                                <div id="uploadZone" 
                                     class="glass rounded-2xl p-8 border-2 border-dashed border-slate-250 hover:border-discord-300 transition-all duration-200 shadow-medium notion-hover cursor-pointer"
                                     data-drop-zone
                                     data-upload-zone
                                     ondragover="handleDragOver(event)" 
                                     ondragenter="handleDragEnter(event)"
                                     ondragleave="handleDragLeave(event)"
                                     ondrop="handleFileDrop(event)"
                                     onclick="document.getElementById('fileInput').click()">
                                    
                                    <div class="text-center">
                                        <div class="w-16 h-16 mx-auto mb-4 bg-gradient-to-br from-slate-100 to-slate-200 rounded-2xl flex items-center justify-center">
                                            <svg class="w-8 h-8 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                            </svg>
                                        </div>
                                        <h3 class="text-lg font-semibold text-slate-900 mb-2">Drop files here to upload</h3>
                                        <p class="text-slate-600 mb-4">
                                            PDF, Audio, Images, and Documents supported
                                        </p>
                                        <div class="flex flex-wrap justify-center gap-2">
                                            <span class="px-3 py-1 bg-slate-100 text-slate-600 rounded-full text-xs font-medium">üìÑ PDF</span>
                                            <span class="px-3 py-1 bg-slate-100 text-slate-600 rounded-full text-xs font-medium">üéµ Audio</span>
                                            <span class="px-3 py-1 bg-slate-100 text-slate-600 rounded-full text-xs font-medium">üñºÔ∏è Images</span>
                                            <span class="px-3 py-1 bg-slate-100 text-slate-600 rounded-full text-xs font-medium">üìù Text</span>
                                        </div>
                                    </div>
                                    
                                    <input type="file" 
                                           id="fileInput" 
                                           multiple 
                                           accept=".pdf,.mp3,.wav,.png,.jpg,.jpeg,.txt,.md,.doc,.docx"
                                           class="hidden"
                                           onchange="handleFileInput(event)">
                                </div>
                            </div>

                            <!-- Right Sidebar -->
                            <div class="space-y-6">
                                
                                <!-- AI Assistant -->
                                <div class="glass rounded-xl p-5 shadow-medium">
                                    <div class="flex items-center space-x-3 mb-4">
                                        <div class="w-8 h-8 bg-gradient-to-br from-discord-500 to-notion-500 rounded-lg flex items-center justify-center">
                                            <span class="text-white text-sm">ü§ñ</span>
                                        </div>
                                        <div>
                                            <h3 class="font-semibold text-slate-900">AI Assistant</h3>
                                            <p class="text-xs text-slate-500">Ready to help</p>
                                        </div>
                                    </div>
                                    
                                    <div class="space-y-2">
                                        <button class="w-full p-3 text-left bg-slate-50 hover:bg-slate-100 rounded-lg transition-colors text-sm">
                                            üí° Suggest connections to existing notes
                                        </button>
                                        <button class="w-full p-3 text-left bg-slate-50 hover:bg-slate-100 rounded-lg transition-colors text-sm">
                                            üìù Generate summary of today's notes
                                        </button>
                                        <button class="w-full p-3 text-left bg-slate-50 hover:bg-slate-100 rounded-lg transition-colors text-sm">
                                            üè∑Ô∏è Auto-organize with smart tags
                                        </button>
                                    </div>
                                </div>

                                <!-- Enhanced Notes Section -->
                                <div class="glass rounded-xl p-5 shadow-medium" id="enhanced-notes-section">
                                    <div class="flex items-center justify-between mb-4">
                                        <div class="flex items-center space-x-3">
                                            <h3 class="font-semibold text-slate-900">My Notes</h3>
                                            <span id="notes-count" class="text-xs bg-slate-200 px-2 py-1 rounded-full text-slate-600">0</span>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <!-- View Mode Toggle -->
                                            <div class="flex rounded-lg border border-slate-300 overflow-hidden">
                                                <button data-view-mode="card" class="px-2 py-1 text-xs bg-discord-100 text-discord-700" title="Card view">
                                                    <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path>
                                                    </svg>
                                                </button>
                                                <button data-view-mode="list" class="px-2 py-1 text-xs hover:bg-slate-100 text-slate-600" title="List view">
                                                    <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
                                                    </svg>
                                                </button>
                                            </div>
                                            
                                            <!-- Create Note Dropdown -->
                                            <div class="relative">
                                                <button data-action="create-note" class="flex items-center px-3 py-1 bg-discord-600 text-white rounded-lg hover:bg-discord-700 text-xs font-medium">
                                                    <svg class="h-3 w-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                                    </svg>
                                                    Create
                                                </button>
                                            </div>
                                            
                                            <button class="text-xs text-discord-600 hover:text-discord-700 font-medium" onclick="contentManager?.showGlobalSearch()">
                                                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                                </svg>
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Enhanced Search and Filter Bar -->
                                    <div class="mb-4 space-y-2">
                                        <div class="relative">
                                            <input type="text" id="notes-search" placeholder="Search notes... (‚åòK for global search)"
                                                   class="w-full px-3 py-2 pl-8 text-sm border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-discord-500 focus:border-transparent">
                                            <svg class="absolute left-2.5 top-2.5 h-3 w-3 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                            </svg>
                                        </div>
                                        
                                        <!-- Quick Filters -->
                                        <div class="flex items-center space-x-2 text-xs">
                                            <span class="text-slate-500">Filter:</span>
                                            <button data-filter="all" class="px-2 py-1 bg-slate-200 text-slate-700 rounded hover:bg-slate-300 transition-colors">All</button>
                                            <button data-filter="recent" class="px-2 py-1 text-slate-600 hover:bg-slate-200 rounded transition-colors">Recent</button>
                                            <button data-filter="favorites" class="px-2 py-1 text-slate-600 hover:bg-slate-200 rounded transition-colors">Favorites</button>
                                            <button data-filter="tags" class="px-2 py-1 text-slate-600 hover:bg-slate-200 rounded transition-colors">By Tags</button>
                                        </div>
                                    </div>

                                    <!-- Bulk Selection Bar (Hidden by default) -->
                                    <div id="bulk-selection-bar" class="mb-4 p-3 bg-discord-50 rounded-lg border border-discord-200 hidden">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center space-x-2">
                                                <input type="checkbox" id="select-all-notes" class="rounded">
                                                <label for="select-all-notes" class="text-sm font-medium text-slate-700">Select All</label>
                                                <span id="selection-count" class="text-xs text-slate-500">(0 selected)</span>
                                            </div>
                                            <div class="flex items-center space-x-2">
                                                <button onclick="contentManager?.bulkTag()" class="px-3 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700">Tag</button>
                                                <button onclick="contentManager?.bulkArchive()" class="px-3 py-1 bg-yellow-600 text-white rounded text-xs hover:bg-yellow-700">Archive</button>
                                                <button onclick="contentManager?.bulkDelete()" class="px-3 py-1 bg-red-600 text-white rounded text-xs hover:bg-red-700">Delete</button>
                                                <button onclick="contentManager?.clearSelection()" class="px-3 py-1 bg-slate-400 text-white rounded text-xs hover:bg-slate-500">Cancel</button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div id="recentNotes" class="space-y-3 notes-container main-content" data-view-mode="card" data-mobile-swipe="enabled">
                                        <!-- Skeleton loading for notes -->
                                        <div class="skeleton-notes">
                                            <div class="note-card p-3 bg-slate-50 rounded-lg">
                                                <div class="skeleton skeleton-title mb-2"></div>
                                                <div class="skeleton skeleton-text mb-1"></div>
                                                <div class="skeleton skeleton-text w-3/4"></div>
                                            </div>
                                            <div class="p-3 bg-slate-50 rounded-lg">
                                                <div class="skeleton skeleton-title mb-2"></div>
                                                <div class="skeleton skeleton-text mb-1"></div>
                                                <div class="skeleton skeleton-text w-2/3"></div>
                                            </div>
                                            <div class="p-3 bg-slate-50 rounded-lg">
                                                <div class="skeleton skeleton-title mb-2"></div>
                                                <div class="skeleton skeleton-text mb-1"></div>
                                                <div class="skeleton skeleton-text w-4/5"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Enhanced Quick Stats -->
                                <div class="glass rounded-xl p-5 shadow-medium" data-interactive data-chart="activity">
                                    <h3 class="font-semibold text-slate-900 mb-4">Today's Activity</h3>
                                    
                                    <div id="todaysActivity" class="space-y-4">
                                        <div class="flex items-center justify-between chart-bar cursor-pointer hover:bg-slate-50 -mx-2 px-2 py-1 rounded" data-label="Notes Created" data-value="0">
                                            <span class="text-sm text-slate-600">Notes Created</span>
                                            <span id="notesCreated" class="font-semibold text-slate-900">-</span>
                                        </div>
                                        <div class="flex items-center justify-between chart-bar cursor-pointer hover:bg-slate-50 -mx-2 px-2 py-1 rounded" data-label="Files Processed" data-value="0">
                                            <span class="text-sm text-slate-600">Files Processed</span>
                                            <span id="filesProcessed" class="font-semibold text-slate-900">-</span>
                                        </div>
                                        <div class="flex items-center justify-between chart-bar cursor-pointer hover:bg-slate-50 -mx-2 px-2 py-1 rounded" data-label="Search Queries" data-value="0">
                                            <span class="text-sm text-slate-600">Search Queries</span>
                                            <span id="searchQueries" class="font-semibold text-slate-900">-</span>
                                        </div>
                                        <div class="pt-2 border-t border-slate-200">
                                            <div class="flex items-center justify-between">
                                                <span class="text-sm font-medium text-slate-700">Productivity Score</span>
                                                <span id="productivityScore" class="text-lg font-bold text-notion-600">-</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Notes View (Hidden by default) -->
                <div id="notes-view" class="view hidden h-full">
                    <!-- Notes Header -->
                    <div class="border-b border-slate-700 bg-slate-900 px-6 py-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <h1 class="text-2xl font-bold text-slate-300">My Notes</h1>
                                <p class="text-sm text-slate-400 mt-1">Manage and organize your knowledge base</p>
                            </div>
                            <div class="flex items-center space-x-3">
                                <button onclick="openNewNote()" class="btn btn-primary">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                    </svg>
                                    New Note
                                </button>
                                <button onclick="refreshNotesView()" class="btn btn-secondary">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Filter Tabs -->
                        <div class="mt-4 border-b border-slate-700">
                            <nav class="flex space-x-8">
                                <button onclick="filterNotes('all')" id="filter-all" class="note-filter-tab active py-2 px-1 border-b-2 border-slate-500 font-medium text-sm text-slate-300">
                                    All Notes
                                    <span id="count-all" class="ml-2 bg-slate-700 text-slate-400 px-2 py-0.5 rounded-full text-xs">-</span>
                                </button>
                                <button onclick="filterNotes('text')" id="filter-text" class="note-filter-tab py-2 px-1 border-b-2 border-transparent font-medium text-sm text-slate-400 hover:text-slate-200 hover:border-slate-500">
                                    Text Notes
                                    <span id="count-text" class="ml-2 bg-slate-800 text-slate-300 px-2 py-0.5 rounded-full text-xs">-</span>
                                </button>
                                <button onclick="filterNotes('audio')" id="filter-audio" class="note-filter-tab py-2 px-1 border-b-2 border-transparent font-medium text-sm text-slate-400 hover:text-slate-200 hover:border-slate-500">
                                    Audio Notes
                                    <span id="count-audio" class="ml-2 bg-slate-800 text-slate-300 px-2 py-0.5 rounded-full text-xs">-</span>
                                </button>
                                <button onclick="filterNotes('file')" id="filter-file" class="note-filter-tab py-2 px-1 border-b-2 border-transparent font-medium text-sm text-slate-400 hover:text-slate-200 hover:border-slate-500">
                                    Files
                                    <span id="count-file" class="ml-2 bg-slate-800 text-slate-300 px-2 py-0.5 rounded-full text-xs">-</span>
                                </button>
                                <button onclick="filterNotes('image')" id="filter-image" class="note-filter-tab py-2 px-1 border-b-2 border-transparent font-medium text-sm text-slate-400 hover:text-slate-200 hover:border-slate-500">
                                    Images
                                    <span id="count-image" class="ml-2 bg-slate-800 text-slate-300 px-2 py-0.5 rounded-full text-xs">-</span>
                                </button>
                                <button onclick="filterNotes('web')" id="filter-web" class="note-filter-tab py-2 px-1 border-b-2 border-transparent font-medium text-sm text-slate-400 hover:text-slate-200 hover:border-slate-500">
                                    Web Clips
                                    <span id="count-web" class="ml-2 bg-slate-800 text-slate-300 px-2 py-0.5 rounded-full text-xs">-</span>
                                </button>
                            </nav>
                        </div>
                    </div>
                    
                    <!-- Notes Content -->
                    <div class="flex-1 overflow-hidden">
                        <!-- Search and Sort Bar -->
                        <div class="border-b border-slate-700 bg-slate-800 px-6 py-3">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-4 flex-1">
                                    <div class="relative flex-1 max-w-md">
                                        <input type="text" id="notesSearchInput" placeholder="Search notes..." 
                                               oninput="searchNotes(this.value)"
                                               class="w-full pl-10 pr-4 py-2 border border-slate-600 rounded-lg text-sm bg-slate-700 text-slate-300 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-slate-500 focus:border-transparent">
                                        <svg class="absolute left-3 top-2.5 h-4 w-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                        </svg>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <label class="text-sm text-slate-300">Sort by:</label>
                                        <select id="sortNotesSelect" onchange="sortNotes(this.value)" class="border border-slate-600 rounded px-2 py-1 text-sm bg-slate-700 text-slate-300">
                                            <option value="newest">Newest first</option>
                                            <option value="oldest">Oldest first</option>
                                            <option value="title">Title A-Z</option>
                                            <option value="type">Type</option>
                                            <option value="size">Size</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <button onclick="toggleNotesView('grid')" id="view-grid" class="p-2 rounded hover:bg-slate-700 text-slate-300">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path>
                                        </svg>
                                    </button>
                                    <button onclick="toggleNotesView('list')" id="view-list" class="p-2 rounded bg-slate-700 text-slate-300">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Notes List -->
                        <div class="flex-1 overflow-y-auto p-6 bg-slate-900">
                            <div id="notesContainer" class="space-y-4">
                                <!-- Notes will be loaded here -->
                                <div class="text-center py-12">
                                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-500 mx-auto mb-4"></div>
                                    <p class="text-slate-400">Loading notes...</p>
                                </div>
                            </div>
                            
                            <!-- Empty State -->
                            <div id="notesEmpty" class="hidden text-center py-12">
                                <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <svg class="w-8 h-8 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                </div>
                                <h3 class="text-lg font-medium text-slate-900 mb-2">No notes found</h3>
                                <p class="text-slate-500 mb-4">Start by creating your first note to build your knowledge base.</p>
                                <button onclick="showGlobalQuickActions()" class="btn btn-primary">
                                    Create Note
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Advanced Search View -->
                <div id="search-view" class="view hidden h-full overflow-y-auto custom-scrollbar">
                    <div class="max-w-4xl mx-auto p-6">
                        <!-- Search Header -->
                        <div class="mb-8">
                            <div class="flex items-center space-x-3 mb-2">
                                <div class="w-8 h-8 bg-slate-700 rounded-lg flex items-center justify-center">
                                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                    </svg>
                                </div>
                                <h1 class="text-2xl font-bold text-slate-100">Advanced Search</h1>
                                <div class="px-2 py-1 bg-blue-500/20 text-blue-300 text-xs font-bold rounded-full">
                                    Enhanced
                                </div>
                            </div>
                            <p class="text-slate-400">Search through your notes, files, and AI-generated content with advanced filters</p>
                        </div>

                        <!-- Main Search Interface -->
                        <div class="glass rounded-xl p-6 mb-6">
                            <!-- Enhanced Search Input -->
                            <div class="relative mb-4">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <svg class="h-5 w-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                    </svg>
                                </div>
                                <input type="text" 
                                       id="advancedSearchInput"
                                       placeholder="Search your knowledge base... Try: 'notes from today' or 'audio recordings'"
                                       class="modern-input w-full pl-10 pr-4 py-3 rounded-xl text-sm focus:outline-none focus-ring"
                                       autocomplete="off"
                                       spellcheck="false"
                                       role="searchbox"
                                       aria-label="Advanced search input"
                                       onkeypress="handleAdvancedSearch(event)"
                                       oninput="handleSearchInput(this.value)">
                                
                                <!-- Search Suggestions Dropdown -->
                                <div id="searchSuggestions" class="absolute top-full left-0 right-0 bg-slate-200 rounded-xl mt-1 shadow-lg max-h-48 overflow-y-auto z-50 hidden">
                                    <!-- Suggestions populated by JavaScript -->
                                </div>
                            </div>

                            <!-- Search Filters -->
                            <div class="flex flex-wrap gap-2 mb-4">
                                <button onclick="toggleSearchFilter('notes')" 
                                        id="filterNotes"
                                        class="search-filter active px-3 py-2 text-xs font-medium rounded-xl border transition-all duration-200 bg-blue-100 border-blue-300 text-blue-800">
                                    üìù Notes
                                </button>
                                <button onclick="toggleSearchFilter('audio')" 
                                        id="filterAudio"
                                        class="search-filter px-3 py-2 text-xs font-medium rounded-xl border border-slate-300 text-slate-300 hover:bg-slate-200 hover:text-slate-700">
                                    üéµ Audio
                                </button>
                                <button onclick="toggleSearchFilter('files')" 
                                        id="filterFiles"
                                        class="search-filter px-3 py-2 text-xs font-medium rounded-xl border border-slate-300 text-slate-300 hover:bg-slate-200 hover:text-slate-700">
                                    üìÅ Files
                                </button>
                                <button onclick="toggleSearchFilter('ai')" 
                                        id="filterAi"
                                        class="search-filter px-3 py-2 text-xs font-medium rounded-xl border border-slate-300 text-slate-300 hover:bg-slate-200 hover:text-slate-700">
                                    ü§ñ AI Generated
                                </button>
                                <button onclick="toggleSearchFilter('recent')" 
                                        id="filterRecent"
                                        class="search-filter px-3 py-2 text-xs font-medium rounded-xl border border-slate-300 text-slate-300 hover:bg-slate-200 hover:text-slate-700">
                                    ‚è∞ Recent
                                </button>
                            </div>

                            <!-- Search Actions -->
                            <div class="flex space-x-3 items-center">
                                <button onclick="performAdvancedSearch()" 
                                        class="px-4 py-2.5 bg-slate-700 hover:bg-slate-600 text-white rounded-xl font-medium shadow-medium transition-colors">
                                    <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                    </svg>
                                    Search
                                </button>
                                <button onclick="clearSearch()" 
                                        class="px-4 py-3 border border-slate-300 text-slate-300 hover:bg-slate-200 hover:text-slate-700 rounded-xl transition-colors">
                                    Clear
                                </button>
                            </div>

                            <!-- Quick Search Suggestions -->
                            <div class="mt-4">
                                <div class="text-xs text-slate-400 mb-2">Quick searches:</div>
                                <div class="flex flex-wrap gap-2">
                                    <button onclick="quickSearch('today')" class="text-xs bg-slate-200 hover:bg-slate-300 text-slate-600 px-2 py-1 rounded-lg transition-colors">Today</button>
                                    <button onclick="quickSearch('this week')" class="text-xs bg-slate-200 hover:bg-slate-300 text-slate-600 px-2 py-1 rounded-lg transition-colors">This Week</button>
                                    <button onclick="quickSearch('important')" class="text-xs bg-slate-200 hover:bg-slate-300 text-slate-600 px-2 py-1 rounded-lg transition-colors">Important</button>
                                    <button onclick="quickSearch('untagged')" class="text-xs bg-slate-200 hover:bg-slate-300 text-slate-600 px-2 py-1 rounded-lg transition-colors">Untagged</button>
                                    <button onclick="quickSearch('audio transcriptions')" class="text-xs bg-slate-200 hover:bg-slate-300 text-slate-600 px-2 py-1 rounded-lg transition-colors">Audio</button>
                                </div>
                            </div>
                        </div>

                        <!-- Search Results -->
                        <div id="searchResultsContainer" class="hidden">
                            <div class="glass rounded-xl p-6">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-lg font-semibold text-slate-100">Search Results</h3>
                                    <div id="searchResultsCount" class="text-sm text-slate-400"></div>
                                </div>
                                
                                <!-- Results List -->
                                <div id="searchResultsList" class="space-y-4 max-h-96 overflow-y-auto custom-scrollbar">
                                    <!-- Results will be populated here -->
                                </div>
                                
                                <!-- No Results -->
                                <div id="noResults" class="hidden text-center py-8 text-slate-400">
                                    <svg class="w-12 h-12 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                    </svg>
                                    <p>No results found for your search.</p>
                                    <p class="text-sm mt-1">Try adjusting your filters or search terms.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Search Tips -->
                        <div class="mt-6 glass rounded-xl p-6">
                            <h4 class="text-sm font-medium text-slate-200 mb-3">Search Tips</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-xs text-slate-400">
                                <div class="flex items-start space-x-2">
                                    <span class="text-blue-400">‚Ä¢</span>
                                    <span>Use quotes for exact phrases: <code class="bg-slate-300 text-slate-700 px-1 rounded">"exact phrase"</code></span>
                                </div>
                                <div class="flex items-start space-x-2">
                                    <span class="text-blue-400">‚Ä¢</span>
                                    <span>Search by tag: <code class="bg-slate-300 text-slate-700 px-1 rounded">tag:important</code></span>
                                </div>
                                <div class="flex items-start space-x-2">
                                    <span class="text-blue-400">‚Ä¢</span>
                                    <span>Date ranges: <code class="bg-slate-300 text-slate-700 px-1 rounded">created:today</code></span>
                                </div>
                                <div class="flex items-start space-x-2">
                                    <span class="text-blue-400">‚Ä¢</span>
                                    <span>Content type: <code class="bg-slate-300 text-slate-700 px-1 rounded">type:audio</code></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Analytics View (Hidden by default) -->
                <div id="analytics-view" class="view hidden h-full overflow-y-auto custom-scrollbar">
                    <div class="p-6 max-w-6xl mx-auto">
                        <!-- Header -->
                        <div class="flex items-center justify-between mb-8">
                            <div class="flex items-center space-x-4">
                                <div class="w-12 h-12 bg-purple-500 rounded-xl flex items-center justify-center">
                                    <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                                    </svg>
                                </div>
                                <div>
                                    <h1 class="text-3xl font-bold text-white">Analytics Dashboard</h1>
                                    <p class="text-slate-400">Insights and statistics about your knowledge base</p>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="exportAnalytics()" class="px-4 py-2 bg-blue-500 bg-opacity-20 text-blue-400 rounded-lg hover:bg-opacity-30 transition-all">
                                    <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                    </svg>
                                    Export
                                </button>
                                <button onclick="refreshAnalytics()" class="px-4 py-2 bg-purple-500 bg-opacity-20 text-purple-400 rounded-lg hover:bg-opacity-30 transition-all">
                                    <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                    </svg>
                                    Refresh
                                </button>
                            </div>
                        </div>

                        <!-- Overview Stats -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                            <div class="glass-dark rounded-xl p-6">
                                <div class="flex items-center justify-between mb-3">
                                    <h3 class="text-sm font-medium text-slate-400">Total Notes</h3>
                                    <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                    </svg>
                                </div>
                                <div id="totalNotes" class="text-3xl font-bold text-white mb-1">-</div>
                                <div class="text-xs text-slate-400">All time</div>
                            </div>
                            
                            <div class="glass-dark rounded-xl p-6">
                                <div class="flex items-center justify-between mb-3">
                                    <h3 class="text-sm font-medium text-slate-400">This Week</h3>
                                    <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                                    </svg>
                                </div>
                                <div id="thisWeekNotes" class="text-3xl font-bold text-white mb-1">-</div>
                                <div class="text-xs text-slate-400" id="weeklyGrowth">Last 7 days</div>
                            </div>
                            
                            <div class="glass-dark rounded-xl p-6">
                                <div class="flex items-center justify-between mb-3">
                                    <h3 class="text-sm font-medium text-slate-400">Content Types</h3>
                                    <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                                    </svg>
                                </div>
                                <div id="contentTypes" class="text-3xl font-bold text-white mb-1">-</div>
                                <div class="text-xs text-slate-400">Different formats</div>
                            </div>
                            
                            <div class="glass-dark rounded-xl p-6">
                                <div class="flex items-center justify-between mb-3">
                                    <h3 class="text-sm font-medium text-slate-400">Popular Tags</h3>
                                    <svg class="w-5 h-5 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
                                    </svg>
                                </div>
                                <div id="popularTagsCount" class="text-3xl font-bold text-white mb-1">-</div>
                                <div class="text-xs text-slate-400">Most used</div>
                            </div>
                        </div>

                        <!-- Performance Metrics Panel -->
                        <div class="glass-dark rounded-xl p-6 mb-8">
                            <div class="flex items-center justify-between mb-6">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 bg-blue-500 bg-opacity-20 rounded-lg flex items-center justify-center">
                                        <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                        </svg>
                                    </div>
                                    <div>
                                        <h3 class="text-lg font-semibold text-white">Performance Metrics</h3>
                                        <p class="text-sm text-slate-400">Dashboard optimization and performance insights</p>
                                    </div>
                                </div>
                                <div class="flex space-x-2">
                                    <button onclick="clearPerformanceCaches()" class="px-3 py-1.5 bg-red-500 bg-opacity-20 text-red-400 rounded-lg hover:bg-opacity-30 transition-all text-sm">
                                        Clear Caches
                                    </button>
                                    <button onclick="togglePerformanceFeatures()" class="px-3 py-1.5 bg-green-500 bg-opacity-20 text-green-400 rounded-lg hover:bg-opacity-30 transition-all text-sm">
                                        Settings
                                    </button>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-blue-400" id="perfFCP">-</div>
                                    <div class="text-xs text-slate-400 mt-1">FCP (ms)</div>
                                    <div class="performance-badge mt-1" id="perfFCPBadge">-</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-green-400" id="perfLCP">-</div>
                                    <div class="text-xs text-slate-400 mt-1">LCP (ms)</div>
                                    <div class="performance-badge mt-1" id="perfLCPBadge">-</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-yellow-400" id="perfCLS">-</div>
                                    <div class="text-xs text-slate-400 mt-1">CLS</div>
                                    <div class="performance-badge mt-1" id="perfCLSBadge">-</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-purple-400" id="perfFID">-</div>
                                    <div class="text-xs text-slate-400 mt-1">FID (ms)</div>
                                    <div class="performance-badge mt-1" id="perfFIDBadge">-</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-orange-400" id="perfMemory">-</div>
                                    <div class="text-xs text-slate-400 mt-1">Memory (MB)</div>
                                    <div class="performance-badge mt-1" id="perfMemoryBadge">-</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-cyan-400" id="perfCacheHit">-</div>
                                    <div class="text-xs text-slate-400 mt-1">Cache Hit %</div>
                                    <div class="performance-badge mt-1" id="perfCacheHitBadge">-</div>
                                </div>
                            </div>
                            
                            <div class="mt-6 pt-4 border-t border-slate-700">
                                <div class="flex items-center justify-between text-sm">
                                    <span class="text-slate-400">Smart Features:</span>
                                    <div class="flex space-x-4">
                                        <label class="flex items-center space-x-2 cursor-pointer">
                                            <input type="checkbox" id="smartFeaturesToggle" class="rounded" checked>
                                            <span class="text-slate-300">Auto-save</span>
                                        </label>
                                        <label class="flex items-center space-x-2 cursor-pointer">
                                            <input type="checkbox" id="suggestionsToggle" class="rounded" checked>
                                            <span class="text-slate-300">Suggestions</span>
                                        </label>
                                        <label class="flex items-center space-x-2 cursor-pointer">
                                            <input type="checkbox" id="keyboardShortcutsToggle" class="rounded" checked>
                                            <span class="text-slate-300">Shortcuts</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Enhanced Analytics Charts -->
                        <div class="grid grid-cols-1 xl:grid-cols-2 gap-6 mb-8">
                            <!-- Daily Activity Chart -->
                            <div class="glass-dark rounded-xl p-6">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-lg font-semibold text-white">Activity Timeline</h3>
                                    <div class="flex space-x-2">
                                        <button onclick="switchActivityView('daily')" id="dailyBtn" class="px-3 py-1 bg-purple-500 bg-opacity-30 text-purple-300 rounded-lg text-sm">Daily</button>
                                        <button onclick="switchActivityView('weekly')" id="weeklyBtn" class="px-3 py-1 bg-slate-600 text-slate-400 rounded-lg text-sm">Weekly</button>
                                    </div>
                                </div>
                                <div style="height: 250px;">
                                    <canvas id="activityChart"></canvas>
                                </div>
                            </div>

                            <!-- Content Types Pie Chart -->
                            <div class="glass-dark rounded-xl p-6">
                                <h3 class="text-lg font-semibold text-white mb-4">Content Distribution</h3>
                                <div style="height: 250px;">
                                    <canvas id="contentTypesChart"></canvas>
                                </div>
                            </div>
                        </div>

                        <!-- Productivity Insights -->
                        <div class="glass-dark rounded-xl p-6 mb-8">
                            <h3 class="text-lg font-semibold text-white mb-6">Productivity Insights</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <!-- Hourly Pattern Chart -->
                                <div class="col-span-2">
                                    <h4 class="text-md font-medium text-slate-300 mb-3">Daily Activity Pattern</h4>
                                    <div style="height: 200px;">
                                        <canvas id="hourlyPatternChart"></canvas>
                                    </div>
                                </div>
                                
                                <!-- Productivity Stats -->
                                <div class="space-y-4">
                                    <div class="bg-slate-700 bg-opacity-30 rounded-lg p-4">
                                        <div class="text-2xl font-bold text-blue-400" id="avgNotesPerDay">-</div>
                                        <div class="text-xs text-slate-400">Avg. notes/day</div>
                                    </div>
                                    <div class="bg-slate-700 bg-opacity-30 rounded-lg p-4">
                                        <div class="text-2xl font-bold text-green-400" id="daysActive">-</div>
                                        <div class="text-xs text-slate-400">Days active</div>
                                    </div>
                                    <div class="bg-slate-700 bg-opacity-30 rounded-lg p-4">
                                        <div class="text-2xl font-bold text-purple-400" id="thisMonth">-</div>
                                        <div class="text-xs text-slate-400">This month</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Content Breakdown -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                            <!-- Content Types List -->
                            <div class="glass-dark rounded-xl p-6">
                                <h3 class="text-lg font-semibold text-white mb-4">Content by Type</h3>
                                <div id="contentTypesList" class="space-y-3">
                                    <div class="text-center text-slate-400 py-8">Loading...</div>
                                </div>
                            </div>

                            <!-- Popular Tags -->
                            <div class="glass-dark rounded-xl p-6">
                                <h3 class="text-lg font-semibold text-white mb-4">Popular Tags</h3>
                                <div id="popularTagsList" class="space-y-3">
                                    <div class="text-center text-slate-400 py-8">Loading...</div>
                                </div>
                            </div>
                        </div>

                        <!-- Activity Timeline -->
                        <div class="glass-dark rounded-xl p-6 mb-8">
                            <h3 class="text-lg font-semibold text-white mb-4">Recent Activity</h3>
                            <div id="activityTimeline" class="space-y-4 max-h-80 overflow-y-auto custom-scrollbar">
                                <div class="text-center text-slate-400 py-8">Loading activity timeline...</div>
                            </div>
                        </div>

                        <!-- System Health -->
                        <div class="glass-dark rounded-xl p-6">
                            <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
                                <svg class="w-5 h-5 mr-2 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                System Health
                            </h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div class="text-center">
                                    <div class="w-12 h-12 bg-green-500 bg-opacity-20 rounded-lg flex items-center justify-center mx-auto mb-2">
                                        <svg class="w-6 h-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                        </svg>
                                    </div>
                                    <div class="text-sm font-medium text-white">Database</div>
                                    <div class="text-xs text-green-400">Healthy</div>
                                </div>
                                
                                <div class="text-center">
                                    <div class="w-12 h-12 bg-green-500 bg-opacity-20 rounded-lg flex items-center justify-center mx-auto mb-2">
                                        <svg class="w-6 h-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                                        </svg>
                                    </div>
                                    <div class="text-sm font-medium text-white">Search</div>
                                    <div class="text-xs text-green-400">Operational</div>
                                </div>
                                
                                <div class="text-center">
                                    <div class="w-12 h-12 bg-green-500 bg-opacity-20 rounded-lg flex items-center justify-center mx-auto mb-2">
                                        <svg class="w-6 h-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 016 0v6a3 3 0 01-3 3z"/>
                                        </svg>
                                    </div>
                                    <div class="text-sm font-medium text-white">AI Processing</div>
                                    <div class="text-xs text-green-400">Active</div>
                                </div>
                                
                                <div class="text-center">
                                    <div id="discordHealthIcon" class="w-12 h-12 bg-gray-500 bg-opacity-20 rounded-lg flex items-center justify-center mx-auto mb-2">
                                        <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028c.462-.63.874-1.295 1.226-1.994.021-.041.001-.09-.041-.106a13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.010c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/>
                                        </svg>
                                    </div>
                                    <div class="text-sm font-medium text-white">Discord Bot</div>
                                    <div id="discordHealthStatus" class="text-xs text-gray-400">Unknown</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Settings View (Hidden by default) -->
                <div id="settings-view" class="view hidden h-full p-6">
                    <div class="max-w-2xl mx-auto">
                        <h2 class="text-2xl font-bold text-slate-900 mb-6">Settings</h2>
                        
                        <!-- Dashboard Preferences -->
                        <div class="bg-white rounded-xl shadow-medium p-6 mb-6">
                            <h3 class="text-lg font-semibold text-slate-900 mb-4">Dashboard Preferences</h3>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between p-4 bg-slate-50 rounded-lg">
                                    <div>
                                        <h4 class="font-medium text-slate-900">Current Dashboard</h4>
                                        <p class="text-sm text-slate-600">You're using the new v3 dashboard</p>
                                    </div>
                                    <a href="/dashboard/legacy" class="px-4 py-2 bg-slate-200 hover:bg-slate-300 text-slate-700 rounded-lg transition-colors text-sm font-medium">
                                        Switch to Legacy Dashboard
                                    </a>
                                </div>
                            </div>
                        </div>
                        
                        <!-- More settings coming soon -->
                        <div class="text-center text-slate-500 mt-12">
                            <p>More configuration options coming soon...</p>
                        </div>
                    </div>
                </div>

                <!-- Discord Bot View (Hidden by default) -->
                <div id="discord-view" class="view hidden h-full overflow-y-auto custom-scrollbar">
                    <div class="p-6 max-w-6xl mx-auto">
                        <!-- Header -->
                        <div class="flex items-center justify-between mb-8">
                            <div class="flex items-center space-x-4">
                                <div class="w-12 h-12 bg-indigo-500 rounded-xl flex items-center justify-center">
                                    <svg class="w-7 h-7 text-white" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028c.462-.63.874-1.295 1.226-1.994.021-.041.001-.09-.041-.106a13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.010c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/>
                                    </svg>
                                </div>
                                <div>
                                    <h1 class="text-3xl font-bold text-white">Discord Bot</h1>
                                    <p class="text-slate-400">Monitor and manage your Discord bot integration</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-3">
                                <div id="discordBotStatusIndicator" class="flex items-center space-x-2 px-4 py-2 rounded-lg glass-dark">
                                    <div id="discordBotStatusDot" class="w-3 h-3 bg-gray-400 rounded-full"></div>
                                    <span id="discordBotStatusText" class="text-sm font-medium text-white">Checking...</span>
                                </div>
                            </div>
                        </div>

                        <!-- Bot Status Overview -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                            <div class="glass-dark rounded-xl p-6">
                                <div class="flex items-center justify-between mb-3">
                                    <h3 class="text-sm font-medium text-slate-400">Connection Status</h3>
                                    <svg id="connectionStatusIcon" class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                                    </svg>
                                </div>
                                <div id="connectionStatus" class="text-2xl font-bold text-white mb-1">Offline</div>
                                <div id="connectionUptime" class="text-xs text-slate-400">No uptime data</div>
                            </div>
                            
                            <div class="glass-dark rounded-xl p-6">
                                <div class="flex items-center justify-between mb-3">
                                    <h3 class="text-sm font-medium text-slate-400">Commands Available</h3>
                                    <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                    </svg>
                                </div>
                                <div id="commandCount" class="text-2xl font-bold text-white mb-1">15</div>
                                <div class="text-xs text-slate-400">Slash commands</div>
                            </div>
                            
                            <div class="glass-dark rounded-xl p-6">
                                <div class="flex items-center justify-between mb-3">
                                    <h3 class="text-sm font-medium text-slate-400">Messages Today</h3>
                                    <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                                    </svg>
                                </div>
                                <div id="messageCount" class="text-2xl font-bold text-white mb-1">-</div>
                                <div class="text-xs text-slate-400">Bot interactions</div>
                            </div>
                            
                            <div class="glass-dark rounded-xl p-6">
                                <div class="flex items-center justify-between mb-3">
                                    <h3 class="text-sm font-medium text-slate-400">Active Users</h3>
                                    <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"/>
                                    </svg>
                                </div>
                                <div id="userCount" class="text-2xl font-bold text-white mb-1">-</div>
                                <div class="text-xs text-slate-400">Registered users</div>
                            </div>
                        </div>

                        <!-- Available Commands -->
                        <div class="mb-8">
                            <h2 class="text-xl font-bold text-white mb-4 flex items-center">
                                <svg class="w-6 h-6 mr-2 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                </svg>
                                Available Commands
                            </h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="commandsList">
                                <!-- Commands will be loaded dynamically -->
                                <div class="glass-dark rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-2">
                                        <code class="text-sm font-mono text-indigo-300">/save</code>
                                        <span class="text-xs px-2 py-1 bg-green-500 bg-opacity-20 text-green-400 rounded-full">Active</span>
                                    </div>
                                    <p class="text-sm text-slate-400 mb-2">Save text note to Second Brain</p>
                                    <div class="text-xs text-slate-500">Usage: /save [text]</div>
                                </div>
                                
                                <div class="glass-dark rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-2">
                                        <code class="text-sm font-mono text-indigo-300">/search</code>
                                        <span class="text-xs px-2 py-1 bg-green-500 bg-opacity-20 text-green-400 rounded-full">Active</span>
                                    </div>
                                    <p class="text-sm text-slate-400 mb-2">Search your knowledge base</p>
                                    <div class="text-xs text-slate-500">Usage: /search [query]</div>
                                </div>
                                
                                <div class="glass-dark rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-2">
                                        <code class="text-sm font-mono text-indigo-300">/upload</code>
                                        <span class="text-xs px-2 py-1 bg-green-500 bg-opacity-20 text-green-400 rounded-full">Active</span>
                                    </div>
                                    <p class="text-sm text-slate-400 mb-2">Upload and process files</p>
                                    <div class="text-xs text-slate-500">Usage: /upload [attachment]</div>
                                </div>
                                
                                <div class="glass-dark rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-2">
                                        <code class="text-sm font-mono text-indigo-300">/status</code>
                                        <span class="text-xs px-2 py-1 bg-green-500 bg-opacity-20 text-green-400 rounded-full">Active</span>
                                    </div>
                                    <p class="text-sm text-slate-400 mb-2">Check bot and system status</p>
                                    <div class="text-xs text-slate-500">Usage: /status</div>
                                </div>
                                
                                <div class="glass-dark rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-2">
                                        <code class="text-sm font-mono text-indigo-300">/recent</code>
                                        <span class="text-xs px-2 py-1 bg-green-500 bg-opacity-20 text-green-400 rounded-full">Active</span>
                                    </div>
                                    <p class="text-sm text-slate-400 mb-2">View recent notes and activity</p>
                                    <div class="text-xs text-slate-500">Usage: /recent [count]</div>
                                </div>
                                
                                <div class="glass-dark rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-2">
                                        <code class="text-sm font-mono text-indigo-300">/help</code>
                                        <span class="text-xs px-2 py-1 bg-green-500 bg-opacity-20 text-green-400 rounded-full">Active</span>
                                    </div>
                                    <p class="text-sm text-slate-400 mb-2">Show help and command list</p>
                                    <div class="text-xs text-slate-500">Usage: /help [command]</div>
                                </div>
                            </div>
                        </div>

                        <!-- Recent Activity -->
                        <div class="mb-8">
                            <h2 class="text-xl font-bold text-white mb-4 flex items-center">
                                <svg class="w-6 h-6 mr-2 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                Recent Activity
                            </h2>
                            <div class="glass-dark rounded-xl" id="discordActivity">
                                <div class="p-6 text-center text-slate-400">
                                    <svg class="w-12 h-12 mx-auto mb-3 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                    <p>No recent bot activity</p>
                                    <p class="text-sm text-slate-500 mt-1">Discord interactions will appear here</p>
                                </div>
                            </div>
                        </div>

                        <!-- Bot Configuration -->
                        <div class="mb-8">
                            <h2 class="text-xl font-bold text-white mb-4 flex items-center">
                                <svg class="w-6 h-6 mr-2 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                                Bot Configuration
                            </h2>
                            
                            <div class="glass-dark rounded-xl p-6 mb-6">
                                <div class="mb-6">
                                    <h3 class="text-lg font-semibold text-white mb-3">Discord Bot Setup</h3>
                                    <div class="bg-indigo-500 bg-opacity-10 border border-indigo-500 border-opacity-30 rounded-lg p-4 mb-4">
                                        <div class="flex items-start space-x-3">
                                            <svg class="w-5 h-5 text-indigo-400 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                            </svg>
                                            <div class="text-sm text-indigo-300">
                                                <p class="font-medium mb-2">Setup Instructions:</p>
                                                <ol class="space-y-1 text-xs text-indigo-200 list-decimal list-inside">
                                                    <li>Create a Discord application at <a href="https://discord.com/developers/applications" target="_blank" class="underline hover:no-underline">Discord Developer Portal</a></li>
                                                    <li>Create a bot user and copy the bot token</li>
                                                    <li>Set the DISCORD_BOT_TOKEN environment variable</li>
                                                    <li>Run the discord_bot.py script separately</li>
                                                    <li>Invite the bot to your server with appropriate permissions</li>
                                                </ol>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="space-y-4">
                                        <div>
                                            <label class="block text-sm font-medium text-slate-300 mb-2">Bot Token Status</label>
                                            <div id="botTokenStatus" class="flex items-center space-x-2 px-3 py-2 bg-slate-700 rounded-lg">
                                                <div id="tokenStatusDot" class="w-2 h-2 bg-gray-400 rounded-full"></div>
                                                <span id="tokenStatusText" class="text-sm text-slate-300">Checking...</span>
                                            </div>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-slate-300 mb-2">Bot Permissions</label>
                                            <div class="grid grid-cols-2 md:grid-cols-3 gap-2 text-xs">
                                                <div class="flex items-center space-x-2 px-3 py-2 bg-slate-700 rounded-lg">
                                                    <span class="text-green-400">‚úì</span>
                                                    <span class="text-slate-300">Send Messages</span>
                                                </div>
                                                <div class="flex items-center space-x-2 px-3 py-2 bg-slate-700 rounded-lg">
                                                    <span class="text-green-400">‚úì</span>
                                                    <span class="text-slate-300">Read Message History</span>
                                                </div>
                                                <div class="flex items-center space-x-2 px-3 py-2 bg-slate-700 rounded-lg">
                                                    <span class="text-green-400">‚úì</span>
                                                    <span class="text-slate-300">Attach Files</span>
                                                </div>
                                                <div class="flex items-center space-x-2 px-3 py-2 bg-slate-700 rounded-lg">
                                                    <span class="text-green-400">‚úì</span>
                                                    <span class="text-slate-300">Use Slash Commands</span>
                                                </div>
                                                <div class="flex items-center space-x-2 px-3 py-2 bg-slate-700 rounded-lg">
                                                    <span class="text-green-400">‚úì</span>
                                                    <span class="text-slate-300">Embed Links</span>
                                                </div>
                                                <div class="flex items-center space-x-2 px-3 py-2 bg-slate-700 rounded-lg">
                                                    <span class="text-green-400">‚úì</span>
                                                    <span class="text-slate-300">Add Reactions</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Bot Controls -->
                        <div class="mb-8">
                            <h2 class="text-xl font-bold text-white mb-4 flex items-center">
                                <svg class="w-6 h-6 mr-2 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4"/>
                                </svg>
                                Bot Management
                            </h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                <button onclick="refreshBotStatus()" class="glass-dark rounded-lg p-4 hover:bg-white hover:bg-opacity-5 transition-all group">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-10 h-10 bg-blue-500 bg-opacity-20 rounded-lg flex items-center justify-center group-hover:bg-opacity-30 transition-all">
                                            <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                            </svg>
                                        </div>
                                        <div class="text-left">
                                            <div class="text-white font-medium">Refresh Status</div>
                                            <div class="text-xs text-slate-400">Update bot connection info</div>
                                        </div>
                                    </div>
                                </button>
                                
                                <button onclick="viewBotLogs()" class="glass-dark rounded-lg p-4 hover:bg-white hover:bg-opacity-5 transition-all group">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-10 h-10 bg-green-500 bg-opacity-20 rounded-lg flex items-center justify-center group-hover:bg-opacity-30 transition-all">
                                            <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                            </svg>
                                        </div>
                                        <div class="text-left">
                                            <div class="text-white font-medium">View Logs</div>
                                            <div class="text-xs text-slate-400">Check bot activity logs</div>
                                        </div>
                                    </div>
                                </button>
                                
                                <button onclick="testBotConnection()" class="glass-dark rounded-lg p-4 hover:bg-white hover:bg-opacity-5 transition-all group">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-10 h-10 bg-purple-500 bg-opacity-20 rounded-lg flex items-center justify-center group-hover:bg-opacity-30 transition-all">
                                            <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                            </svg>
                                        </div>
                                        <div class="text-left">
                                            <div class="text-white font-medium">Test Connection</div>
                                            <div class="text-xs text-slate-400">Verify bot connectivity</div>
                                        </div>
                                    </div>
                                </button>
                                
                                <button onclick="openBotInviteLink()" class="glass-dark rounded-lg p-4 hover:bg-white hover:bg-opacity-5 transition-all group">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-10 h-10 bg-yellow-500 bg-opacity-20 rounded-lg flex items-center justify-center group-hover:bg-opacity-30 transition-all">
                                            <svg class="w-5 h-5 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                            </svg>
                                        </div>
                                        <div class="text-left">
                                            <div class="text-white font-medium">Invite Bot</div>
                                            <div class="text-xs text-slate-400">Add to your server</div>
                                        </div>
                                    </div>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Global Quick Actions Modal -->
    <div id="quickActionsModal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="glass-dark rounded-2xl max-w-4xl w-full p-8 shadow-large animate-scale-in">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-white">Quick Actions</h2>
                <button onclick="hideGlobalQuickActions()" class="text-slate-400 hover:text-white transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <button onclick="openNewNote()" class="glass-dark p-6 rounded-xl hover:bg-white hover:bg-opacity-10 transition-all group">
                    <div class="text-4xl mb-3 group-hover:scale-110 transition-transform">‚úèÔ∏è</div>
                    <div class="text-white font-medium">New Note</div>
                    <div class="text-slate-400 text-xs mt-1">‚åòN</div>
                </button>
                
                <button onclick="console.log('üé§ DEBUG: Quick Action Voice Note clicked'); showVoiceRecordingModal()" class="glass-dark p-6 rounded-xl hover:bg-white hover:bg-opacity-10 transition-all group">
                    <div class="text-4xl mb-3 group-hover:scale-110 transition-transform">üé§</div>
                    <div class="text-white font-medium">Voice Note</div>
                    <div class="text-slate-400 text-xs mt-1">Record</div>
                </button>
                
                <button onclick="showQuickUpload()" class="glass-dark p-6 rounded-xl hover:bg-white hover:bg-opacity-10 transition-all group">
                    <div class="text-4xl mb-3 group-hover:scale-110 transition-transform">üìÅ</div>
                    <div class="text-white font-medium">Upload Files</div>
                    <div class="text-slate-400 text-xs mt-1">‚åòU</div>
                </button>
                
                <button onclick="showView('search')" class="glass-dark p-6 rounded-xl hover:bg-white hover:bg-opacity-10 transition-all group">
                    <div class="text-4xl mb-3 group-hover:scale-110 transition-transform">üîç</div>
                    <div class="text-white font-medium">Search</div>
                    <div class="text-slate-400 text-xs mt-1">‚åòK</div>
                </button>
            </div>
            
            <div class="border-t border-slate-600 pt-4">
                <h3 class="text-white font-medium mb-3">Recent Activity</h3>
                <div id="recentActivityList" class="space-y-2 max-h-40 overflow-y-auto custom-scrollbar">
                    <div class="text-slate-400 text-sm text-center py-4">Loading recent activity...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- PWA Install Banner -->
    <div id="pwaInstallBanner" class="fixed top-0 left-0 right-0 bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-4 py-3 shadow-lg z-60 hidden">
        <div class="flex items-center justify-between max-w-7xl mx-auto">
            <div class="flex items-center space-x-3">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                </svg>
                <div>
                    <div class="font-medium text-sm">Install Second Brain</div>
                    <div class="text-xs text-indigo-100">Get the app for quick access to your knowledge base</div>
                </div>
            </div>
            <div class="flex items-center space-x-2">
                <button onclick="installPWA()" class="bg-white text-indigo-600 px-4 py-2 rounded-lg text-sm font-medium hover:bg-indigo-50 transition-colors">
                    Install
                </button>
                <button onclick="dismissPWABanner()" class="text-white hover:text-indigo-200 p-1 rounded transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Voice Recording Modal -->
    <div id="voiceRecordingModal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="glass-dark rounded-2xl max-w-lg w-full p-8 shadow-large animate-scale-in">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-white flex items-center">
                    <svg class="w-6 h-6 mr-3 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                    </svg>
                    Voice Recording
                </h2>
                <button onclick="hideVoiceRecordingModal()" class="text-slate-400 hover:text-white transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Recording Interface -->
            <div class="text-center">
                <!-- Recording Status -->
                <div id="recordingStatus" class="mb-6">
                    <div id="microphoneIcon" class="w-20 h-20 bg-gradient-to-br from-red-500 to-red-600 rounded-full flex items-center justify-center mx-auto mb-4 transition-all duration-300">
                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                        </svg>
                    </div>
                    <div id="recordingText" class="text-white font-medium text-lg">Ready to Record</div>
                    <div id="recordingTimer" class="text-slate-400 text-sm mt-1">00:00</div>
                </div>

                <!-- Waveform Visualizer -->
                <div id="waveformContainer" class="mb-6 hidden">
                    <div class="flex items-center justify-center space-x-1 h-16">
                        <div class="waveform-bar bg-red-400 w-1 rounded-full transition-all duration-150" style="height: 4px;"></div>
                        <div class="waveform-bar bg-red-400 w-1 rounded-full transition-all duration-150" style="height: 8px;"></div>
                        <div class="waveform-bar bg-red-400 w-1 rounded-full transition-all duration-150" style="height: 12px;"></div>
                        <div class="waveform-bar bg-red-400 w-1 rounded-full transition-all duration-150" style="height: 16px;"></div>
                        <div class="waveform-bar bg-red-400 w-1 rounded-full transition-all duration-150" style="height: 20px;"></div>
                        <div class="waveform-bar bg-red-400 w-1 rounded-full transition-all duration-150" style="height: 16px;"></div>
                        <div class="waveform-bar bg-red-400 w-1 rounded-full transition-all duration-150" style="height: 12px;"></div>
                        <div class="waveform-bar bg-red-400 w-1 rounded-full transition-all duration-150" style="height: 8px;"></div>
                        <div class="waveform-bar bg-red-400 w-1 rounded-full transition-all duration-150" style="height: 4px;"></div>
                    </div>
                </div>

                <!-- Control Buttons -->
                <div class="flex items-center justify-center space-x-4">
                    <button id="recordButton" onclick="toggleRecording()" disabled class="w-16 h-16 bg-red-500 hover:bg-red-600 rounded-full flex items-center justify-center transition-all duration-300 shadow-lg hover:shadow-xl opacity-50 cursor-not-allowed" title="Initializing audio recorder...">
                        <svg id="recordIcon" class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                        </svg>
                    </button>
                    
                    <button id="stopButton" onclick="stopRecording()" class="w-12 h-12 bg-slate-600 hover:bg-slate-500 rounded-full flex items-center justify-center transition-all duration-300 opacity-50 cursor-not-allowed" disabled>
                        <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M6 6h12v12H6z"></path>
                        </svg>
                    </button>
                </div>

                <!-- Recording Tips -->
                <div class="mt-6 text-xs text-slate-400 text-left">
                    <div class="bg-slate-800 bg-opacity-50 rounded-lg p-3">
                        <div class="font-medium text-slate-300 mb-1">Tips for better recording:</div>
                        <ul class="space-y-1">
                            <li>‚Ä¢ Speak clearly and at a normal pace</li>
                            <li>‚Ä¢ Record in a quiet environment</li>
                            <li>‚Ä¢ Keep your microphone close but not too close</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Persistent Microphone Permission Banner -->
    <div id="microphonePermissionBanner" data-bottom-banner="mic" class="fixed bottom-4 left-4 right-4 md:left-auto md:right-4 md:max-w-md glass rounded-xl p-4 shadow-large z-60 hidden">
        <div class="flex items-start space-x-3">
            <div class="w-10 h-10 bg-red-500 bg-opacity-20 rounded-xl flex items-center justify-center flex-shrink-0">
                <svg class="w-6 h-6 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M5.07 19h13.86A2.07 2.07 0 0021 16.93V7.07A2.07 2.07 0 0018.93 5H5.07A2.07 2.07 0 003 7.07v9.86A2.07 2.07 0 005.07 19z"/>
                </svg>
            </div>
            <div class="flex-1">
                <div class="flex items-start justify-between">
                    <div>
                        <div class="text-slate-100 font-medium">Microphone permission required</div>
                        <div class="text-slate-300 text-sm mt-1" id="microphonePermissionText">Allow microphone access to record voice notes.</div>
                    </div>
                    <button onclick="dismissMicrophoneBanner()" class="text-slate-400 hover:text-slate-200 ml-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div class="mt-3 space-y-2 text-xs text-slate-300">
                    <div>Tips:</div>
                    <ul class="list-disc ml-5 space-y-1">
                        <li>Click Request Access and accept the browser prompt.</li>
                        <li>If you blocked it before, open the site info in your browser's address bar and set Microphone to Allow.</li>
                        <li>Safari: System Settings > Privacy & Security > Microphone, enable for your browser.</li>
                    </ul>
                </div>
                <div class="mt-3 flex items-center space-x-2">
                    <button id="requestMicBtn" onclick="requestMicrophonePermission()" class="px-3 py-1.5 bg-red-500 hover:bg-red-600 text-white rounded-lg text-sm">Request Access</button>
                    <button onclick="openMicrophoneHelp()" class="px-3 py-1.5 bg-slate-700 hover:bg-slate-600 text-slate-200 rounded-lg text-sm">How to allow</button>
                </div>
            </div>
        </div>
    </div>

    <!-- PWA Install Prompt (Bottom Notification) -->
    <div id="pwaInstallPrompt" data-bottom-banner="pwaPrompt" class="fixed bottom-4 left-4 right-4 md:left-auto md:right-4 md:max-w-sm glass rounded-xl p-4 shadow-large z-50 hidden">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                    </svg>
                </div>
                <div class="flex-1">
                    <div class="text-sm font-medium text-slate-100">Add to Home Screen</div>
                    <div class="text-xs text-slate-400">Quick access to Second Brain</div>
                </div>
            </div>
            <div class="flex space-x-2 ml-3">
                <button onclick="installPWA()" class="bg-indigo-500 hover:bg-indigo-600 text-white px-3 py-1.5 rounded-lg text-xs font-medium transition-colors">
                    Install
                </button>
                <button onclick="dismissPWAPrompt()" class="text-slate-400 hover:text-slate-200 p-1 rounded transition-colors">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- PWA iOS Install Instructions Modal -->
    <div id="pwaIOSInstructions" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm z-60 hidden flex items-center justify-center p-4">
        <div class="glass rounded-2xl max-w-md w-full p-6 shadow-large animate-scale-in">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-slate-100">Install Second Brain</h3>
                <button onclick="hideIOSInstructions()" class="text-slate-400 hover:text-slate-200 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="space-y-4 text-sm text-slate-300">
                <p class="text-slate-200">To install Second Brain on your iPhone or iPad:</p>
                
                <div class="flex items-start space-x-3">
                    <div class="w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                        <span class="text-white text-xs font-bold">1</span>
                    </div>
                    <div>
                        <p>Tap the <strong>Share</strong> button in Safari</p>
                        <div class="w-8 h-8 bg-slate-700 rounded-lg flex items-center justify-center mt-2">
                            <svg class="w-4 h-4 text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
                
                <div class="flex items-start space-x-3">
                    <div class="w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                        <span class="text-white text-xs font-bold">2</span>
                    </div>
                    <p>Select <strong>"Add to Home Screen"</strong></p>
                </div>
                
                <div class="flex items-start space-x-3">
                    <div class="w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                        <span class="text-white text-xs font-bold">3</span>
                    </div>
                    <p>Tap <strong>"Add"</strong> in the top-right corner</p>
                </div>
            </div>
            
            <button onclick="hideIOSInstructions()" class="w-full mt-6 bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 text-white px-4 py-3 rounded-xl font-medium transition-all duration-200">
                Got it!
            </button>
        </div>
    </div>

    <!-- Advanced Search Modal -->
    <div id="advancedSearchModal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm z-60 hidden flex items-center justify-center p-4">
        <div class="glass-dark rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden shadow-large animate-scale-in flex flex-col">

            <!-- Search Header -->
            <div class="p-6 pb-4 border-b border-slate-700">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-bold text-white flex items-center">
                        <svg class="w-6 h-6 mr-3 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        Advanced Search
                    </h2>
                    <button onclick="hideAdvancedSearchModal()" class="text-slate-400 hover:text-white transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <!-- Search Input -->
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                        <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </div>
                    <input
                        type="text"
                        id="advancedSearchInput"
                        placeholder="Search your notes, transcriptions, bookmarks..."
                        class="w-full bg-slate-800 bg-opacity-50 text-white placeholder-slate-400 pl-12 pr-32 py-4 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all"
                        oninput="handleAdvancedSearchInput(event)"
                        autocomplete="off"
                    >
                    <div class="absolute inset-y-0 right-0 pr-4 flex items-center pointer-events-none">
                        <div class="flex items-center space-x-2">
                            <kbd class="hidden sm:inline-block px-2 py-1 text-xs font-semibold text-slate-400 bg-slate-700 border border-slate-600 rounded">
                                <span id="keyboardShortcut">Ctrl+K</span>
                            </kbd>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filter Bar -->
            <div class="p-4 bg-slate-800 bg-opacity-30 border-b border-slate-700 overflow-x-auto">
                <div class="flex flex-wrap gap-3 min-w-max">

                    <!-- Date Range Filter -->
                    <div class="flex items-center space-x-2">
                        <label class="text-xs font-medium text-slate-400 uppercase tracking-wider">Date:</label>
                        <div class="flex space-x-1">
                            <button
                                onclick="setDateFilter('7d')"
                                id="dateFilter7d"
                                class="px-3 py-1.5 text-xs font-medium rounded-lg transition-all date-filter-btn bg-slate-700 text-slate-300 hover:bg-slate-600"
                            >
                                7 days
                            </button>
                            <button
                                onclick="setDateFilter('30d')"
                                id="dateFilter30d"
                                class="px-3 py-1.5 text-xs font-medium rounded-lg transition-all date-filter-btn bg-slate-700 text-slate-300 hover:bg-slate-600"
                            >
                                30 days
                            </button>
                            <button
                                onclick="setDateFilter('all')"
                                id="dateFilterAll"
                                class="px-3 py-1.5 text-xs font-medium rounded-lg transition-all date-filter-btn bg-indigo-500 text-white"
                            >
                                All time
                            </button>
                        </div>
                    </div>

                    <!-- Content Type Filter -->
                    <div class="flex items-center space-x-2">
                        <label class="text-xs font-medium text-slate-400 uppercase tracking-wider">Type:</label>
                        <div class="flex flex-wrap gap-1">
                            <button
                                onclick="toggleTypeFilter('all')"
                                id="typeFilterAll"
                                class="px-3 py-1.5 text-xs font-medium rounded-lg transition-all type-filter-btn bg-indigo-500 text-white"
                            >
                                All
                            </button>
                            <button
                                onclick="toggleTypeFilter('audio')"
                                id="typeFilterAudio"
                                class="px-3 py-1.5 text-xs font-medium rounded-lg transition-all type-filter-btn bg-slate-700 text-slate-300 hover:bg-slate-600"
                            >
                                <svg class="w-3 h-3 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                                </svg>
                                Audio
                            </button>
                            <button
                                onclick="toggleTypeFilter('text')"
                                id="typeFilterText"
                                class="px-3 py-1.5 text-xs font-medium rounded-lg transition-all type-filter-btn bg-slate-700 text-slate-300 hover:bg-slate-600"
                            >
                                <svg class="w-3 h-3 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                Text
                            </button>
                            <button
                                onclick="toggleTypeFilter('web')"
                                id="typeFilterWeb"
                                class="px-3 py-1.5 text-xs font-medium rounded-lg transition-all type-filter-btn bg-slate-700 text-slate-300 hover:bg-slate-600"
                            >
                                <svg class="w-3 h-3 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"></path>
                                </svg>
                                Web
                            </button>
                            <button
                                onclick="toggleTypeFilter('pdf')"
                                id="typeFilterPdf"
                                class="px-3 py-1.5 text-xs font-medium rounded-lg transition-all type-filter-btn bg-slate-700 text-slate-300 hover:bg-slate-600"
                            >
                                <svg class="w-3 h-3 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                </svg>
                                PDF
                            </button>
                            <button
                                onclick="toggleTypeFilter('image')"
                                id="typeFilterImage"
                                class="px-3 py-1.5 text-xs font-medium rounded-lg transition-all type-filter-btn bg-slate-700 text-slate-300 hover:bg-slate-600"
                            >
                                <svg class="w-3 h-3 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                </svg>
                                Image
                            </button>
                        </div>
                    </div>

                    <!-- Tag Filter -->
                    <div class="flex items-center space-x-2">
                        <label class="text-xs font-medium text-slate-400 uppercase tracking-wider">Tags:</label>
                        <div class="relative">
                            <input
                                type="text"
                                id="tagFilterInput"
                                placeholder="Filter by tag..."
                                class="px-3 py-1.5 text-xs bg-slate-700 text-white placeholder-slate-400 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 min-w-[150px]"
                                oninput="handleTagFilterInput(event)"
                                autocomplete="off"
                            >
                            <!-- Tag autocomplete dropdown will be added in Phase 2 -->
                        </div>
                    </div>

                    <!-- Status Filter -->
                    <div class="flex items-center space-x-2">
                        <label class="text-xs font-medium text-slate-400 uppercase tracking-wider">Status:</label>
                        <select
                            id="statusFilter"
                            onchange="updateSearchFilters()"
                            class="px-3 py-1.5 text-xs bg-slate-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 cursor-pointer"
                        >
                            <option value="all">All</option>
                            <option value="active">Active</option>
                            <option value="archived">Archived</option>
                            <option value="favorite">Favorites</option>
                        </select>
                    </div>

                    <!-- Clear Filters Button -->
                    <button
                        onclick="clearAllFilters()"
                        id="clearFiltersBtn"
                        class="ml-auto px-4 py-1.5 text-xs font-medium text-slate-400 hover:text-white bg-slate-700 hover:bg-slate-600 rounded-lg transition-all hidden"
                    >
                        Clear Filters
                    </button>
                </div>

                <!-- Active Filters Display -->
                <div id="activeFiltersDisplay" class="mt-3 hidden">
                    <div class="flex flex-wrap gap-2 items-center">
                        <span class="text-xs text-slate-400">Active filters:</span>
                        <div id="activeFilterTags" class="flex flex-wrap gap-2"></div>
                    </div>
                </div>
            </div>

            <!-- Search Results (Placeholder for Phase 2) -->
            <div class="flex-1 overflow-y-auto p-6">
                <div id="advancedSearchResults" class="text-center text-slate-400 py-12">
                    <svg class="w-16 h-16 mx-auto mb-4 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    <p class="text-lg font-medium mb-2">Start typing to search</p>
                    <p class="text-sm text-slate-500">Search results will appear here</p>
                </div>
            </div>

        </div>
    </div>

    <!-- Performance & Advanced Features JavaScript -->
    <script src="/static/js/dashboard-performance.js"></script>
    
    <!-- Content Management System JavaScript -->
    <script src="/static/js/content-management.js"></script>
    
    <!-- Testing Framework JavaScript -->
    <script src="/static/js/dashboard-testing.js"></script>
    
    <!-- Help & Documentation System JavaScript -->
    <script src="/static/js/dashboard-help.js"></script>
    
    <!-- Mobile Interface Revolution JavaScript -->
    <script src="/static/js/mobile-interface.js"></script>

    <script>
        // Global App State
        let currentView = 'dashboard';
        let sidebarOpen = window.innerWidth >= 1024; // lg breakpoint

        // View Management
        function showView(viewName) {
            // Hide all views
            document.querySelectorAll('.view').forEach(view => {
                view.classList.remove('active');
                view.classList.add('hidden');
            });
            
            // Show selected view
            const selectedView = document.getElementById(viewName + '-view');
            if (selectedView) {
                selectedView.classList.remove('hidden');
                selectedView.classList.add('active');
            }
            
            // Update navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            const activeNavItem = document.querySelector(`[onclick="showView('${viewName}')"]`);
            if (activeNavItem) {
                activeNavItem.classList.add('active');
            }
            
            const previousView = currentView;
            currentView = viewName;
            
            // Initialize view-specific data
            if (viewName === 'notes') {
                // Load all notes when entering the Notes view
                loadAllNotes();
            } else if (viewName === 'search') {
                // Initialize search view
                initializeSearchView();
            }
            
            // Dispatch view change event for testing and help systems
            document.dispatchEvent(new CustomEvent('view-changed', {
                detail: { view: viewName, previousView }
            }));
            
            // Close sidebar on mobile after navigation
            if (window.innerWidth < 1024) {
                toggleSidebar();
            }
        }

        // Enhanced Sidebar Management
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebarOpen = !sidebarOpen;
            
            if (sidebarOpen) {
                sidebar.classList.remove('-translate-x-full');
                sidebar.classList.add('translate-x-0');
                overlay.classList.remove('hidden');
                // Prevent body scroll on mobile when sidebar is open
                document.body.classList.add('overflow-hidden', 'lg:overflow-auto');
                // Focus trap for accessibility
                trapFocus(sidebar);
                announceToScreenReader('Sidebar opened');
            } else {
                sidebar.classList.add('-translate-x-full');
                sidebar.classList.remove('translate-x-0');
                overlay.classList.add('hidden');
                // Restore body scroll
                document.body.classList.remove('overflow-hidden');
                announceToScreenReader('Sidebar closed');
            }
        }
        
        // Close sidebar on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && sidebarOpen && window.innerWidth < 1024) {
                toggleSidebar();
            }
        });
        
        // Close sidebar on window resize to desktop
        window.addEventListener('resize', function() {
            if (window.innerWidth >= 1024 && sidebarOpen) {
                const overlay = document.getElementById('sidebarOverlay');
                overlay.classList.add('hidden');
                document.body.classList.remove('overflow-hidden');
                sidebarOpen = false;
            }
        });

        // Global Search
        function handleGlobalSearch(event) {
            if (event.key === 'Enter') {
                const query = event.target.value.trim();
                if (query) {
                    console.log('Searching for:', query);
                    showView('search');
                    // Populate advanced search input and trigger search
                    document.getElementById('advancedSearchInput').value = query;
                    performAdvancedSearch();
                }
            }
        }

        // Advanced Search System
        let activeSearchFilters = ['notes']; // Default to notes filter
        let searchHistory = JSON.parse(localStorage.getItem('searchHistory') || '[]');
        let searchTimeout;
        let lastSearchQuery = '';

        function handleAdvancedSearch(event) {
            const suggestionsContainer = document.getElementById('searchSuggestions');
            const suggestions = suggestionsContainer.querySelectorAll('.suggestion-item');
            
            if (event.key === 'Enter') {
                // If there's a highlighted suggestion, use it
                const highlighted = suggestionsContainer.querySelector('.highlighted');
                if (highlighted) {
                    const suggestionText = highlighted.querySelector('.suggestion-text')?.textContent;
                    if (suggestionText) {
                        selectSearchSuggestion(suggestionText);
                        return;
                    }
                }
                
                // Otherwise perform regular search
                suggestionsContainer.classList.add('hidden');
                performAdvancedSearch();
            } else if (event.key === 'ArrowDown') {
                event.preventDefault();
                navigateSuggestions('down');
            } else if (event.key === 'ArrowUp') {
                event.preventDefault();
                navigateSuggestions('up');
            } else if (event.key === 'Escape') {
                suggestionsContainer.classList.add('hidden');
            }
        }

        // Navigate through suggestions with arrow keys
        function navigateSuggestions(direction) {
            const suggestionsContainer = document.getElementById('searchSuggestions');
            const suggestions = suggestionsContainer.querySelectorAll('.suggestion-item');
            
            if (suggestions.length === 0) return;
            
            const current = suggestionsContainer.querySelector('.highlighted');
            let index = -1;
            
            if (current) {
                index = Array.from(suggestions).indexOf(current);
                current.classList.remove('highlighted');
            }
            
            if (direction === 'down') {
                index = (index + 1) % suggestions.length;
            } else {
                index = index <= 0 ? suggestions.length - 1 : index - 1;
            }
            
            suggestions[index].classList.add('highlighted');
        }
        
        function handleSearchInput(value) {
            const query = value.trim();
            
            // Always show suggestions when typing (debounced)
            if (query.length >= 2) {
                showSearchSuggestions(query);
            } else {
                document.getElementById('searchSuggestions').classList.add('hidden');
            }
            
            // Clear previous search timeout
            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }
            
            // Don't perform automatic search if query is too short or same as last
            if (query.length < 3 || query === lastSearchQuery) {
                return;
            }
            
            // Add visual indicator that search will happen
            const searchInput = document.getElementById('advancedSearchInput');
            searchInput.style.borderColor = '#8B5CF6'; // Purple border for pending search
            
            // Debounce automatic search with reduced delay for better UX
            searchTimeout = setTimeout(() => {
                if (query.length >= 3 && document.getElementById('advancedSearchInput').value.trim() === query) {
                    lastSearchQuery = query;
                    searchInput.style.borderColor = ''; // Reset border
                    performAdvancedSearch(false); // false = don't add to history for auto-search
                }
            }, 800); // Reduced to 800ms for more responsive feel
        }

        function toggleSearchFilter(filter) {
            const button = document.getElementById(`filter${filter.charAt(0).toUpperCase() + filter.slice(1)}`);
            const index = activeSearchFilters.indexOf(filter);
            
            if (index > -1) {
                // Remove filter
                activeSearchFilters.splice(index, 1);
                button.classList.remove('active', 'bg-indigo-100', 'border-indigo-300', 'text-indigo-800');
                button.classList.add('border-slate-300', 'text-slate-300');
            } else {
                // Add filter
                activeSearchFilters.push(filter);
                button.classList.add('active', 'bg-indigo-100', 'border-indigo-300', 'text-indigo-800');
                button.classList.remove('border-slate-300', 'text-slate-300');
            }
            
            // Update hover states for inactive filters
            document.querySelectorAll('.search-filter:not(.active)').forEach(btn => {
                btn.classList.add('hover:bg-slate-200', 'hover:text-slate-700');
            });
        }

        function quickSearch(term) {
            const searchInput = document.getElementById('advancedSearchInput');
            searchInput.value = term;
            performAdvancedSearch();
        }

        function clearSearch() {
            document.getElementById('advancedSearchInput').value = '';
            document.getElementById('searchResultsContainer').classList.add('hidden');
            document.getElementById('searchSuggestions').classList.add('hidden');
            
            // Reset filters to default
            activeSearchFilters = ['notes'];
            document.querySelectorAll('.search-filter').forEach(btn => {
                btn.classList.remove('active', 'bg-indigo-100', 'border-indigo-300', 'text-indigo-800');
                btn.classList.add('border-slate-300', 'text-slate-300', 'hover:bg-slate-200', 'hover:text-slate-700');
            });
            document.getElementById('filterNotes').classList.add('active', 'bg-indigo-100', 'border-indigo-300', 'text-indigo-800');
            document.getElementById('filterNotes').classList.remove('border-slate-300', 'text-slate-300', 'hover:bg-slate-200', 'hover:text-slate-700');
        }

        async function performAdvancedSearch(addToHistory = true) {
            const query = document.getElementById('advancedSearchInput').value.trim();
            
            if (!query) {
                if (addToHistory) { // Only show message for manual searches
                    showSearchMessage('Please enter a search term', 'warning');
                }
                return;
            }

            // Add to search history (only for manual searches or Enter key)
            if (addToHistory && !searchHistory.includes(query)) {
                searchHistory.unshift(query);
                searchHistory = searchHistory.slice(0, 10); // Keep only last 10 searches
                localStorage.setItem('searchHistory', JSON.stringify(searchHistory));
            }

            // Show loading state
            showSearchLoading();

            try {
                // Build search URL with query parameters to match backend GET endpoint
                const params = new URLSearchParams({
                    q: query,
                    limit: '20'
                });

                // Call search API using GET with query parameters
                const response = await fetch(`/api/search?${params.toString()}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (response.ok) {
                    const results = await response.json();
                    displaySearchResults(results, query);
                    
                    // Dispatch search event for testing and help systems
                    document.dispatchEvent(new CustomEvent('search-performed', {
                        detail: { 
                            query, 
                            results: results.results?.length || results.total || 0, 
                            filters: activeSearchFilters,
                            mode: results.mode,
                            response_time: results.response_time_ms 
                        }
                    }));
                } else if (response.status === 401) {
                    showSearchMessage('Please log in to search', 'error');
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || `Search failed: ${response.status}`);
                }
            } catch (error) {
                console.error('Search error:', error);
                showSearchMessage('Search failed. Please try again.', 'error');
                
                // Dispatch search error event
                document.dispatchEvent(new CustomEvent('search-no-results', {
                    detail: { query, error: error.message, filters: activeSearchFilters }
                }));
            }
        }

        // Build advanced search filters for API request
        function buildSearchFilters() {
            const filters = {};
            
            // Content type filters
            if (activeSearchFilters.length > 0 && !activeSearchFilters.includes('notes')) {
                // Map UI filters to API filter format
                const typeMap = {
                    'audio': 'audio',
                    'files': 'file', 
                    'ai': 'ai_generated',
                    'recent': 'recent'
                };
                
                const mappedTypes = activeSearchFilters
                    .map(filter => typeMap[filter])
                    .filter(type => type);
                
                if (mappedTypes.length > 0) {
                    filters.type = mappedTypes[0]; // Use first type for now
                }
            }
            
            // TODO: Add date range filters when UI supports them
            // TODO: Add tag filters when UI supports them
            
            return filters;
        }

        function showSearchLoading() {
            const container = document.getElementById('searchResultsContainer');
            const resultsList = document.getElementById('searchResultsList');
            const noResults = document.getElementById('noResults');
            
            container.classList.remove('hidden');
            noResults.classList.add('hidden');
            
            resultsList.innerHTML = `
                <div class="flex items-center justify-center py-8 text-slate-400">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-500 mr-3"></div>
                    <span>Searching your knowledge base...</span>
                </div>
            `;
        }

        function displaySearchResults(searchResponse, query) {
            const container = document.getElementById('searchResultsContainer');
            const resultsList = document.getElementById('searchResultsList');
            const noResults = document.getElementById('noResults');
            const resultsCount = document.getElementById('searchResultsCount');
            
            container.classList.remove('hidden');
            
            // Handle SearchRouter response format
            const results = searchResponse.results || [];
            const total = searchResponse.total || results.length;
            const mode = searchResponse.mode || 'hybrid';
            const responseTime = searchResponse.response_time_ms;
            
            if (!results || results.length === 0) {
                resultsList.innerHTML = '';
                noResults.classList.remove('hidden');
                resultsCount.textContent = 'No results';
                return;
            }

            noResults.classList.add('hidden');
            
            // Display results count with additional info
            let countText = `${total} result${total !== 1 ? 's' : ''} for "${query}"`;
            if (responseTime) {
                countText += ` (${responseTime}ms)`;
            }
            if (mode && mode !== 'hybrid') {
                countText += ` ‚Ä¢ ${mode} search`;
            }
            resultsCount.textContent = countText;
            
            // Display results
            resultsList.innerHTML = results.map(note => {
                const createdDate = new Date(note.created_at).toLocaleDateString();
                
                // Handle different content sources
                let snippet = '';
                if (note.snippet) {
                    snippet = note.snippet;
                } else if (note.content) {
                    snippet = note.content.substring(0, 150) + (note.content.length > 150 ? '...' : '');
                } else if (note.body) {
                    snippet = note.body.substring(0, 150) + (note.body.length > 150 ? '...' : '');
                } else if (note.summary) {
                    snippet = note.summary.substring(0, 150) + (note.summary.length > 150 ? '...' : '');
                }
                
                const noteType = getNoteTypeIcon(note);
                
                // Add search score info if available
                let scoreInfo = '';
                if (note.fts_score || note.semantic_score || note.combined_score || note.score) {
                    const score = note.combined_score || note.score || note.fts_score || note.semantic_score;
                    if (score && score > 0) {
                        scoreInfo = `<span class="text-xs text-slate-400 ml-2">score: ${(score * 100).toFixed(0)}%</span>`;
                    }
                }
                
                return `
                    <div class="bg-slate-200 hover:bg-slate-250 rounded-xl p-4 transition-colors cursor-pointer border border-slate-300 hover:border-slate-400" 
                         onclick="openNote(${note.id})">
                        <div class="flex items-start space-x-3">
                            <div class="flex-shrink-0 text-lg">${noteType}</div>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center justify-between mb-2">
                                    <h4 class="text-sm font-medium text-slate-800 truncate">${note.title || 'Untitled'}</h4>
                                    <div class="flex items-center text-xs text-slate-500">
                                        <span>${createdDate}</span>
                                        ${scoreInfo}
                                    </div>
                                </div>
                                ${snippet ? `<p class="text-xs text-slate-600 line-clamp-2 mb-2">${snippet}</p>` : ''}
                                ${note.tags ? `<div class="flex flex-wrap gap-1">
                                    ${note.tags.split(',').filter(tag => tag.trim()).map(tag => 
                                        `<span class="bg-slate-300 text-slate-700 text-xs px-2 py-1 rounded-full">${tag.trim()}</span>`
                                    ).join('')}
                                </div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getNoteTypeIcon(note) {
            if (note.audio_filename) return 'üéµ';
            if (note.file_filename) return 'üìÅ';
            if (note.summary) return 'ü§ñ';
            return 'üìù';
        }

        function openNote(noteId) {
            // Open note in modal similar to Notes view
            openNoteModal(noteId);
        }

        function showSearchMessage(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 px-4 py-2 rounded-lg shadow-lg z-50 transition-all duration-300 transform translate-x-full`;
            
            const colors = {
                'info': 'bg-blue-500 text-white',
                'success': 'bg-green-500 text-white', 
                'warning': 'bg-yellow-500 text-black',
                'error': 'bg-red-500 text-white'
            };
            
            toast.className += ` ${colors[type]}`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            // Animate in
            setTimeout(() => {
                toast.classList.remove('translate-x-full');
            }, 100);
            
            // Remove after 3 seconds
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }

        // Debounced search suggestions
        let suggestionTimeout;
        
        function showSearchSuggestions(query) {
            const suggestionsContainer = document.getElementById('searchSuggestions');
            
            if (!query.trim()) {
                suggestionsContainer.classList.add('hidden');
                return;
            }
            
            // Clear previous timeout
            if (suggestionTimeout) {
                clearTimeout(suggestionTimeout);
            }
            
            // Show loading state for suggestions
            suggestionsContainer.innerHTML = `
                <div class="px-4 py-2 text-sm text-slate-500 flex items-center">
                    <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-indigo-500 mr-2"></div>
                    <span>Loading suggestions...</span>
                </div>
            `;
            suggestionsContainer.classList.remove('hidden');
            
            // Debounce the API call with reduced delay for better responsiveness
            suggestionTimeout = setTimeout(async () => {
                try {
                    const response = await fetch('/api/search/suggestions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            query: query,
                            limit: 5
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        displaySearchSuggestions(data.suggestions || [], query);
                    } else if (response.status === 401) {
                        // Show login prompt for suggestions
                        document.getElementById('searchSuggestions').innerHTML = `
                            <div class="px-4 py-2 text-sm text-slate-500">
                                Please log in to see search suggestions
                            </div>
                        `;
                    } else {
                        // Fallback to local search history
                        showLocalSearchHistory(query);
                    }
                } catch (error) {
                    console.error('Suggestions error:', error);
                    // Fallback to local search history
                    showLocalSearchHistory(query);
                }
            }, 250); // Reduced to 250ms for more responsive suggestions
        }
        
        function displaySearchSuggestions(suggestions, query) {
            const suggestionsContainer = document.getElementById('searchSuggestions');
            
            if (!suggestions.length) {
                showLocalSearchHistory(query);
                return;
            }
            
            // Group suggestions by type for better UX
            const grouped = {};
            suggestions.forEach(sugg => {
                if (!grouped[sugg.type]) {
                    grouped[sugg.type] = [];
                }
                grouped[sugg.type].push(sugg);
            });
            
            let html = '';
            
            // Priority order for suggestion types
            const typeOrder = ['recent', 'title', 'phrase', 'tag', 'semantic', 'popular'];
            const typeLabels = {
                'recent': 'Recent searches',
                'title': 'Note titles',
                'phrase': 'Content matches',
                'tag': 'Tags', 
                'semantic': 'Related content',
                'popular': 'Popular searches'
            };
            
            for (const type of typeOrder) {
                if (grouped[type] && grouped[type].length > 0) {
                    if (html) html += '<div class="border-t border-slate-300"></div>';
                    
                    // Add section header for non-recent suggestions
                    if (type !== 'recent') {
                        html += `<div class="px-4 py-1 text-xs font-medium text-slate-500 bg-slate-100">${typeLabels[type]}</div>`;
                    }
                    
                    html += grouped[type].map(sugg => {
                        let extraInfo = '';
                        if (sugg.count) {
                            extraInfo = `<span class="text-slate-400 ml-2">${sugg.count}</span>`;
                        } else if (sugg.score) {
                            extraInfo = `<span class="text-slate-400 ml-2">${sugg.score}</span>`;
                        } else if (sugg.source) {
                            extraInfo = `<span class="text-slate-400 ml-2 truncate">from ${sugg.source}</span>`;
                        }
                        
                        return `
                            <div class="suggestion-item px-4 py-2 hover:bg-slate-300 cursor-pointer text-sm text-slate-700 border-b border-slate-300 last:border-b-0 flex items-center justify-between"
                                 onclick="selectSearchSuggestion('${sugg.text.replace(/'/g, "\\'")}')">
                                <div class="flex items-center min-w-0">
                                    <span class="text-base mr-2">${sugg.icon}</span>
                                    <span class="suggestion-text truncate">${sugg.text}</span>
                                </div>
                                ${extraInfo}
                            </div>
                        `;
                    }).join('');
                }
            }
            
            suggestionsContainer.innerHTML = html;
            suggestionsContainer.classList.remove('hidden');
        }
        
        function showLocalSearchHistory(query) {
            const suggestionsContainer = document.getElementById('searchSuggestions');
            
            // Show recent searches that match as fallback
            const matchingHistory = searchHistory.filter(item => 
                item.toLowerCase().includes(query.toLowerCase())
            );
            
            if (matchingHistory.length === 0) {
                suggestionsContainer.classList.add('hidden');
                return;
            }
            
            suggestionsContainer.innerHTML = matchingHistory.map(item => `
                <div class="px-4 py-2 hover:bg-slate-300 cursor-pointer text-sm text-slate-700 border-b border-slate-300 last:border-b-0"
                     onclick="selectSearchSuggestion('${item.replace(/'/g, "\\'")}')">
                    <svg class="w-4 h-4 inline mr-2 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    ${item}
                </div>
            `).join('');
            
            suggestionsContainer.classList.remove('hidden');
        }

        function selectSearchSuggestion(suggestion) {
            document.getElementById('advancedSearchInput').value = suggestion;
            document.getElementById('searchSuggestions').classList.add('hidden');
            performAdvancedSearch();
        }

        // Initialize search view when activated
        function initializeSearchView() {
            // Focus the search input
            const searchInput = document.getElementById('advancedSearchInput');
            if (searchInput) {
                setTimeout(() => searchInput.focus(), 100);
            }
            
            // Reset search state
            document.getElementById('searchResultsContainer').classList.add('hidden');
            document.getElementById('searchSuggestions').classList.add('hidden');
            
            // Clear any previous search results and timers
            document.getElementById('searchResultsList').innerHTML = '';
            document.getElementById('searchResultsCount').textContent = '';
            
            // Clear any pending timeouts
            if (searchTimeout) {
                clearTimeout(searchTimeout);
                searchTimeout = null;
            }
            if (suggestionTimeout) {
                clearTimeout(suggestionTimeout);
                suggestionTimeout = null;
            }
            
            // Reset search input visual state
            if (searchInput) {
                searchInput.style.borderColor = '';
            }
            
            // Initialize click outside handler for suggestions
            setupSearchEventListeners();
        }

        // Set up event listeners for search functionality
        function setupSearchEventListeners() {
            // Click outside to hide suggestions
            document.addEventListener('click', function(event) {
                const suggestionsContainer = document.getElementById('searchSuggestions');
                const searchInput = document.getElementById('advancedSearchInput');
                
                if (!searchInput.contains(event.target) && 
                    !suggestionsContainer.contains(event.target)) {
                    suggestionsContainer.classList.add('hidden');
                }
            });
        }

        // Open New Note
        function openNewNote() {
            // Switch to the dashboard view which has the note form
            showView('dashboard');
            
            // Clear any existing form data
            document.getElementById('quickTitle').value = '';
            document.getElementById('note').value = '';
            document.getElementById('tags').value = '';
            
            // Scroll to the form section
            const form = document.getElementById('quickCaptureForm');
            if (form) {
                form.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            
            // Focus on the title field
            setTimeout(() => {
                document.getElementById('quickTitle').focus();
            }, 300);
            
            // Show a success toast
            showToast('‚úèÔ∏è New note ready - start typing!', 'info', 2000);
        }

        // Quick Actions
        function showGlobalQuickActions() {
            document.getElementById('quickActionsModal').classList.remove('hidden');
            loadRecentActivityForQuickActions();
        }

        function hideGlobalQuickActions() {
            document.getElementById('quickActionsModal').classList.add('hidden');
        }
        
        async function loadRecentActivityForQuickActions() {
            const container = document.getElementById('recentActivityList');
            
            try {
                const response = await fetch('/api/recent-activity?limit=8');
                const data = await response.json();
                
                if (data.activities && data.activities.length > 0) {
                    container.innerHTML = data.activities.map(activity => `
                        <div class="flex items-center space-x-3 p-2 hover:bg-slate-700 hover:bg-opacity-30 rounded-lg cursor-pointer transition-colors" onclick="openActivity('${activity.type}', ${activity.id || 'null'})">
                            <div class="w-8 h-8 bg-slate-600 rounded-lg flex items-center justify-center">
                                <span class="text-sm">${activity.icon}</span>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="text-sm font-medium text-white truncate">${activity.title}</div>
                                <div class="text-xs text-slate-400 truncate">${activity.description}</div>
                            </div>
                            <div class="text-xs text-slate-500">${formatTimeAgo(activity.timestamp)}</div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = `
                        <div class="text-slate-400 text-sm text-center py-4">
                            <div class="text-2xl mb-2">üéØ</div>
                            <div>No recent activity</div>
                            <div class="text-xs text-slate-500 mt-1">Start creating notes and content!</div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Failed to load recent activity:', error);
                container.innerHTML = `
                    <div class="text-slate-400 text-sm text-center py-4">
                        <div class="text-xl mb-2">‚ö†Ô∏è</div>
                        <div>Failed to load activity</div>
                    </div>
                `;
            }
        }
        
        function openActivity(type, id) {
            if (type === 'note' && id) {
                // Open note in the notes view
                hideGlobalQuickActions();
                showView('notes');
                // TODO: Focus on specific note
            } else if (type === 'discord') {
                // Open Discord view
                hideGlobalQuickActions();
                showView('discord');
            }
        }
        
        function formatTimeAgo(timestamp) {
            try {
                const date = new Date(timestamp);
                const now = new Date();
                const diffInSeconds = Math.floor((now - date) / 1000);
                
                if (diffInSeconds < 60) return 'now';
                if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m`;
                if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h`;
                if (diffInSeconds < 604800) return `${Math.floor(diffInSeconds / 86400)}d`;
                return date.toLocaleDateString();
            } catch {
                return timestamp;
            }
        }

        // File Upload Handling
        function handleDragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'copy';
        }

        function handleDragEnter(event) {
            event.preventDefault();
            const zone = document.getElementById('uploadZone');
            zone.classList.add('border-discord-400', 'bg-discord-50');
        }

        function handleDragLeave(event) {
            event.preventDefault();
            const zone = document.getElementById('uploadZone');
            if (!zone.contains(event.relatedTarget)) {
                zone.classList.remove('border-discord-400', 'bg-discord-50');
            }
        }

        function handleFileDrop(event) {
            event.preventDefault();
            const zone = document.getElementById('uploadZone');
            zone.classList.remove('border-discord-400', 'bg-discord-50');
            
            const files = Array.from(event.dataTransfer.files);
            console.log('Files dropped:', files);
            // TODO: Process files
        }

        function handleFileInput(event) {
            const files = Array.from(event.target.files);
            console.log('Files selected:', files);
            // TODO: Process files
        }

        // Enhanced Quick Note Saving
        async function saveQuickNote() {
            const title = document.getElementById('quickTitle').value;
            const content = document.getElementById('note').value;
            
            if (!content.trim()) {
                showToast('Please enter some content for your note', 'warning');
                document.getElementById('note').classList.add('error-shake');
                setTimeout(() => document.getElementById('note').classList.remove('error-shake'), 500);
                document.getElementById('note').focus();
                return;
            }
            
            if (!checkNetworkStatus()) {
                return;
            }
            
            showLoadingState('saveNoteBtn', 'Saving...');
            
            try {
                const response = await fetch('/api/notes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        title: title || 'Quick Note',
                        content: content,
                        source: 'dashboard'
                    })
                });
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const result = await response.json();
                
                // Success feedback
                showToast('Note saved successfully!', 'success');
                announceToScreenReader('Note saved successfully');
                
                // Clear form with animation
                document.getElementById('quickTitle').value = '';
                document.getElementById('note').value = '';
                
                // Refresh recent notes
                loadRecentNotes();
                
                // Also refresh Notes view if it's currently active
                if (currentView === 'notes') {
                    loadAllNotes();
                }
                
            } catch (error) {
                handleApiError(error, 'saveQuickNote');
            } finally {
                hideLoadingState('saveNoteBtn');
            }
        }

        // Keyboard Shortcuts
        document.addEventListener('keydown', function(e) {
            // Don't interfere with typing in inputs
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                return;
            }
            
            // ‚åòK or Ctrl+K for search
            if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
                e.preventDefault();
                document.getElementById('globalSearch').focus();
            }
            
            // ‚åòN or Ctrl+N for new note
            if ((e.metaKey || e.ctrlKey) && e.key === 'n') {
                e.preventDefault();
                openNewNote();
            }
            
            // ‚åòU or Ctrl+U for file upload
            if ((e.metaKey || e.ctrlKey) && e.key === 'u') {
                e.preventDefault();
                document.getElementById('fileInput').click();
            }
            
            // ‚åòShift+A for quick actions
            if ((e.metaKey || e.ctrlKey) && e.shiftKey && e.key === 'A') {
                e.preventDefault();
                showGlobalQuickActions();
            }
            
            // Escape to close modals
            if (e.key === 'Escape') {
                hideGlobalQuickActions();
                closeNoteDetails();
            }
        });

        // Initialize App
        document.addEventListener('DOMContentLoaded', async function() {
            // Initialize performance system first
            if (typeof DashboardPerformance !== 'undefined') {
                window.dashboardPerformance = new DashboardPerformance();
            }
            
            // Initialize content management system
            if (typeof ContentManager !== 'undefined') {
                window.contentManager = new ContentManager(window.dashboardPerformance);
            }
            
            // Initialize network monitoring
            window.addEventListener('online', () => {
                showToast('Connection restored', 'success', 3000);
            });
            
            window.addEventListener('offline', () => {
                showToast('Connection lost. You\'re now offline.', 'warning', 6000);
            });
            
            // Set up responsive sidebar
            function handleResize() {
                if (window.innerWidth >= 1024) {
                    document.getElementById('sidebar').classList.remove('-translate-x-full');
                    sidebarOpen = true;
                } else {
                    document.getElementById('sidebar').classList.add('-translate-x-full');
                    sidebarOpen = false;
                }
            }
            
            window.addEventListener('resize', handleResize);
            handleResize(); // Initial call
            
            // Load initial data and update UI
            updateDynamicGreeting();
            loadRecentNotes();
            loadSidebarActivity();
            loadTodaysActivity();
            loadProgressData();
            
            // Initialize Audio Recorder with secure-context guard to avoid noisy errors on remote/IP access
            try {
                const recordBtn = document.querySelector('[onclick="toggleRecording()"]');
                if (!window.isSecureContext) {
                    console.warn('üé§ Main: Insecure context; audio recording disabled until HTTPS/localhost');
                    showMicrophoneBanner('Recording requires HTTPS or localhost. If using Tailscale, enable Serve/Funnel HTTPS.');
                    if (recordBtn) {
                        recordBtn.disabled = true;
                        recordBtn.classList.add('opacity-50', 'cursor-not-allowed');
                        recordBtn.title = 'Requires HTTPS or localhost to record';
                    }
                } else {
                    console.log('üé§ Main: Initializing AudioRecorder...');
                    window.audioRecorder = new AudioRecorder();
                    console.log('üé§ Main: AudioRecorder constructor completed');
                    
                    // Wait for initialization to complete
                    if (window.audioRecorder.initializationPromise) {
                        console.log('üé§ Main: Waiting for AudioRecorder initialization...');
                        try {
                            await window.audioRecorder.initializationPromise;
                            console.log('üé§ Main: AudioRecorder initialization completed successfully');
                            // Enable record button once initialization is complete
                            if (recordBtn) {
                                recordBtn.disabled = false;
                                recordBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                                recordBtn.title = 'Click to start recording';
                            }
                        } catch (initError) {
                            console.error('üé§ Main: AudioRecorder initialization failed:', initError);
                            showToast('Audio recording setup failed. Check microphone permissions.', 'error', 5000);
                            if (recordBtn) {
                                recordBtn.disabled = true;
                                recordBtn.classList.add('opacity-50', 'cursor-not-allowed');
                                recordBtn.title = 'Audio recording unavailable';
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('üé§ Main: Failed to initialize audio recorder:', error);
                showToast('Audio recording setup failed. Voice notes may not work properly.', 'warning', 5000);
            }
            
            // Update greeting every 30 minutes to keep it fresh
            setInterval(updateDynamicGreeting, 30 * 60 * 1000);
            
            // Initialize Notes view event listeners
            initializeNotesViewEventListeners();
        });

        // Data Loading Functions
        async function loadRecentNotes() {
            try {
                const response = await fetch('/api/notes/recent?limit=10', {
                    credentials: 'include'
                });
                if (!response.ok) throw new Error('Failed to fetch recent notes');
                
                const notes = await response.json();
                const container = document.getElementById('recentNotes');
                const countElement = document.getElementById('notes-count');
                
                // Update count
                if (countElement) {
                    countElement.textContent = notes.length;
                }
                
                if (notes.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-slate-400 py-8">
                            <svg class="h-12 w-12 mx-auto mb-4 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <p class="text-sm">No notes yet</p>
                            <p class="text-xs text-slate-500 mt-1">Create your first note to get started</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = notes.map(note => {
                    const timeAgo = formatTimeAgo(note.timestamp || note.created_at || note.updated_at);
                    const truncatedContent = (note.content || note.summary || '').substring(0, 100) + '...';
                    const tags = note.tags || [];
                    const isFavorite = note.favorite || false;
                    
                    return `
                        <div class="note-card group relative p-4 hover:bg-slate-50 rounded-lg cursor-pointer transition-all duration-200 border border-slate-200 hover:border-discord-300 hover:shadow-md" 
                             data-note-id="${note.id}" 
                             draggable="true">
                            
                            <!-- Selection Checkbox (Hidden by default) -->
                            <div class="absolute top-2 left-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                <input type="checkbox" data-note-checkbox value="${note.id}" class="rounded border-slate-300">
                            </div>
                            
                            <!-- Note Content -->
                            <div class="ml-6">
                                <!-- Header with title and actions -->
                                <div class="flex items-start justify-between mb-2">
                                    <h4 class="font-medium text-slate-900 text-sm leading-tight pr-2 cursor-pointer" 
                                        data-note-title
                                        onclick="event.stopPropagation(); contentManager?.openNote('${note.id}')">
                                        ${note.title || 'Untitled Note'}
                                    </h4>
                                    
                                    <!-- Quick Actions -->
                                    <div class="flex items-center space-x-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                        ${isFavorite ? `
                                            <button data-note-action="favorite" class="p-1 text-yellow-500 hover:text-yellow-600" title="Remove from favorites">
                                                <svg class="h-3 w-3 fill-current" viewBox="0 0 24 24">
                                                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                                                </svg>
                                            </button>
                                        ` : `
                                            <button data-note-action="favorite" class="p-1 text-slate-400 hover:text-yellow-500" title="Add to favorites">
                                                <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                                                </svg>
                                            </button>
                                        `}
                                        
                                        <button data-note-action="edit" class="p-1 text-slate-400 hover:text-discord-500" title="Edit note">
                                            <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                            </svg>
                                        </button>
                                        
                                        <div class="relative">
                                            <button class="note-menu-toggle p-1 text-slate-400 hover:text-slate-600" title="More actions">
                                                <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"></path>
                                                </svg>
                                            </button>
                                            
                                            <!-- Dropdown Menu -->
                                            <div class="note-menu absolute right-0 top-full mt-1 bg-white border border-slate-300 rounded-lg shadow-lg py-1 z-20 hidden min-w-32">
                                                <button data-note-action="duplicate" class="block w-full text-left px-3 py-1 text-xs text-slate-700 hover:bg-slate-100">Duplicate</button>
                                                <button data-note-action="tag" class="block w-full text-left px-3 py-1 text-xs text-slate-700 hover:bg-slate-100">Add Tags</button>
                                                <button data-note-action="archive" class="block w-full text-left px-3 py-1 text-xs text-slate-700 hover:bg-slate-100">Archive</button>
                                                <hr class="my-1">
                                                <button data-note-action="export" class="block w-full text-left px-3 py-1 text-xs text-slate-700 hover:bg-slate-100">Export</button>
                                                <button data-note-action="share" class="block w-full text-left px-3 py-1 text-xs text-slate-700 hover:bg-slate-100">Share</button>
                                                <hr class="my-1">
                                                <button data-note-action="delete" class="block w-full text-left px-3 py-1 text-xs text-red-600 hover:bg-red-50">Delete</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Content Preview -->
                                <div class="text-xs text-slate-600 line-clamp-2 mb-2 cursor-pointer" 
                                     data-note-content
                                     onclick="event.stopPropagation(); contentManager?.openNote('${note.id}')">
                                    ${truncatedContent}
                                </div>
                                
                                <!-- Tags and Metadata -->
                                <div class="flex items-center justify-between text-xs">
                                    <div class="flex items-center space-x-2">
                                        ${tags.length > 0 ? `
                                            <div class="flex items-center space-x-1">
                                                ${tags.slice(0, 3).map(tag => `
                                                    <span class="px-2 py-1 bg-slate-200 text-slate-600 rounded text-xs">${tag}</span>
                                                `).join('')}
                                                ${tags.length > 3 ? `<span class="text-slate-500">+${tags.length - 3}</span>` : ''}
                                            </div>
                                        ` : ''}
                                    </div>
                                    
                                    <div class="flex items-center space-x-2 text-slate-400">
                                        ${note.type ? `<span class="capitalize">${note.type}</span>` : ''}
                                        <span>${timeAgo}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Initialize note card interactions
                initializeNoteCardInteractions();
                
            } catch (error) {
                console.error('Error loading recent notes:', error);
                document.getElementById('recentNotes').innerHTML = 
                    '<div class="text-center text-red-400 py-4">Failed to load recent notes</div>';
            }
        }

        function initializeNoteCardInteractions() {
            // Toggle note menus
            document.querySelectorAll('.note-menu-toggle').forEach(toggle => {
                toggle.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const menu = toggle.parentElement.querySelector('.note-menu');
                    
                    // Close all other menus
                    document.querySelectorAll('.note-menu').forEach(m => {
                        if (m !== menu) m.classList.add('hidden');
                    });
                    
                    // Toggle current menu
                    menu.classList.toggle('hidden');
                });
            });
            
            // Close menus when clicking outside
            document.addEventListener('click', () => {
                document.querySelectorAll('.note-menu').forEach(menu => {
                    menu.classList.add('hidden');
                });
            });
            
            // Show selection checkboxes on any checkbox interaction
            document.querySelectorAll('input[data-note-checkbox]').forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    const bulkBar = document.getElementById('bulk-selection-bar');
                    const anyChecked = document.querySelectorAll('input[data-note-checkbox]:checked').length > 0;
                    
                    if (anyChecked) {
                        bulkBar.classList.remove('hidden');
                        // Show all checkboxes
                        document.querySelectorAll('input[data-note-checkbox]').forEach(cb => {
                            cb.parentElement.classList.remove('opacity-0', 'group-hover:opacity-100');
                            cb.parentElement.classList.add('opacity-100');
                        });
                    } else {
                        bulkBar.classList.add('hidden');
                        // Hide checkboxes again
                        document.querySelectorAll('input[data-note-checkbox]').forEach(cb => {
                            cb.parentElement.classList.add('opacity-0', 'group-hover:opacity-100');
                            cb.parentElement.classList.remove('opacity-100');
                        });
                    }
                    
                    // Update selection count
                    const count = document.querySelectorAll('input[data-note-checkbox]:checked').length;
                    const countElement = document.getElementById('selection-count');
                    if (countElement) {
                        countElement.textContent = `(${count} selected)`;
                    }
                });
            });
        }

        async function loadSidebarActivity() {
            try {
                const response = await fetch('/api/recent-activity');
                if (!response.ok) throw new Error('Failed to fetch activity');
                
                const data = await response.json();
                const activities = data.activities || [];
                const container = document.getElementById('sidebarActivity');
                
                if (activities.length === 0) {
                    container.innerHTML = '<div class="px-3 py-2 text-xs text-slate-400">No recent activity</div>';
                    return;
                }
                
                container.innerHTML = activities.slice(0, 5).map(activity => {
                    const timeAgo = formatTimeAgo(activity.timestamp);
                    let icon = activity.icon || "üìù";
                    
                    // Use existing icon from API or fallback based on type
                    if (!activity.icon) {
                        if (activity.type === 'discord') icon = "ü§ñ";
                        else if (activity.type === 'note' && activity.description?.includes('audio')) icon = "üéµ";
                        else if (activity.type === 'note' && activity.description?.includes('file')) icon = "üìÅ";
                        else icon = "üìù";
                    }
                    
                    return `
                        <div class="px-3 py-2 hover:bg-slate-100 rounded-lg transition-colors cursor-pointer">
                            <div class="flex items-center space-x-3">
                                <span class="text-sm">${icon}</span>
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm font-medium text-slate-700 truncate">${activity.title}</p>
                                    <p class="text-xs text-slate-500">${timeAgo}</p>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading sidebar activity:', error);
                document.getElementById('sidebarActivity').innerHTML = 
                    '<div class="px-3 py-2 text-xs text-red-400">Failed to load activity</div>';
            }
        }

        async function loadTodaysActivity() {
            try {
                const response = await fetch('/api/analytics');
                if (!response.ok) throw new Error('Failed to fetch analytics');
                
                const analytics = await response.json();
                
                // Update the Today's Activity display
                document.getElementById('notesCreated').textContent = analytics.this_week || 0;
                document.getElementById('filesProcessed').textContent = analytics.total_notes || 0;
                document.getElementById('searchQueries').textContent = '12'; // Placeholder until we have search analytics
                
                // Calculate simple productivity score based on this week's activity
                const productivity = Math.min(100, Math.max(0, (analytics.this_week || 0) * 15));
                document.getElementById('productivityScore').textContent = productivity + '%';
                
            } catch (error) {
                console.error('Error loading today\'s activity:', error);
                document.getElementById('notesCreated').textContent = '?';
                document.getElementById('filesProcessed').textContent = '?';
                document.getElementById('searchQueries').textContent = '?';
                document.getElementById('productivityScore').textContent = '?';
            }
        }

        async function loadProgressData() {
            try {
                const response = await fetch('/api/analytics');
                if (!response.ok) throw new Error('Failed to fetch progress data');
                
                const analytics = await response.json();
                
                // Calculate meaningful progress based on user activity
                const totalNotes = analytics.total_notes || 0;
                const thisWeekNotes = analytics.this_week || 0;
                
                let progress = 0;
                let label = "Getting Started";
                
                // Progress calculation based on total notes and recent activity
                if (totalNotes === 0) {
                    progress = 0;
                    label = "Ready to Begin";
                } else if (totalNotes < 5) {
                    progress = Math.min(20, totalNotes * 4);
                    label = "Getting Started";
                } else if (totalNotes < 20) {
                    progress = 20 + Math.min(30, (totalNotes - 5) * 2);
                    label = "Building Knowledge";
                } else if (totalNotes < 50) {
                    progress = 50 + Math.min(25, (totalNotes - 20) * 0.8);
                    label = "Growing Library";
                } else {
                    progress = 75 + Math.min(25, thisWeekNotes * 2.5);
                    label = "Knowledge Master";
                }
                
                // Ensure progress stays within 0-100%
                progress = Math.min(100, Math.max(0, Math.round(progress)));
                
                // Update UI
                document.getElementById('progressBar').style.width = progress + '%';
                document.getElementById('progressPercentage').textContent = progress + '%';
                document.getElementById('progressLabel').textContent = label;
                
                // Update dashboard stats cards with real data
                updateDashboardStats(analytics);
                
            } catch (error) {
                console.error('Error loading progress data:', error);
                // Fallback to default state
                document.getElementById('progressBar').style.width = '0%';
                document.getElementById('progressPercentage').textContent = '0%';
                document.getElementById('progressLabel').textContent = 'Progress Unavailable';
            }
        }

        // Update dashboard stats cards with real analytics data
        function updateDashboardStats(analytics) {
            // Get note type counts from analytics
            const byType = analytics.by_type || [];
            const totalNotes = analytics.total_notes || 0;
            const thisWeek = analytics.this_week || 0;

            // Calculate counts by type
            let audioCount = 0;
            let textCount = 0;
            let fileCount = 0;
            let webCount = 0;

            byType.forEach(item => {
                switch(item.type) {
                    case 'audio':
                        audioCount = item.count;
                        break;
                    case 'text':
                        textCount = item.count;
                        break;
                    case 'file':
                        fileCount = item.count;
                        break;
                    case 'web':
                        webCount = item.count;
                        break;
                }
            });

            // Update Total Notes card
            const totalNotesElement = document.querySelector('[onclick="filterNotesByType(\'all\')"] .text-4xl');
            const totalNotesWeekElement = document.querySelector('[onclick="filterNotesByType(\'all\')"] .text-green-600');
            if (totalNotesElement) totalNotesElement.textContent = totalNotes;
            if (totalNotesWeekElement) totalNotesWeekElement.textContent = `+${thisWeek} this week`;

            // Update Audio Notes card
            const audioNotesElement = document.querySelector('[onclick="filterNotesByType(\'audio\')"] .text-4xl');
            const audioPendingElement = document.querySelector('[onclick="filterNotesByType(\'audio\')"] .text-amber-600');
            if (audioNotesElement) audioNotesElement.textContent = audioCount;
            // For pending count, we'll keep it simple for now
            if (audioPendingElement) audioPendingElement.textContent = '+0 pending';

            // Update other stat cards if they exist
            // Note: The current HTML only shows Total Notes and Audio Notes cards
            // but the infrastructure is here for additional cards
        }

        async function refreshDashboardData() {
            // Show loading state
            const refreshBtn = document.getElementById('refreshBtn');
            if (refreshBtn) {
                refreshBtn.textContent = '‚Üª';
                refreshBtn.disabled = true;
            }

            try {
                // Update greeting and refresh all data in parallel
                updateDynamicGreeting();
                await Promise.all([
                    loadRecentNotes(),
                    loadAllNotes(),
                    loadSidebarActivity(),
                    loadTodaysActivity(),
                    loadProgressData(),
                    // Refresh analytics if analytics view is currently visible (silent mode to avoid error toasts)
                    document.getElementById('analytics-view')?.style.display !== 'none' ? loadAnalytics(true) : Promise.resolve()
                ]);

                console.log('Dashboard data refreshed successfully');
            } catch (error) {
                console.error('Error refreshing dashboard data:', error);
            } finally {
                // Reset refresh button
                if (refreshBtn) {
                    refreshBtn.textContent = '‚Üª';
                    refreshBtn.disabled = false;
                }
            }
        }

        function updateDynamicGreeting() {
            const now = new Date();
            const hour = now.getHours();
            const day = now.getDay();
            const date = now.getDate();
            
            let greeting = "";
            let emoji = "üëã";
            
            // Time-based greetings
            if (hour >= 5 && hour < 12) {
                const morningGreetings = [
                    "Good morning", "Rise and shine", "Morning", "Start your day", 
                    "Fresh start", "New day ahead", "Morning productivity"
                ];
                greeting = morningGreetings[Math.floor(Math.random() * morningGreetings.length)];
                emoji = ["üåÖ", "‚òÄÔ∏è", "üåû", "‚≠ê", "üöÄ"][Math.floor(Math.random() * 5)];
            } else if (hour >= 12 && hour < 17) {
                const afternoonGreetings = [
                    "Good afternoon", "Afternoon focus", "Midday momentum", "Keep going", 
                    "Afternoon energy", "Stay productive", "Power through"
                ];
                greeting = afternoonGreetings[Math.floor(Math.random() * afternoonGreetings.length)];
                emoji = ["üå§Ô∏è", "üí™", "‚ö°", "üéØ", "üî•"][Math.floor(Math.random() * 5)];
            } else if (hour >= 17 && hour < 22) {
                const eveningGreetings = [
                    "Good evening", "Evening reflection", "Winding down", "Review time", 
                    "Evening notes", "Wrap up", "End strong"
                ];
                greeting = eveningGreetings[Math.floor(Math.random() * eveningGreetings.length)];
                emoji = ["üåÜ", "üåô", "üí≠", "üìù", "üéì"][Math.floor(Math.random() * 5)];
            } else {
                const lateGreetings = [
                    "Working late", "Night owl", "Burning midnight oil", "Late night thoughts", 
                    "After hours", "Night session", "Deep work time"
                ];
                greeting = lateGreetings[Math.floor(Math.random() * lateGreetings.length)];
                emoji = ["ü¶â", "üåô", "‚≠ê", "üí°", "üîÆ"][Math.floor(Math.random() * 5)];
            }
            
            // Special day-based additions
            const specialGreetings = [];
            if (day === 1) specialGreetings.push("Monday momentum");
            if (day === 5) specialGreetings.push("Friday focus");
            if (day === 6 || day === 0) specialGreetings.push("Weekend warrior");
            if (date === 1) specialGreetings.push("Fresh month");
            
            // Occasionally use special greetings
            if (specialGreetings.length > 0 && Math.random() < 0.3) {
                greeting = specialGreetings[Math.floor(Math.random() * specialGreetings.length)];
            }
            
            document.getElementById('dynamicGreeting').innerHTML = `${greeting}! ${emoji}`;
        }

        // Voice Recording Functions
        function showVoiceRecordingModal() {
            console.log('üé§ DEBUG: showVoiceRecordingModal called');
            
            try {
                console.log('üé§ DEBUG: Hiding quick actions...');
                hideGlobalQuickActions(); // Hide quick actions first
                
                console.log('üé§ DEBUG: Finding voice recording modal...');
                const modal = document.getElementById('voiceRecordingModal');
                if (!modal) {
                    console.error('üé§ DEBUG: voiceRecordingModal element not found!');
                    return;
                }
                console.log('üé§ DEBUG: Modal found, removing hidden class...');
                modal.classList.remove('hidden');
                
                console.log('üé§ DEBUG: Checking audioRecorder...');
                if (window.audioRecorder) {
                    console.log('üé§ DEBUG: AudioRecorder found, calling resetUI...');
                    if (typeof window.audioRecorder.resetUI === 'function') {
                        window.audioRecorder.resetUI();
                    } else {
                        console.warn('üé§ DEBUG: resetUI method not found on audioRecorder');
                    }
                } else {
                    console.warn('üé§ DEBUG: window.audioRecorder not found');
                }
                
                console.log('üé§ DEBUG: Ensuring microphone permission...');
                // Ensure we surface permission guidance when opening the recorder
                if (typeof ensureMicrophonePermission === 'function') {
                    ensureMicrophonePermission();
                } else {
                    console.warn('üé§ DEBUG: ensureMicrophonePermission function not found');
                }
                
                console.log('üé§ DEBUG: showVoiceRecordingModal completed successfully');
            } catch (error) {
                console.error('üé§ DEBUG: Error in showVoiceRecordingModal:', error);
            }
        }

        function hideVoiceRecordingModal() {
            document.getElementById('voiceRecordingModal').classList.add('hidden');
            if (window.audioRecorder) {
                window.audioRecorder.stopRecording();
            }
        }

        async function toggleRecording() {
            console.log('üé§ Global: toggleRecording called');
            if (!window.audioRecorder) {
                console.error('üé§ Global: audioRecorder not initialized');
                showToast('Audio recorder not ready. Please refresh the page.', 'error', 3000);
                return;
            }
            
            // If initialization is still in progress, wait for it
            if (!window.audioRecorder.initializationComplete && window.audioRecorder.initializationPromise) {
                console.log('üé§ Global: Waiting for initialization to complete before recording...');
                showToast('Please wait, setting up audio recorder...', 'info', 2000);
                try {
                    await window.audioRecorder.initializationPromise;
                    console.log('üé§ Global: Initialization complete, proceeding with recording');
                } catch (initError) {
                    console.error('üé§ Global: Initialization failed:', initError);
                    showToast('Audio recorder setup failed. Check console for details.', 'error', 4000);
                    return;
                }
            }
            
            // Proceed with recording
            await window.audioRecorder.toggleRecording();
        }

        function stopRecording() {
            if (window.audioRecorder) {
                window.audioRecorder.stopRecording();
            }
        }

        // ===============================
        // Advanced Search Modal Functions
        // ===============================

        // Advanced Search state management
        const advancedSearchState = {
            query: '',
            dateRange: 'all',
            contentTypes: ['all'],
            tags: [],
            status: 'all',
            debounceTimer: null
        };

        // Show Advanced Search Modal
        function showAdvancedSearchModal() {
            const modal = document.getElementById('advancedSearchModal');
            if (!modal) {
                console.error('advancedSearchModal element not found!');
                return;
            }

            // Hide quick actions if they're showing
            if (typeof hideGlobalQuickActions === 'function') {
                hideGlobalQuickActions();
            }

            // Show modal
            modal.classList.remove('hidden');

            // Focus on search input
            setTimeout(() => {
                const searchInput = document.getElementById('advancedSearchInput');
                if (searchInput) {
                    searchInput.focus();
                }
            }, 100);

            // Set platform-specific keyboard shortcut
            const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
            const shortcutDisplay = document.getElementById('keyboardShortcut');
            if (shortcutDisplay) {
                shortcutDisplay.textContent = isMac ? 'Cmd+K' : 'Ctrl+K';
            }
        }

        // Hide Advanced Search Modal
        function hideAdvancedSearchModal() {
            const modal = document.getElementById('advancedSearchModal');
            if (modal) {
                modal.classList.add('hidden');
            }

            // Clear search input
            const searchInput = document.getElementById('advancedSearchInput');
            if (searchInput) {
                searchInput.value = '';
            }

            // Reset search state
            advancedSearchState.query = '';

            // Clear results placeholder (will be replaced in Phase 2)
            const resultsContainer = document.getElementById('advancedSearchResults');
            if (resultsContainer) {
                resultsContainer.innerHTML = `
                    <svg class="w-16 h-16 mx-auto mb-4 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    <p class="text-lg font-medium mb-2">Start typing to search</p>
                    <p class="text-sm text-slate-500">Search results will appear here</p>
                `;
            }
        }

        // Handle search input with debouncing
        function handleAdvancedSearchInput(event) {
            const query = event.target.value.trim();
            advancedSearchState.query = query;

            // Clear existing debounce timer
            if (advancedSearchState.debounceTimer) {
                clearTimeout(advancedSearchState.debounceTimer);
            }

            // Debounce search execution by 300ms
            advancedSearchState.debounceTimer = setTimeout(() => {
                performAdvancedSearch();
            }, 300);
        }

        // Set date filter
        function setDateFilter(range) {
            advancedSearchState.dateRange = range;

            // Update button styles
            document.querySelectorAll('.date-filter-btn').forEach(btn => {
                btn.classList.remove('bg-indigo-500', 'text-white');
                btn.classList.add('bg-slate-700', 'text-slate-300');
            });

            const activeBtn = document.getElementById(`dateFilter${range.charAt(0).toUpperCase() + range.slice(1)}`);
            if (activeBtn) {
                activeBtn.classList.remove('bg-slate-700', 'text-slate-300');
                activeBtn.classList.add('bg-indigo-500', 'text-white');
            }

            updateSearchFilters();
        }

        // Toggle content type filter
        function toggleTypeFilter(type) {
            // If clicking "all", reset to just "all"
            if (type === 'all') {
                advancedSearchState.contentTypes = ['all'];
            } else {
                // Remove "all" if present
                const allIndex = advancedSearchState.contentTypes.indexOf('all');
                if (allIndex !== -1) {
                    advancedSearchState.contentTypes.splice(allIndex, 1);
                }

                // Toggle the selected type
                const typeIndex = advancedSearchState.contentTypes.indexOf(type);
                if (typeIndex === -1) {
                    advancedSearchState.contentTypes.push(type);
                } else {
                    advancedSearchState.contentTypes.splice(typeIndex, 1);
                }

                // If no types selected, default to "all"
                if (advancedSearchState.contentTypes.length === 0) {
                    advancedSearchState.contentTypes = ['all'];
                }
            }

            // Update button styles
            document.querySelectorAll('.type-filter-btn').forEach(btn => {
                const btnType = btn.id.replace('typeFilter', '').toLowerCase();
                if (advancedSearchState.contentTypes.includes(btnType)) {
                    btn.classList.remove('bg-slate-700', 'text-slate-300');
                    btn.classList.add('bg-indigo-500', 'text-white');
                } else {
                    btn.classList.remove('bg-indigo-500', 'text-white');
                    btn.classList.add('bg-slate-700', 'text-slate-300');
                }
            });

            updateSearchFilters();
        }

        // Handle tag filter input
        function handleTagFilterInput(event) {
            const tagQuery = event.target.value.trim();

            // Clear existing tags and add new one if not empty
            if (tagQuery) {
                advancedSearchState.tags = [tagQuery];
            } else {
                advancedSearchState.tags = [];
            }

            // Debounce the filter update
            if (advancedSearchState.debounceTimer) {
                clearTimeout(advancedSearchState.debounceTimer);
            }

            advancedSearchState.debounceTimer = setTimeout(() => {
                updateSearchFilters();
            }, 300);
        }

        // Update search filters and trigger search
        function updateSearchFilters() {
            // Update status from dropdown
            const statusFilter = document.getElementById('statusFilter');
            if (statusFilter) {
                advancedSearchState.status = statusFilter.value;
            }

            // Show/hide clear filters button
            const hasActiveFilters =
                advancedSearchState.dateRange !== 'all' ||
                !advancedSearchState.contentTypes.includes('all') ||
                advancedSearchState.tags.length > 0 ||
                advancedSearchState.status !== 'all';

            const clearBtn = document.getElementById('clearFiltersBtn');
            if (clearBtn) {
                if (hasActiveFilters) {
                    clearBtn.classList.remove('hidden');
                } else {
                    clearBtn.classList.add('hidden');
                }
            }

            // Update active filters display
            updateActiveFiltersDisplay();

            // Trigger search
            performAdvancedSearch();
        }

        // Update active filters display
        function updateActiveFiltersDisplay() {
            const display = document.getElementById('activeFiltersDisplay');
            const tagsContainer = document.getElementById('activeFilterTags');

            if (!display || !tagsContainer) return;

            const filterTags = [];

            // Add date filter tag
            if (advancedSearchState.dateRange !== 'all') {
                filterTags.push({
                    label: `Date: ${advancedSearchState.dateRange}`,
                    type: 'date'
                });
            }

            // Add content type tags
            if (!advancedSearchState.contentTypes.includes('all')) {
                advancedSearchState.contentTypes.forEach(type => {
                    filterTags.push({
                        label: `Type: ${type}`,
                        type: 'contentType'
                    });
                });
            }

            // Add tag filters
            advancedSearchState.tags.forEach(tag => {
                filterTags.push({
                    label: `Tag: ${tag}`,
                    type: 'tag'
                });
            });

            // Add status filter
            if (advancedSearchState.status !== 'all') {
                filterTags.push({
                    label: `Status: ${advancedSearchState.status}`,
                    type: 'status'
                });
            }

            // Update display
            if (filterTags.length > 0) {
                tagsContainer.innerHTML = filterTags.map(filter => `
                    <span class="inline-flex items-center px-2 py-1 bg-indigo-500 bg-opacity-20 text-indigo-300 text-xs rounded-lg">
                        ${filter.label}
                    </span>
                `).join('');
                display.classList.remove('hidden');
            } else {
                display.classList.add('hidden');
            }
        }

        // Clear all filters
        function clearAllFilters() {
            // Reset state
            advancedSearchState.dateRange = 'all';
            advancedSearchState.contentTypes = ['all'];
            advancedSearchState.tags = [];
            advancedSearchState.status = 'all';

            // Reset UI elements
            document.getElementById('tagFilterInput').value = '';
            document.getElementById('statusFilter').value = 'all';

            // Reset date filter buttons
            setDateFilter('all');

            // Reset type filter buttons
            document.querySelectorAll('.type-filter-btn').forEach(btn => {
                btn.classList.remove('bg-indigo-500', 'text-white');
                btn.classList.add('bg-slate-700', 'text-slate-300');
            });
            document.getElementById('typeFilterAll').classList.remove('bg-slate-700', 'text-slate-300');
            document.getElementById('typeFilterAll').classList.add('bg-indigo-500', 'text-white');

            // Update display
            updateSearchFilters();
        }

        // Perform advanced search (placeholder for Phase 2)
        function performAdvancedSearch() {
            console.log('Performing advanced search with state:', advancedSearchState);

            // Placeholder: Just log the search state for now
            // In Phase 2, this will make an API call to /api/search with the filters

            const resultsContainer = document.getElementById('advancedSearchResults');
            if (!resultsContainer) return;

            if (advancedSearchState.query.length > 0) {
                resultsContainer.innerHTML = `
                    <div class="text-center text-slate-400 py-12">
                        <div class="animate-spin w-8 h-8 border-4 border-indigo-500 border-t-transparent rounded-full mx-auto mb-4"></div>
                        <p class="text-sm">Searching for "${advancedSearchState.query}"...</p>
                        <p class="text-xs text-slate-500 mt-2">Results will be displayed in Phase 2</p>
                    </div>
                `;
            } else {
                resultsContainer.innerHTML = `
                    <svg class="w-16 h-16 mx-auto mb-4 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    <p class="text-lg font-medium mb-2">Start typing to search</p>
                    <p class="text-sm text-slate-500">Search results will appear here</p>
                `;
            }
        }

        // Keyboard shortcut listener for Ctrl+K or Cmd+K
        // ===============================
        // Global Keyboard Shortcuts
        // ===============================
        document.addEventListener('keydown', function(event) {
            // Don't interfere with typing in inputs/textareas (except for Escape and specific shortcuts)
            const isTyping = (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA');
            const isModifierKey = event.ctrlKey || event.metaKey || event.altKey;

            // Escape key - always works
            if (event.key === 'Escape') {
                event.preventDefault();
                // Close note details modal if open
                const noteModal = document.getElementById('noteDetailsModal');
                if (noteModal && !noteModal.classList.contains('hidden')) {
                    closeNoteDetails();
                    return;
                }
                // Close voice recording modal if open
                const voiceModal = document.getElementById('voiceRecordingModal');
                if (voiceModal && !voiceModal.classList.contains('hidden')) {
                    hideVoiceRecordingModal();
                    return;
                }
                // Close advanced search if open
                const searchModal = document.getElementById('advancedSearchModal');
                if (searchModal && !searchModal.classList.contains('hidden')) {
                    hideAdvancedSearchModal();
                    return;
                }
                return;
            }

            // ? key - Show keyboard shortcuts help (when not typing)
            if (event.key === '?' && !isTyping && !event.shiftKey) {
                event.preventDefault();
                showKeyboardShortcutsHelp();
                return;
            }

            // Ctrl/Cmd + K - Quick search
            if ((event.ctrlKey || event.metaKey) && event.key === 'k') {
                event.preventDefault();
                showAdvancedSearchModal();
                return;
            }

            // Ctrl/Cmd + N - New note (when not typing)
            if ((event.ctrlKey || event.metaKey) && event.key === 'n' && !isTyping) {
                event.preventDefault();
                showQuickNoteModal();
                return;
            }

            // Ctrl/Cmd + S - Save note (when editing)
            if ((event.ctrlKey || event.metaKey) && event.key === 's') {
                event.preventDefault();
                if (window.noteEditMode) {
                    saveNoteEdits();
                }
                return;
            }

            // Ctrl/Cmd + E - Toggle edit mode (when viewing note)
            if ((event.ctrlKey || event.metaKey) && event.key === 'e' && !isTyping) {
                event.preventDefault();
                const noteModal = document.getElementById('noteDetailsModal');
                if (noteModal && !noteModal.classList.contains('hidden') && currentEditingNote) {
                    if (window.noteEditMode) {
                        exitEditMode();
                    } else {
                        enterEditMode();
                    }
                }
                return;
            }

            // Ctrl/Cmd + Delete - Delete current note (when viewing)
            if ((event.ctrlKey || event.metaKey) && (event.key === 'Delete' || event.key === 'Backspace') && !isTyping) {
                event.preventDefault();
                const noteModal = document.getElementById('noteDetailsModal');
                if (noteModal && !noteModal.classList.contains('hidden') && currentEditingNote) {
                    confirmDeleteNote();
                }
                return;
            }

            // Ctrl/Cmd + R - Refresh dashboard
            if ((event.ctrlKey || event.metaKey) && event.key === 'r' && !isTyping) {
                event.preventDefault();
                refreshDashboardData();
                showToast('Dashboard refreshed', 'info', 2000);
                return;
            }
        });

        // Show keyboard shortcuts help overlay
        function showKeyboardShortcutsHelp() {
            showToast('Keyboard Shortcuts: Ctrl+N=New, Ctrl+K=Search, Ctrl+S=Save, Ctrl+E=Edit, Esc=Close, ?=Help', 'info', 8000);
        }

        // ===============================
        // Notes Management Functions
        // ===============================

        let currentNotesFilter = 'all';
        let currentNotesView = 'list';
        let currentNotesSort = 'newest';
        let allNotes = [];
        let filteredNotes = [];

        // Filter notes by type and navigate to Notes view
        function filterNotesByType(type) {
            showView('notes');
            setTimeout(() => filterNotes(type), 100);
        }

        // Load all notes from the API
        async function loadAllNotes() {
            try {
                const response = await fetch('/api/notes?limit=1000', {
                    credentials: 'include'
                });
                
                if (!response.ok) throw new Error('Failed to fetch notes');
                
                allNotes = await response.json();
                console.log('üìù Loaded notes:', allNotes.length, 'notes');
                console.log('üìù Sample note:', allNotes[0]);
                updateNoteCounts();
                filterNotes(currentNotesFilter);
                
            } catch (error) {
                console.error('Error loading notes:', error);
                showToast('Failed to load notes', 'error', 3000);
            }
        }

        // Update note counts in filter tabs
        function updateNoteCounts() {
            const counts = {
                all: allNotes.length,
                text: allNotes.filter(n => {
                    const type = (n.type || '').toLowerCase();
                    const hasAudio = n.audio_filename || type === 'audio';
                    const hasFile = n.file_filename && n.file_type !== 'image';
                    const hasImage = n.file_type === 'image' || type === 'image';
                    const hasWebSource = n.source_url;
                    // Text notes are notes that don't have audio, files, images, or web sources
                    return !hasAudio && !hasFile && !hasImage && !hasWebSource;
                }).length,
                audio: allNotes.filter(n => n.type === 'audio' || n.audio_filename).length,
                file: allNotes.filter(n => n.file_filename && n.file_type && n.file_type !== 'image').length,
                image: allNotes.filter(n => n.file_type === 'image' || n.type === 'image').length,
                web: allNotes.filter(n => n.source_url).length
            };

            Object.keys(counts).forEach(type => {
                const countEl = document.getElementById(`count-${type}`);
                if (countEl) countEl.textContent = counts[type];
            });
        }

        // Filter notes by type
        function filterNotes(type) {
            currentNotesFilter = type;
            
            // Update active tab
            document.querySelectorAll('.note-filter-tab').forEach(tab => {
                tab.classList.remove('active', 'border-slate-500', 'text-slate-300');
                tab.classList.add('border-transparent', 'text-slate-400');
                tab.querySelector('span').classList.remove('bg-slate-700', 'text-slate-400');
                tab.querySelector('span').classList.add('bg-slate-800', 'text-slate-300');
            });
            
            const activeTab = document.getElementById(`filter-${type}`);
            if (activeTab) {
                activeTab.classList.remove('border-transparent', 'text-slate-400');
                activeTab.classList.add('active', 'border-slate-500', 'text-slate-300');
                const span = activeTab.querySelector('span');
                span.classList.remove('bg-slate-800', 'text-slate-300');
                span.classList.add('bg-slate-700', 'text-slate-400');
            }

            // Filter notes
            switch (type) {
                case 'all':
                    filteredNotes = allNotes;
                    break;
                case 'text':
                    filteredNotes = allNotes.filter(n => {
                        const noteType = (n.type || '').toLowerCase();
                        const hasAudio = n.audio_filename || noteType === 'audio';
                        const hasFile = n.file_filename && n.file_type !== 'image';
                        const hasImage = n.file_type === 'image' || noteType === 'image';
                        const hasWebSource = n.source_url;
                        // Text notes are notes that don't have audio, files, images, or web sources
                        return !hasAudio && !hasFile && !hasImage && !hasWebSource;
                    });
                    break;
                case 'audio':
                    filteredNotes = allNotes.filter(n => n.type === 'audio' || n.audio_filename);
                    break;
                case 'file':
                    filteredNotes = allNotes.filter(n => n.file_filename && n.file_type && n.file_type !== 'image');
                    break;
                case 'image':
                    filteredNotes = allNotes.filter(n => n.file_type === 'image' || n.type === 'image');
                    break;
                case 'web':
                    filteredNotes = allNotes.filter(n => n.source_url);
                    break;
                default:
                    filteredNotes = allNotes;
            }

            sortNotes(currentNotesSort);
        }

        // Search notes
        function searchNotes(query) {
            if (!query.trim()) {
                filterNotes(currentNotesFilter);
                return;
            }

            const searchLower = query.toLowerCase();
            filteredNotes = filteredNotes.filter(note => 
                note.title?.toLowerCase().includes(searchLower) ||
                note.body?.toLowerCase().includes(searchLower) ||
                note.content?.toLowerCase().includes(searchLower) ||
                note.summary?.toLowerCase().includes(searchLower) ||
                note.tags?.toLowerCase().includes(searchLower)
            );

            renderNotes();
        }

        // Sort notes
        function sortNotes(sortBy) {
            currentNotesSort = sortBy;

            switch (sortBy) {
                case 'newest':
                    filteredNotes.sort((a, b) => 
                        new Date(b.timestamp || b.created_at) - new Date(a.timestamp || a.created_at)
                    );
                    break;
                case 'oldest':
                    filteredNotes.sort((a, b) => 
                        new Date(a.timestamp || a.created_at) - new Date(b.timestamp || b.created_at)
                    );
                    break;
                case 'title':
                    filteredNotes.sort((a, b) => 
                        (a.title || 'Untitled').localeCompare(b.title || 'Untitled')
                    );
                    break;
                case 'type':
                    filteredNotes.sort((a, b) => 
                        (a.type || 'text').localeCompare(b.type || 'text')
                    );
                    break;
                case 'size':
                    filteredNotes.sort((a, b) => 
                        ((b.body || b.content || '').length) - ((a.body || a.content || '').length)
                    );
                    break;
            }

            renderNotes();
        }

        // Toggle between grid and list view
        function toggleNotesView(viewType) {
            currentNotesView = viewType;
            
            // Update buttons
            document.getElementById('view-grid').classList.toggle('bg-slate-200', viewType === 'grid');
            document.getElementById('view-list').classList.toggle('bg-slate-200', viewType === 'list');
            
            renderNotes();
        }

        // Render notes in the container
        function renderNotes() {
            const container = document.getElementById('notesContainer');
            const emptyState = document.getElementById('notesEmpty');

            if (filteredNotes.length === 0) {
                container.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            container.style.display = 'block';
            emptyState.style.display = 'none';

            if (currentNotesView === 'grid') {
                container.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4';
                container.innerHTML = filteredNotes.map(note => createNoteGridCard(note)).join('');
            } else {
                container.className = 'space-y-4';
                container.innerHTML = filteredNotes.map(note => createNoteListItem(note)).join('');
            }
        }

        // Create note grid card
        function createNoteGridCard(note) {
            const typeIcon = getNoteTypeIcon(note);
            const timestamp = formatTimeAgo(note.timestamp || note.created_at);
            const preview = getContentPreview(note);
            const tags = Array.isArray(note.tags_list) ? note.tags_list : (note.tags ? note.tags.split(',').map(t => t.trim()).filter(Boolean) : []);
            const hasImage = !!note.file_url;
            const isAudio = (note.type || '').toLowerCase() === 'audio';

            return `
                <div class="bg-slate-800 rounded-lg border border-slate-700 hover:border-slate-600 hover:shadow-md transition-all cursor-pointer" onclick="openNoteDetails(${note.id})">
                    ${hasImage ? `<div class=\"h-32 w-full overflow-hidden rounded-t-md bg-slate-700\"><img src=\"${note.file_url}\" alt=\"preview\" class=\"object-cover w-full h-full\" loading=\"lazy\"/></div>` : ''}
                    <div class="p-4">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex items-center">
                            <span class="text-lg mr-2">${typeIcon}</span>
                            <span class="text-xs text-slate-400 font-medium">${note.type || 'TEXT'}</span>
                            ${isAudio && note.audio_duration_hms ? `<span class=\"ml-2 text-xs text-slate-500\">${note.audio_duration_hms}</span>` : ''}
                        </div>
                        <div class="flex items-center space-x-1">
                            ${note.status === 'pending' ? '<div class="w-2 h-2 bg-yellow-400 rounded-full"></div>' : ''}
                            <button onclick="event.stopPropagation(); showNoteActions(${note.id})" class="text-slate-400 hover:text-slate-200">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <h3 class="font-medium text-slate-300 mb-2 line-clamp-2">${note.title || 'Untitled'}</h3>
                    <p class="text-sm text-slate-400 line-clamp-3 mb-3">${preview}</p>
                    <div class="flex items-center justify-between text-xs">
                        <span class="text-slate-500">${timestamp}</span>
                        ${tags.length > 0 ? `<span class="text-slate-400 bg-slate-700 px-2 py-1 rounded-full">${tags[0]}${tags.length > 1 ? ` +${tags.length - 1}` : ''}</span>` : ''}
                    </div>
                </div>
                </div>
            `;
        }

        // Create note list item
        function createNoteListItem(note) {
            const typeIcon = getNoteTypeIcon(note);
            const timestamp = formatTimeAgo(note.timestamp || note.created_at);
            const preview = getContentPreview(note);
            const tags = Array.isArray(note.tags_list) ? note.tags_list : (note.tags ? note.tags.split(',').map(t => t.trim()).filter(Boolean) : []);
            const hasImage = !!note.file_url;
            const isAudio = (note.type || '').toLowerCase() === 'audio';

            return `
                <div class="bg-slate-800 rounded-lg border border-slate-700 hover:border-slate-600 hover:shadow-sm transition-all cursor-pointer p-4" onclick="openNoteDetails(${note.id})">
                    <div class="flex items-start justify-between">
                        <div class="flex items-start space-x-4 flex-1">
                            <div class="flex-shrink-0 w-12 h-12 rounded bg-slate-700 flex items-center justify-center overflow-hidden">
                                ${hasImage ? `<img src="${note.file_url}" alt="thumb" class="object-cover w-full h-full" loading="lazy"/>` : `<span class="text-xl">${typeIcon}</span>`}
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center space-x-2 mb-1">
                                    <h3 class="font-medium text-slate-300 truncate">${note.title || 'Untitled'}</h3>
                                    <span class="text-xs text-slate-500 font-medium bg-slate-700 px-2 py-1 rounded">${note.type || 'TEXT'}</span>
                                    ${isAudio && note.audio_duration_hms ? `<span class="text-xs text-slate-500">${note.audio_duration_hms}</span>` : ''}
                                    ${note.status === 'pending' ? '<span class="text-xs text-yellow-400 bg-yellow-900 px-2 py-1 rounded">Processing</span>' : ''}
                                </div>
                                <p class="text-sm text-slate-400 line-clamp-2 mb-2">${preview}</p>
                                <div class="flex items-center space-x-4 text-xs text-slate-500">
                                    <span>${timestamp}</span>
                                    <span>${(note.body || note.content || '').length} chars</span>
                                    ${tags.length > 0 ? `<span class="text-slate-400">${tags.join(', ')}</span>` : ''}
                                </div>
                            </div>
                        </div>
                        <button onclick="event.stopPropagation(); showNoteActions(${note.id})" class="flex-shrink-0 ml-4 text-slate-400 hover:text-slate-200">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            `;
        }

        // Get note type icon
        function getNoteTypeIcon(note) {
            if (note.type === 'audio') return 'üéµ';
            if (note.file_type === 'image' || note.type === 'image') return 'üñºÔ∏è';
            if (note.file_type && note.file_type !== 'image') return 'üìÅ';
            if (note.source_url) return 'üåê';
            return 'üìù';
        }

        // Get content preview
        function getContentPreview(note) {
            const content = note.summary || note.body || note.content || '';
            return content.substring(0, 150) + (content.length > 150 ? '...' : '');
        }

        // Refresh notes view
        async function refreshNotesView() {
            await loadAllNotes();
        }

        // Show note actions menu
        function showNoteActions(noteId) {
            // TODO: Implement note actions (edit, delete, export, etc.)
            console.log('Show actions for note:', noteId);
            showToast('Note actions coming soon!', 'info', 2000);
        }

        // Open note details
        async function openNoteDetails(noteId) {
            console.log('Opening note details for ID:', noteId);

            try {
                // Show modal with loading state
                document.getElementById('noteDetailsModal').classList.remove('hidden');
                document.getElementById('noteDetailsTitle').textContent = 'Loading...';

                // Fetch note details
                const response = await fetch(`/api/notes/${noteId}`, {
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error(`Failed to fetch note: ${response.status}`);
                }

                const note = await response.json();
                console.log('Loaded note details:', note);

                // Store current note for editing
                currentEditingNote = note;

                // Populate the modal with note data
                await populateNoteDetails(note);

            } catch (error) {
                console.error('Error loading note details:', error);
                showToast('Failed to load note details', 'error', 3000);
                closeNoteDetails();
            }
        }

        // Close note details modal
        function closeNoteDetails() {
            document.getElementById('noteDetailsModal').classList.add('hidden');
            // Stop any playing audio
            if (window.currentAudio) {
                window.currentAudio.pause();
                window.currentAudio = null;
            }
            // Exit edit mode if active
            if (window.noteEditMode) {
                exitEditMode();
            }
        }

        // Note editing functionality
        let currentEditingNote = null;
        window.noteEditMode = false;

        // Initialize note action buttons
        document.addEventListener('DOMContentLoaded', () => {
            const editBtn = document.getElementById('editNoteBtn');
            if (editBtn) {
                editBtn.addEventListener('click', enterEditMode);
            }

            const deleteBtn = document.getElementById('deleteNoteBtn');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', confirmDeleteNote);
            }

            const archiveBtn = document.getElementById('archiveNoteBtn');
            if (archiveBtn) {
                archiveBtn.addEventListener('click', archiveNote);
            }

            const exportBtn = document.getElementById('exportNoteBtn');
            if (exportBtn) {
                exportBtn.addEventListener('click', showExportOptions);
            }
        });

        function enterEditMode() {
            if (window.noteEditMode || !currentEditingNote) return;

            window.noteEditMode = true;
            console.log('Entering edit mode for note:', currentEditingNote);

            // Make title editable
            const titleElement = document.getElementById('noteDetailsTitle');
            const currentTitle = titleElement.textContent;
            titleElement.innerHTML = `<input type="text" id="editTitleInput" value="${currentTitle.replace(/"/g, '&quot;')}" class="bg-slate-800 border border-slate-600 text-slate-200 px-3 py-1 rounded-lg w-full focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none">`;

            // Make content editable if it exists
            const contentElement = document.getElementById('noteContent');
            if (contentElement && !contentElement.classList.contains('hidden')) {
                const currentContent = currentEditingNote.content || currentEditingNote.body || '';
                contentElement.innerHTML = `<textarea id="editContentInput" rows="12" class="bg-slate-700 border border-slate-600 text-slate-200 px-4 py-3 rounded-lg w-full focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none resize-y font-mono text-sm">${currentContent.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</textarea>`;
            }

            // Make tags editable
            const tagsElement = document.getElementById('noteTags');
            if (tagsElement && !document.getElementById('tagsSection').classList.contains('hidden')) {
                const currentTags = currentEditingNote.tags || '';
                document.getElementById('tagsSection').querySelector('h3').insertAdjacentHTML('afterend',
                    `<input type="text" id="editTagsInput" value="${currentTags.replace(/"/g, '&quot;')}" placeholder="Add tags (comma-separated)" class="bg-slate-800 border border-slate-600 text-slate-200 px-3 py-2 rounded-lg w-full focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none mt-3 mb-3">`
                );
                tagsElement.classList.add('hidden');
            }

            // Change edit button to save/cancel buttons
            const editBtn = document.getElementById('editNoteBtn');
            editBtn.classList.add('hidden');
            editBtn.insertAdjacentHTML('afterend', `
                <button id="saveNoteBtn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg transition-all flex items-center space-x-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    <span>Save</span>
                </button>
                <button id="cancelEditBtn" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-slate-300 text-sm font-medium rounded-lg transition-all ml-2">
                    Cancel
                </button>
            `);

            // Add event listeners
            document.getElementById('saveNoteBtn').addEventListener('click', saveNoteEdits);
            document.getElementById('cancelEditBtn').addEventListener('click', exitEditMode);

            showToast('Edit mode enabled', 'info', 2000);
        }

        function exitEditMode() {
            if (!window.noteEditMode) return;

            window.noteEditMode = false;
            console.log('Exiting edit mode');

            // Remove save/cancel buttons
            const saveBtn = document.getElementById('saveNoteBtn');
            const cancelBtn = document.getElementById('cancelEditBtn');
            if (saveBtn) saveBtn.remove();
            if (cancelBtn) cancelBtn.remove();

            // Show edit button again
            document.getElementById('editNoteBtn').classList.remove('hidden');

            // Reload the note to restore original view
            if (currentEditingNote) {
                populateNoteDetails(currentEditingNote);
            }
        }

        async function saveNoteEdits() {
            if (!currentEditingNote) return;

            try {
                // Get edited values
                const titleInput = document.getElementById('editTitleInput');
                const contentInput = document.getElementById('editContentInput');
                const tagsInput = document.getElementById('editTagsInput');

                const updates = {
                    title: titleInput ? titleInput.value.trim() : currentEditingNote.title,
                    content: contentInput ? contentInput.value.trim() : (currentEditingNote.content || currentEditingNote.body),
                    tags: tagsInput ? tagsInput.value.trim() : currentEditingNote.tags
                };

                console.log('Saving note edits:', updates);

                // Show saving state
                const saveBtn = document.getElementById('saveNoteBtn');
                saveBtn.disabled = true;
                saveBtn.innerHTML = `
                    <svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    <span>Saving...</span>
                `;

                // Call API to update note
                const response = await fetch(`/api/notes/${currentEditingNote.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(updates)
                });

                if (!response.ok) {
                    throw new Error(`Failed to save note: ${response.status}`);
                }

                const updatedNote = await response.json();
                console.log('Note saved successfully:', updatedNote);

                // Update current note data
                currentEditingNote = { ...currentEditingNote, ...updates };

                // Exit edit mode and refresh display
                exitEditMode();

                // Refresh the dashboard to show updated note
                refreshDashboardData();

                showToast('Note saved successfully!', 'success', 3000);

            } catch (error) {
                console.error('Error saving note:', error);
                showToast(`Failed to save note: ${error.message}`, 'error', 5000);

                // Re-enable save button
                const saveBtn = document.getElementById('saveNoteBtn');
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = `
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        <span>Save</span>
                    `;
                }
            }
        }

        // Delete note with confirmation
        function confirmDeleteNote() {
            if (!currentEditingNote) return;

            // Create custom confirmation dialog
            const confirmed = confirm(
                `Are you sure you want to delete this note?\n\nTitle: ${currentEditingNote.title || 'Untitled'}\n\nThis action cannot be undone.`
            );

            if (confirmed) {
                deleteNote();
            }
        }

        async function deleteNote() {
            if (!currentEditingNote) return;

            try {
                console.log('Deleting note:', currentEditingNote.id);

                const response = await fetch(`/api/notes/${currentEditingNote.id}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error(`Failed to delete note: ${response.status}`);
                }

                console.log('Note deleted successfully');

                // Close the modal
                closeNoteDetails();

                // Refresh the dashboard
                refreshDashboardData();

                showToast('Note deleted successfully', 'success', 3000);

            } catch (error) {
                console.error('Error deleting note:', error);
                showToast(`Failed to delete note: ${error.message}`, 'error', 5000);
            }
        }

        // Archive note (soft delete with archived status)
        async function archiveNote() {
            if (!currentEditingNote) return;

            try {
                console.log('Archiving note:', currentEditingNote.id);

                // Update note status to archived
                const response = await fetch(`/api/notes/${currentEditingNote.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        title: currentEditingNote.title,
                        content: currentEditingNote.content || currentEditingNote.body,
                        tags: currentEditingNote.tags,
                        status: 'archived'
                    })
                });

                if (!response.ok) {
                    throw new Error(`Failed to archive note: ${response.status}`);
                }

                console.log('Note archived successfully');

                // Close the modal
                closeNoteDetails();

                // Refresh the dashboard
                refreshDashboardData();

                showToast('Note archived successfully', 'info', 3000);

            } catch (error) {
                console.error('Error archiving note:', error);
                showToast(`Failed to archive note: ${error.message}`, 'error', 5000);
            }
        }

        // Export note functionality
        function showExportOptions() {
            if (!currentEditingNote) return;

            // Simple prompt for format selection
            const format = prompt('Choose export format:\n\n1. Markdown (.md)\n2. JSON (.json)\n3. Text (.txt)\n\nEnter 1, 2, or 3:');

            if (!format) return; // User cancelled

            let exportFormat;
            switch (format.trim()) {
                case '1':
                    exportFormat = 'markdown';
                    break;
                case '2':
                    exportFormat = 'json';
                    break;
                case '3':
                    exportFormat = 'txt';
                    break;
                default:
                    showToast('Invalid format selected', 'error', 3000);
                    return;
            }

            exportNote(exportFormat);
        }

        async function exportNote(format = 'markdown') {
            if (!currentEditingNote) return;

            try {
                console.log(`Exporting note ${currentEditingNote.id} as ${format}`);

                const response = await fetch(`/api/notes/${currentEditingNote.id}/export?format=${format}`, {
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error(`Failed to export note: ${response.status}`);
                }

                // Get the blob from response
                const blob = await response.blob();

                // Extract filename from Content-Disposition header or create one
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = `note-${currentEditingNote.id}.${format === 'markdown' ? 'md' : format}`;

                if (contentDisposition) {
                    const match = contentDisposition.match(/filename=([^;]+)/);
                    if (match && match[1]) {
                        filename = match[1].replace(/['"]/g, '');
                    }
                }

                // Create download link and trigger download
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();

                // Cleanup
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                showToast(`Note exported as ${format.toUpperCase()}`, 'success', 3000);

            } catch (error) {
                console.error('Error exporting note:', error);
                showToast(`Failed to export note: ${error.message}`, 'error', 5000);
            }
        }

        // Populate note details modal
        async function populateNoteDetails(note) {
            // Set title and type icon
            document.getElementById('noteDetailsTitle').textContent = note.title || 'Untitled Note';
            
            // Update type icon and display
            const typeIcon = getNoteTypeIcon(note);
            document.getElementById('noteTypeIcon').innerHTML = `<span class="text-lg">${typeIcon}</span>`;
            document.getElementById('noteTypeDisplay').textContent = (note.type || 'text').toUpperCase();
            
            // Update metadata
            document.getElementById('noteCreatedDate').textContent = formatTimeAgo(note.created_at || note.timestamp || 'Unknown');
            document.getElementById('noteStatusDisplay').textContent = (note.status === 'complete' || !note.status) ? 'Processed' : 'Processing...';
            document.getElementById('noteWordCount').textContent = `${(note.content || note.body || '').split(' ').length} words`;
            
            // Handle audio section
            if (note.audio_filename || note.type === 'audio') {
                document.getElementById('audioSection').classList.remove('hidden');
                await setupAudioPlayer(note);
            } else {
                document.getElementById('audioSection').classList.add('hidden');
            }
            
            // Handle content sections
            setupContentSections(note);
        }

        // Setup audio player
        async function getAuthenticatedAudioUrl(filename) {
            try {
                // Try to get a token by making an API call that returns the access token
                const response = await fetch('/api/auth/token', {
                    method: 'GET',
                    credentials: 'include' // Include cookies
                });
                if (response.ok) {
                    const data = await response.json();
                    return `/audio/${filename}?token=${data.access_token}`;
                }
            } catch (e) {
                // Fallback to basic URL if token fetch fails
                console.warn('Could not get audio auth token, trying basic auth:', e);
            }
            // Fallback to basic URL without token
            return `/audio/${filename}`;
        }

        async function setupAudioPlayer(note) {
            const audioPlayBtn = document.getElementById('audioPlayBtn');
            const audioPlayIcon = document.getElementById('audioPlayIcon');
            const audioPlayText = document.getElementById('audioPlayText');
            const audioCurrentTime = document.getElementById('audioCurrentTime');
            const audioDuration = document.getElementById('audioDuration');
            const audioSpeedSelect = document.getElementById('audioSpeedSelect');
            const waveformArtwork = document.getElementById('waveformArtwork');
            const waveformLoading = document.getElementById('waveformLoading');

            // Audio URL - prefer server-provided URL, fallback to tokenized endpoint
            const audioUrl = note.audio_url || (note.audio_filename ? await getAuthenticatedAudioUrl(note.audio_filename) : null);

            let audio = null;
            let isPlaying = false;

            waveformArtwork?.classList.remove('is-playing', 'is-ready');
            if (waveformLoading) {
                if (!waveformLoading.dataset.defaultMarkup) {
                    waveformLoading.dataset.defaultMarkup = waveformLoading.innerHTML;
                }
                waveformLoading.innerHTML = waveformLoading.dataset.defaultMarkup;
                waveformLoading.classList.remove('text-red-300', 'text-slate-500');
                waveformLoading.classList.add('flex', 'items-center', 'gap-2', 'text-slate-400');
                waveformLoading.style.display = 'flex';
                waveformLoading.style.opacity = '1';
            }

            // Initialize audio
            if (!audioUrl) {
                audioPlayText.textContent = 'No audio file';
                if (waveformLoading) {
                    waveformLoading.classList.add('text-slate-500');
                    waveformLoading.innerHTML = 'Audio file not available';
                    waveformLoading.style.display = 'block';
                    waveformLoading.style.opacity = '1';
                }
                waveformArtwork?.classList.remove('is-playing', 'is-ready');
                return;
            }

            audio = new Audio(audioUrl);
            audio.preload = 'auto';
            window.currentAudio = audio;

            // Update duration when loaded
            audio.addEventListener('loadedmetadata', () => {
                audioDuration.textContent = formatTime(audio.duration);
                if (waveformLoading) {
                    waveformLoading.innerHTML = '<span class="text-blue-200">Ready to play</span>';
                    waveformLoading.style.opacity = '0';
                    setTimeout(() => {
                        waveformLoading.style.display = 'none';
                    }, 300);
                }
                waveformArtwork?.classList.add('is-ready');
            });

            audio.addEventListener('error', () => {
                if (waveformLoading) {
                    waveformLoading.style.display = 'flex';
                    waveformLoading.style.opacity = '1';
                    waveformLoading.innerHTML = '<span class="text-red-300">Failed to load audio</span>';
                }
                waveformArtwork?.classList.remove('is-playing');
            });

            // Update current time while playing
            audio.addEventListener('timeupdate', () => {
                audioCurrentTime.textContent = formatTime(audio.currentTime);
            });

            audio.addEventListener('play', () => {
                waveformArtwork?.classList.add('is-playing');
            });

            audio.addEventListener('pause', () => {
                waveformArtwork?.classList.remove('is-playing');
            });

            // Handle play/pause button interactions
            audioPlayBtn.onclick = () => {
                if (isPlaying) {
                    audio.pause();
                    audioPlayIcon.innerHTML = `
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1.586a1 1 0 01.707.293l2.414 2.414a1 1 0 00.707.293H15M9 10v4a2 2 0 002 2h2a2 2 0 002-2v-4M9 10V6a2 2 0 012-2h2a2 2 0 012 2v4"></path>
                    `;
                    audioPlayText.textContent = 'Play';
                    waveformArtwork?.classList.remove('is-playing');
                    isPlaying = false;
                } else {
                    audio.play();
                    audioPlayIcon.innerHTML = `
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    `;
                    audioPlayText.textContent = 'Pause';
                    waveformArtwork?.classList.add('is-playing');
                    isPlaying = true;
                }
            };

            // Handle speed change
            audioSpeedSelect.onchange = () => {
                audio.playbackRate = parseFloat(audioSpeedSelect.value);
            };

            // Reset UI when audio ends
            audio.addEventListener('ended', () => {
                audioPlayIcon.innerHTML = `
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1.586a1 1 0 01.707.293l2.414 2.414a1 1 0 00.707.293H15M9 10v4a2 2 0 002 2h2a2 2 0 002-2v-4M9 10V6a2 2 0 012-2h2a2 2 0 012 2v4"></path>
                `;
                audioPlayText.textContent = 'Play';
                waveformArtwork?.classList.remove('is-playing');
                isPlaying = false;
            });
        }

        // Setup content sections
        function setupContentSections(note) {
            // Summary section
            if (note.summary && note.summary.trim()) {
                document.getElementById('summarySection').classList.remove('hidden');
                document.getElementById('noteSummary').textContent = note.summary;
            } else {
                document.getElementById('summarySection').classList.add('hidden');
            }
            
            // Actions section
            if (note.actions && note.actions.trim()) {
                document.getElementById('actionsSection').classList.remove('hidden');
                const actionsList = document.getElementById('actionsList');
                actionsList.innerHTML = '';
                note.actions.split('\n').filter(action => action.trim()).forEach(action => {
                    const li = document.createElement('li');
                    li.textContent = action.trim();
                    li.className = 'text-slate-300';
                    actionsList.appendChild(li);
                });
            } else {
                document.getElementById('actionsSection').classList.add('hidden');
            }
            
            // Content section
            if (note.content && note.content.trim()) {
                document.getElementById('contentSection').classList.remove('hidden');
                document.getElementById('noteContent').textContent = note.content;
            } else if (note.body && note.body.trim()) {
                document.getElementById('contentSection').classList.remove('hidden');
                document.getElementById('noteContent').textContent = note.body;
            } else {
                document.getElementById('contentSection').classList.add('hidden');
            }
            
            // Extracted text section
            if (note.extracted_text && note.extracted_text.trim() && note.extracted_text !== note.content) {
                document.getElementById('extractedTextSection').classList.remove('hidden');
                document.getElementById('noteExtractedText').textContent = note.extracted_text;
            } else {
                document.getElementById('extractedTextSection').classList.add('hidden');
            }
            
            // Tags section
            if (note.tags && note.tags.trim()) {
                document.getElementById('tagsSection').classList.remove('hidden');
                const tagsContainer = document.getElementById('noteTags');
                tagsContainer.innerHTML = '';
                
                const tags = note.tags.split(',').map(tag => tag.trim()).filter(tag => tag);
                tags.forEach(tag => {
                    const tagEl = document.createElement('span');
                    tagEl.className = 'px-2 py-1 bg-slate-700 text-slate-300 text-sm rounded-full border border-slate-600';
                    tagEl.textContent = '#' + tag;
                    tagsContainer.appendChild(tagEl);
                });
            } else {
                document.getElementById('tagsSection').classList.add('hidden');
            }
        }

        // Format time for audio player
        function formatTime(seconds) {
            if (isNaN(seconds)) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // Initialize Notes view event listeners
        function initializeNotesViewEventListeners() {
            // Search input
            const searchInput = document.getElementById('notesSearchInput');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    searchNotes(e.target.value);
                });
            }

            // Sort dropdown
            const sortSelect = document.getElementById('sortNotesSelect');
            if (sortSelect) {
                sortSelect.addEventListener('change', (e) => {
                    sortNotes(e.target.value);
                });
            }

            // Filter tabs
            document.querySelectorAll('.note-filter-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    const type = tab.id.replace('filter-', '');
                    filterNotes(type);
                });
            });

            // View toggle buttons
            const gridViewBtn = document.getElementById('view-grid');
            const listViewBtn = document.getElementById('view-list');
            
            if (gridViewBtn) {
                gridViewBtn.addEventListener('click', () => toggleNotesView('grid'));
            }
            
            if (listViewBtn) {
                listViewBtn.addEventListener('click', () => toggleNotesView('list'));
            }

            // Refresh button
            const refreshBtn = document.querySelector('[onclick="refreshNotesView()"]');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    refreshNotesView();
                });
            }
        }

        // Enhanced Audio Recorder Class
        class AudioRecorder {
            constructor() {
                console.log('üé§ AudioRecorder: Starting initialization...');
                
                this.mediaRecorder = null;
                this.audioChunks = [];
                this.recording = false;
                this.recordingStartTime = null;
                this.timerInterval = null;
                this.audioContext = null;
                this.analyser = null;
                this.dataArray = null;
                this.animationId = null;
                this.initializationComplete = false;
                this.initializationPromise = null;
                
                // UI Elements with validation
                this.recordButton = document.getElementById('recordButton');
                this.stopButton = document.getElementById('stopButton');
                this.recordingText = document.getElementById('recordingText');
                this.recordingTimer = document.getElementById('recordingTimer');
                this.microphoneIcon = document.getElementById('microphoneIcon');
                this.waveformContainer = document.getElementById('waveformContainer');
                this.waveformBars = document.querySelectorAll('.waveform-bar');
                
                // Validate required DOM elements
                const requiredElements = [
                    { element: this.recordButton, name: 'recordButton' },
                    { element: this.stopButton, name: 'stopButton' },
                    { element: this.recordingText, name: 'recordingText' },
                    { element: this.recordingTimer, name: 'recordingTimer' },
                    { element: this.microphoneIcon, name: 'microphoneIcon' },
                    { element: this.waveformContainer, name: 'waveformContainer' }
                ];
                
                let missingElements = [];
                for (const { element, name } of requiredElements) {
                    if (!element) {
                        missingElements.push(name);
                        console.error(`üé§ AudioRecorder: Missing DOM element: ${name}`);
                    }
                }
                
                if (missingElements.length > 0) {
                    console.error(`üé§ AudioRecorder: Cannot initialize due to missing DOM elements:`, missingElements);
                    showToast(`Recording setup error: missing UI elements (${missingElements.join(', ')})`, 'error', 5000);
                    return;
                }
                
                console.log('üé§ AudioRecorder: All DOM elements found, starting async initialization...');
                
                // Start async initialization but don't await in constructor
                this.initializationPromise = this.initializeRecorder();
            }

            async initializeRecorder() {
                try {
                    console.log('üé§ AudioRecorder: Starting async initialization...');
                    
                    // Environment capability checks (secure context FIRST to avoid confusing errors on HTTP)
                    if (!window.isSecureContext) {
                        console.error('üé§ AudioRecorder: Not in secure context');
                        this.setStatus('Requires HTTPS (or localhost)', 'error');
                        showToast('Microphone requires a secure context (https or localhost).', 'error', 6000);
                        showMicrophoneBanner('Use HTTPS or localhost to enable recording. For Tailscale, enable Serve/Funnel HTTPS.');
                        return;
                    }
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        console.error('üé§ AudioRecorder: getUserMedia not supported');
                        this.setStatus('Recording not supported in this browser', 'error');
                        showToast('Recording not supported: getUserMedia unavailable', 'error', 6000);
                        return;
                    }

                    console.log('üé§ AudioRecorder: Environment checks passed, requesting microphone...');

                    // Request microphone permission (minimal constraints to reduce failures)
                    let stream;
                    try {
                        stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        console.log('üé§ AudioRecorder: Microphone access granted');
                    } catch (err) {
                        console.error('üé§ AudioRecorder: getUserMedia error:', err);
                        if (isPermissionError(err)) {
                            this.setStatus('Microphone permission needed', 'error');
                            showMicrophoneBanner('Please allow microphone access to record audio.');
                        } else if (err && (err.name === 'NotReadableError' || err.name === 'TrackStartError')) {
                            this.setStatus('Microphone is in use by another app', 'error');
                            showToast('Microphone busy (NotReadableError). Close other apps using the mic and try again.', 'error', 6000);
                        } else if (err && err.name === 'NotFoundError') {
                            this.setStatus('No microphone found', 'error');
                            showToast('No audio input device detected.', 'error', 6000);
                        } else {
                            this.setStatus('Failed to access microphone', 'error');
                            showToast('Unexpected microphone error. See console for details.', 'error', 6000);
                        }
                        return;
                    }

                    // Set up audio context for visualization
                    try {
                        console.log('üé§ AudioRecorder: Setting up audio visualization...');
                        this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        this.analyser = this.audioContext.createAnalyser();
                        const source = this.audioContext.createMediaStreamSource(stream);
                        source.connect(this.analyser);
                        this.analyser.fftSize = 256;
                        const bufferLength = this.analyser.frequencyBinCount;
                        this.dataArray = new Uint8Array(bufferLength);
                        console.log('üé§ AudioRecorder: Audio visualization setup complete');
                    } catch (ctxErr) {
                        console.warn('üé§ AudioRecorder: AudioContext init issue (non-fatal):', ctxErr);
                    }

                    // Ensure MediaRecorder support and initialize
                    if (typeof MediaRecorder === 'undefined') {
                        console.error('üé§ AudioRecorder: MediaRecorder API not available');
                        this.setStatus('Recording not supported (MediaRecorder missing)', 'error');
                        showToast('MediaRecorder API not available in this browser. Try Chrome/Edge/Firefox.', 'error', 7000);
                        return;
                    }
                    
                    console.log('üé§ AudioRecorder: Creating MediaRecorder...');
                    const supportedMimeType = this.getSupportedMimeType();
                    console.log('üé§ AudioRecorder: Using mime type:', supportedMimeType);
                    
                    try {
                        this.mediaRecorder = new MediaRecorder(stream, { mimeType: supportedMimeType });
                        console.log('üé§ AudioRecorder: MediaRecorder created successfully');
                    } catch (mrErr) {
                        console.error('üé§ AudioRecorder: Failed to create MediaRecorder:', mrErr);
                        this.setStatus('Failed to initialize recorder', 'error');
                        showToast('Could not initialize recorder (codec/mime not supported).', 'error', 6000);
                        return;
                    }

                    this.mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            this.audioChunks.push(event.data);
                            console.log('üé§ AudioRecorder: Audio data chunk received, size:', event.data.size);
                        }
                    };
                    this.mediaRecorder.onstop = () => { 
                        console.log('üé§ AudioRecorder: MediaRecorder stopped');
                        this.handleRecordingStop(); 
                    };

                    // Mark initialization as complete
                    this.initializationComplete = true;
                    console.log('üé§ AudioRecorder: Initialization completed successfully');
                    
                    this.setStatus('Ready to record', 'ready');
                    hideMicrophoneBanner();

                } catch (error) {
                    console.error('üé§ AudioRecorder: Error initializing recorder (unexpected):', error);
                    this.initializationComplete = false;
                    this.setStatus('Failed to initialize recording', 'error');
                    showToast('Unexpected recorder error. See console for details.', 'error', 6000);
                }
            }

            getSupportedMimeType() {
                const types = [
                    'audio/webm;codecs=opus',
                    'audio/webm',
                    'audio/mp4',
                    'audio/ogg;codecs=opus'
                ];
                
                for (const type of types) {
                    if (MediaRecorder.isTypeSupported(type)) {
                        return type;
                    }
                }
                return 'audio/webm'; // Fallback
            }

            async toggleRecording() {
                console.log('üé§ AudioRecorder: Toggle recording called');
                if (this.recording) {
                    this.stopRecording();
                } else {
                    await this.startRecording();
                }
            }

            async startRecording() {
                console.log('üé§ AudioRecorder: Start recording called');
                
                // Check if we're already recording
                if (this.recording) {
                    console.log('üé§ AudioRecorder: Already recording, ignoring request');
                    return;
                }
                
                // Wait for initialization if still in progress
                if (!this.initializationComplete && this.initializationPromise) {
                    console.log('üé§ AudioRecorder: Waiting for initialization to complete...');
                    try {
                        await this.initializationPromise;
                        console.log('üé§ AudioRecorder: Initialization wait completed');
                    } catch (error) {
                        console.error('üé§ AudioRecorder: Initialization failed:', error);
                        showToast('Recording initialization failed. Check console for details.', 'error', 4000);
                        return;
                    }
                }
                
                // Check if MediaRecorder is ready
                if (!this.mediaRecorder) {
                    console.error('üé§ AudioRecorder: MediaRecorder not available');
                    // Proactively guide user and attempt recovery
                    try { 
                        if (typeof ensureMicrophonePermission === 'function') {
                            await ensureMicrophonePermission();
                        }
                        // Attempt a quick re-initialization in case permission was just granted
                        if (typeof this.initializeRecorder === 'function') {
                            await this.initializeRecorder();
                        }
                    } catch (_) { /* non-fatal */ }
                    showToast('Recording not ready. Click ‚ÄúAllow‚Äù for mic access, then try again.', 'error', 5000);
                    return;
                }
                
                try {
                    console.log('üé§ AudioRecorder: Starting recording...');
                    this.audioChunks = [];
                    this.recordingStartTime = Date.now();
                    this.mediaRecorder.start();
                    this.recording = true;
                    
                    this.setRecordingUI(true);
                    this.startTimer();
                    this.startVisualization();
                    
                    console.log('üé§ AudioRecorder: Recording started successfully');
                    showToast('Recording started', 'success', 2000);
                } catch (error) {
                    console.error('üé§ AudioRecorder: Error starting recording:', error);
                    this.setStatus('Failed to start recording', 'error');
                    showToast('Failed to start recording', 'error', 3000);
                }
            }

            stopRecording() {
                if (!this.recording || !this.mediaRecorder) return;
                
                try {
                    this.mediaRecorder.stop();
                    this.recording = false;
                    
                    this.setRecordingUI(false);
                    this.stopTimer();
                    this.stopVisualization();
                    
                } catch (error) {
                    console.error('Error stopping recording:', error);
                }
            }

            setRecordingUI(isRecording) {
                if (isRecording) {
                    this.recordingText.textContent = 'Recording...';
                    this.microphoneIcon.classList.add('animate-pulse');
                    this.microphoneIcon.classList.add('bg-red-600');
                    this.microphoneIcon.classList.remove('bg-gradient-to-br', 'from-red-500', 'to-red-600');
                    this.waveformContainer.classList.remove('hidden');
                    
                    // Update buttons
                    this.stopButton.disabled = false;
                    this.stopButton.classList.remove('opacity-50', 'cursor-not-allowed');
                    this.stopButton.classList.add('bg-slate-500', 'hover:bg-slate-400');
                    
                    this.recordButton.classList.add('animate-pulse');
                } else {
                    this.recordingText.textContent = 'Processing...';
                    this.microphoneIcon.classList.remove('animate-pulse', 'bg-red-600');
                    this.microphoneIcon.classList.add('bg-gradient-to-br', 'from-red-500', 'to-red-600');
                    this.waveformContainer.classList.add('hidden');
                    
                    // Update buttons
                    this.stopButton.disabled = true;
                    this.stopButton.classList.add('opacity-50', 'cursor-not-allowed');
                    this.stopButton.classList.remove('bg-slate-500', 'hover:bg-slate-400');
                    
                    this.recordButton.classList.remove('animate-pulse');
                }
            }

            startTimer() {
                this.timerInterval = setInterval(() => {
                    if (!this.recordingStartTime) return;
                    
                    const elapsed = Math.floor((Date.now() - this.recordingStartTime) / 1000);
                    const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
                    const seconds = (elapsed % 60).toString().padStart(2, '0');
                    this.recordingTimer.textContent = `${minutes}:${seconds}`;
                }, 1000);
            }

            stopTimer() {
                if (this.timerInterval) {
                    clearInterval(this.timerInterval);
                    this.timerInterval = null;
                }
            }

            startVisualization() {
                const visualize = () => {
                    if (!this.recording) return;
                    
                    this.analyser.getByteFrequencyData(this.dataArray);
                    
                    this.waveformBars.forEach((bar, index) => {
                        const value = this.dataArray[index * 8] || 0;
                        const height = Math.max(4, (value / 255) * 50);
                        bar.style.height = `${height}px`;
                    });
                    
                    this.animationId = requestAnimationFrame(visualize);
                };
                visualize();
            }

            stopVisualization() {
                if (this.animationId) {
                    cancelAnimationFrame(this.animationId);
                    this.animationId = null;
                }
            }

            async handleRecordingStop() {
                try {
                    this.setStatus('Processing recording...', 'processing');
                    
                    if (this.audioChunks.length === 0) {
                        this.setStatus('No audio data recorded', 'error');
                        showToast('No audio was recorded', 'error', 3000);
                        return;
                    }
                    
                    const mimeType = this.mediaRecorder.mimeType || 'audio/webm';
                    const audioBlob = new Blob(this.audioChunks, { type: mimeType });
                    
                    // Generate filename
                    const ext = mimeType.includes('ogg') ? 'ogg' : 
                               mimeType.includes('mp4') ? 'm4a' : 'webm';
                    const timestamp = Date.now();
                    const filename = `voice-note-${timestamp}.${ext}`;
                    
                    // Submit to server
                    await this.submitAudioToServer(audioBlob, filename);
                    
                } catch (error) {
                    console.error('Error handling recording stop:', error);
                    this.setStatus('Failed to process recording', 'error');
                    showToast('Failed to process recording', 'error', 3000);
                }
            }

            async submitAudioToServer(audioBlob, filename) {
                try {
                    console.log('üé§ Starting audio upload:', {
                        blobSize: audioBlob.size,
                        blobType: audioBlob.type,
                        filename: filename
                    });
                    
                    const formData = new FormData();
                    formData.append('file', audioBlob, filename);
                    formData.append('tags', 'voice-note audio');
                    
                    // Debug: Log form data contents
                    console.log('üé§ Form data contents:');
                    for (let [key, value] of formData.entries()) {
                        if (key === 'file') {
                            console.log(`  ${key}: File(${value.size} bytes, ${value.type})`);
                        } else {
                            console.log(`  ${key}: ${value}`);
                        }
                    }
                    
                    console.log('üé§ Sending request to /webhook/audio...');
                    const response = await fetch('/webhook/audio', {
                        method: 'POST',
                        credentials: 'include',  // Include authentication cookies
                        body: formData
                    });
                    
                    console.log('üé§ Response received:', {
                        status: response.status,
                        statusText: response.statusText,
                        headers: Object.fromEntries(response.headers.entries())
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        this.setStatus('Recording saved successfully!', 'success');
                        showToast('Voice note saved! Processing transcription...', 'success', 4000);
                        
                        // Hide modal after success
                        setTimeout(() => {
                            hideVoiceRecordingModal();
                            // Refresh dashboard data to show new note
                            refreshDashboardData();
                        }, 2000);
                        
                    } else {
                        const errorText = await response.text();
                        console.error('üé§ Server error response:', response.status, errorText);
                        throw new Error(`Server error: ${response.status} - ${errorText}`);
                    }
                    
                } catch (error) {
                    console.error('üé§ Error submitting audio:', error);
                    console.error('üé§ Error details:', {
                        message: error.message,
                        stack: error.stack,
                        name: error.name
                    });
                    this.setStatus('Failed to save recording', 'error');
                    showToast(`Failed to save voice note: ${error.message}`, 'error', 15000);
                }
            }

            setStatus(text, type) {
                if (this.recordingText) {
                    this.recordingText.textContent = text;
                    
                    // Add visual feedback based on type
                    this.recordingText.className = 'text-white font-medium text-lg';
                    if (type === 'error') {
                        this.recordingText.classList.add('text-red-400');
                    } else if (type === 'success') {
                        this.recordingText.classList.add('text-green-400');
                    } else if (type === 'processing') {
                        this.recordingText.classList.add('text-blue-400');
                    }
                }
            }

            resetUI() {
                if (this.recording) {
                    this.stopRecording();
                }
                
                this.recordingTimer.textContent = '00:00';
                this.setStatus('Ready to record', 'ready');
                this.microphoneIcon.classList.remove('animate-pulse', 'bg-red-600');
                this.microphoneIcon.classList.add('bg-gradient-to-br', 'from-red-500', 'to-red-600');
                this.waveformContainer.classList.add('hidden');
                
                // Reset buttons
                this.stopButton.disabled = true;
                this.stopButton.classList.add('opacity-50', 'cursor-not-allowed');
                this.recordButton.classList.remove('animate-pulse');
            }
        }

        // Placeholder functions for UI elements
        function showQuickUpload() { showGlobalQuickActions(); }
        function showVoiceRecorder() { showGlobalQuickActions(); }
        
        // View note function for Recent Notes interaction
        function viewNote(noteId) {
            if (noteId) {
                showToast('Opening note...', 'info', 2000);
                // In a real implementation, this would navigate to the note view
                console.log('Viewing note:', noteId);
            }
        }

        // Microphone permission helpers (persistent banner)
        const BottomBannerManager = {
            banners: { mic: 'microphonePermissionBanner', pwaPrompt: 'pwaInstallPrompt' },
            show(name) {
                for (const [key, id] of Object.entries(this.banners)) {
                    const el = document.getElementById(id);
                    if (!el) continue;
                    if (key === name) el.classList.remove('hidden');
                    else el.classList.add('hidden');
                }
                // Hide top PWA banner when any bottom banner is visible
                try { hidePWAInstallBanner && hidePWAInstallBanner(); } catch (_) {}
            },
            hide(name) {
                const el = document.getElementById(this.banners[name]);
                if (el) el.classList.add('hidden');
            },
            hideAll() {
                for (const id of Object.values(this.banners)) {
                    const el = document.getElementById(id);
                    if (el) el.classList.add('hidden');
                }
            }
        };
        async function checkMicrophonePermission() {
            try {
                if (navigator.permissions && navigator.permissions.query) {
                    // Not supported on all browsers (notably some Safari versions)
                    const status = await navigator.permissions.query({ name: 'microphone' });
                    if (status.state === 'denied') return 'denied';
                    if (status.state === 'prompt') return 'prompt';
                    return 'granted';
                }
            } catch (_) { /* ignore */ }
            return 'unknown';
        }

        async function ensureMicrophonePermission() {
            const state = await checkMicrophonePermission();
            if (state === 'denied' || state === 'prompt' || state === 'unknown') {
                showMicrophoneBanner(state === 'denied' ? 'Microphone permission is blocked for this site.' : 'Microphone access is required to record audio.');
            }
        }

        function showMicrophoneBanner(text) {
            const banner = document.getElementById('microphonePermissionBanner');
            const msg = document.getElementById('microphonePermissionText');
            if (msg && text) msg.textContent = text;
            BottomBannerManager.show('mic');
        }

        function hideMicrophoneBanner() {
            const banner = document.getElementById('microphonePermissionBanner');
            if (banner) BottomBannerManager.hide('mic');
        }

        function dismissMicrophoneBanner() { hideMicrophoneBanner(); }

        async function requestMicrophonePermission() {
            try {
                document.getElementById('requestMicBtn')?.classList.add('btn-loading');
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                // Immediately stop tracks; we only needed permission
                stream.getTracks().forEach(t => t.stop());
                hideMicrophoneBanner();
                if (window.audioRecorder) {
                    // Reinitialize recorder now that we have permission
                    await window.audioRecorder.initializeRecorder();
                }
                showToast('Microphone access granted', 'success');
            } catch (err) {
                console.error('Permission request failed:', err);
                showMicrophoneBanner('Still blocked. Please allow microphone in your browser settings.');
            } finally {
                document.getElementById('requestMicBtn')?.classList.remove('btn-loading');
            }
        }

        function openMicrophoneHelp() {
            showToast('See banner tips to enable microphone permissions.', 'info', 5000);
        }

        // Error type helper
        function isPermissionError(err) {
            const name = err && err.name ? err.name.toLowerCase() : '';
            const msg = err && err.message ? err.message.toLowerCase() : '';
            return name.includes('notallowed') || name.includes('permission') || name.includes('security') ||
                   /permission.*denied/.test(msg);
        }

        // PWA banner serialization hooks
        const originalShowPWAInstallPrompt = typeof showPWAInstallPrompt === 'function' ? showPWAInstallPrompt : null;
        const originalHidePWAInstallPrompt = typeof hidePWAInstallPrompt === 'function' ? hidePWAInstallPrompt : null;

        // Wrap existing functions if present after parsing
        window.addEventListener('DOMContentLoaded', () => {
            if (typeof showPWAInstallPrompt === 'function') {
                const _show = showPWAInstallPrompt;
                window.showPWAInstallPrompt = function() {
                    BottomBannerManager.show('pwaPrompt');
                    return _show.apply(this, arguments);
                };
            }
            if (typeof hidePWAInstallPrompt === 'function') {
                const _hide = hidePWAInstallPrompt;
                window.hidePWAInstallPrompt = function() {
                    BottomBannerManager.hide('pwaPrompt');
                    return _hide.apply(this, arguments);
                };
            }
        });

        // ===============================
        // UI/UX Enhancement Functions
        // ===============================

        // Toast Notification System
        function showToast(message, type = 'info', duration = 4000) {
            const toastContainer = document.getElementById('toastContainer');
            const toastId = Date.now().toString();
            
            const typeConfig = {
                success: { bg: 'bg-green-500', icon: '‚úì' },
                error: { bg: 'bg-red-500', icon: '‚úï' },
                warning: { bg: 'bg-yellow-500', icon: '‚ö†' },
                info: { bg: 'bg-blue-500', icon: '‚Ñπ' }
            };
            
            const config = typeConfig[type] || typeConfig.info;
            
            const toast = document.createElement('div');
            toast.id = `toast-${toastId}`;
            toast.className = `toast ${config.bg} text-white px-4 py-3 rounded-lg shadow-lg flex items-center space-x-3 max-w-sm animate-slide-in`;
            toast.innerHTML = `
                <span class="text-lg">${config.icon}</span>
                <span class="flex-1 font-medium">${message}</span>
                <button onclick="hideToast('${toastId}')" class="text-white hover:text-gray-200 focus:outline-none">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            `;
            
            // Enforce a single visible toast at a time
            const maxToasts = 1;
            while (toastContainer.firstChild && toastContainer.childElementCount >= maxToasts) {
                toastContainer.removeChild(toastContainer.firstChild);
            }
            toastContainer.appendChild(toast);
            
            // Show toast
            setTimeout(() => toast.classList.add('show'), 100);
            
            // Auto-hide after duration
            setTimeout(() => hideToast(toastId), duration);
        }

        function hideToast(toastId) {
            const toast = document.getElementById(`toast-${toastId}`);
            if (toast) {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }
        }

        // Loading States Management
        function showLoadingState(elementId, loadingText = 'Loading...') {
            const element = document.getElementById(elementId);
            if (element) {
                element.classList.add('btn-loading');
                element.disabled = true;
                element.setAttribute('data-original-text', element.textContent);
                element.textContent = loadingText;
            }
        }

        function hideLoadingState(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.classList.remove('btn-loading');
                element.disabled = false;
                const originalText = element.getAttribute('data-original-text');
                if (originalText) {
                    element.textContent = originalText;
                    element.removeAttribute('data-original-text');
                }
            }
        }

        function showSkeletonLoader(containerId) {
            const container = document.getElementById(containerId);
            if (container) {
                const skeleton = container.querySelector('.skeleton-activity, .skeleton-notes');
                if (skeleton) {
                    skeleton.style.display = 'block';
                }
            }
        }

        function hideSkeletonLoader(containerId) {
            const container = document.getElementById(containerId);
            if (container) {
                const skeleton = container.querySelector('.skeleton-activity, .skeleton-notes');
                if (skeleton) {
                    skeleton.style.display = 'none';
                }
            }
        }

        // Enhanced Error Handling
        function handleApiError(error, context = '') {
            console.error(`API Error in ${context}:`, error);
            
            let message = 'Something went wrong. Please try again.';
            if (error.message.includes('fetch')) {
                message = 'Connection failed. Please check your internet connection.';
            } else if (error.message.includes('404')) {
                message = 'The requested resource was not found.';
            } else if (error.message.includes('500')) {
                message = 'Server error. Please try again later.';
            }
            
            showToast(message, 'error');
            return message;
        }

        function retryWithExponentialBackoff(fn, maxRetries = 3, delay = 1000) {
            return new Promise((resolve, reject) => {
                function attempt(retryCount) {
                    fn()
                        .then(resolve)
                        .catch(error => {
                            if (retryCount < maxRetries) {
                                setTimeout(() => attempt(retryCount + 1), delay * Math.pow(2, retryCount));
                            } else {
                                reject(error);
                            }
                        });
                }
                attempt(0);
            });
        }

        // Network Status Detection
        function checkNetworkStatus() {
            if (!navigator.onLine) {
                showToast('You are offline. Some features may not work properly.', 'warning', 6000);
                return false;
            }
            return true;
        }

        // Enhanced Animation Helpers
        function animateValue(element, start, end, duration, suffix = '') {
            const startTime = performance.now();
            const difference = end - start;
            
            function updateValue(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const easedProgress = 1 - Math.pow(1 - progress, 3); // ease-out cubic
                const current = Math.round(start + (difference * easedProgress));
                
                element.textContent = current + suffix;
                
                if (progress < 1) {
                    requestAnimationFrame(updateValue);
                }
            }
            
            requestAnimationFrame(updateValue);
        }

        function staggerAnimation(elements, animationClass, delay = 100) {
            elements.forEach((element, index) => {
                setTimeout(() => {
                    element.classList.add(animationClass);
                }, index * delay);
            });
        }

        // Accessibility Enhancements
        function announceToScreenReader(message) {
            const announcement = document.createElement('div');
            announcement.setAttribute('aria-live', 'polite');
            announcement.setAttribute('aria-atomic', 'true');
            announcement.className = 'sr-only';
            announcement.textContent = message;
            
            document.body.appendChild(announcement);
            
            setTimeout(() => {
                document.body.removeChild(announcement);
            }, 1000);
        }

        // Focus Management
        function trapFocus(element) {
            const focusableElements = element.querySelectorAll(
                'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
            );
            
            if (focusableElements.length === 0) return;
            
            const firstElement = focusableElements[0];
            const lastElement = focusableElements[focusableElements.length - 1];
            
            element.addEventListener('keydown', (e) => {
                if (e.key === 'Tab') {
                    if (e.shiftKey) {
                        if (document.activeElement === firstElement) {
                            lastElement.focus();
                            e.preventDefault();
                        }
                    } else {
                        if (document.activeElement === lastElement) {
                            firstElement.focus();
                            e.preventDefault();
                        }
                    }
                }
            });
            
            firstElement.focus();
        }

        // PWA Installation Management
        let deferredPrompt = null;
        let pwaPromptDismissed = false;
        let pwaInstallAttempted = false;

        function setupPWAPrompts() {
            // Load dismissed state
            pwaPromptDismissed = localStorage.getItem('pwaPromptDismissed') === 'true';
            pwaInstallAttempted = localStorage.getItem('pwaInstallAttempted') === 'true';
            
            // Listen for beforeinstallprompt event
            window.addEventListener('beforeinstallprompt', (e) => {
                console.log('[PWA] Install prompt available');
                e.preventDefault();
                deferredPrompt = e;
                
                // Show install prompts if not dismissed and not attempted
                if (!pwaPromptDismissed && !pwaInstallAttempted && !isInStandaloneMode()) {
                    showPWAInstallPrompt();
                }
            });

            // Listen for app installed event
            window.addEventListener('appinstalled', (e) => {
                console.log('[PWA] App installed successfully');
                hidePWAInstallPrompt();
                hidePWAInstallBanner();
                showSearchMessage('Second Brain installed successfully! You can now launch it from your home screen.', 'success');
                
                // Mark as attempted
                localStorage.setItem('pwaInstallAttempted', 'true');
                pwaInstallAttempted = true;
            });

            // Show banner on subsequent visits if install is supported
            if (!pwaPromptDismissed && !pwaInstallAttempted && !isInStandaloneMode()) {
                setTimeout(() => {
                    if (getUsageStats().sessionsCount > 1) {
                        showPWAInstallBanner();
                    }
                }, 10000); // Show after 10 seconds
            }
            
            // Show prompt on mobile after some usage
            if (isMobileDevice() && !pwaPromptDismissed && !pwaInstallAttempted) {
                setTimeout(() => {
                    if (getUsageStats().sessionsCount > 2) {
                        showPWAInstallPrompt();
                    }
                }, 15000); // Show after 15 seconds on mobile
            }
        }

        function isInStandaloneMode() {
            return (window.matchMedia('(display-mode: standalone)').matches) || 
                   (window.navigator.standalone) || 
                   document.referrer.includes('android-app://');
        }

        function isMobileDevice() {
            return /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        function isIOSDevice() {
            return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        }

        function showPWAInstallBanner() {
            const banner = document.getElementById('pwaInstallBanner');
            // If any bottom banner is visible, avoid overlapping and skip for now
            const bottomVisible = document.querySelector('[data-bottom-banner]:not(.hidden)');
            if (bottomVisible) return;
            banner.classList.remove('hidden');
            
            // Auto-hide after 30 seconds
            setTimeout(() => {
                if (!banner.classList.contains('hidden')) {
                    hidePWAInstallBanner();
                }
            }, 30000);
        }

        function hidePWAInstallBanner() {
            document.getElementById('pwaInstallBanner').classList.add('hidden');
        }

        function showPWAInstallPrompt() {
            const prompt = document.getElementById('pwaInstallPrompt');
            prompt.classList.remove('hidden');
            
            // Auto-hide after 20 seconds
            setTimeout(() => {
                if (!prompt.classList.contains('hidden')) {
                    hidePWAInstallPrompt();
                }
            }, 20000);
        }

        function hidePWAInstallPrompt() {
            document.getElementById('pwaInstallPrompt').classList.add('hidden');
        }

        function installPWA() {
            if (isIOSDevice()) {
                // Show iOS installation instructions
                showIOSInstallInstructions();
                return;
            }

            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('[PWA] User accepted the install prompt');
                        showSearchMessage('Installing Second Brain...', 'info');
                    } else {
                        console.log('[PWA] User dismissed the install prompt');
                        dismissPWAPrompt();
                    }
                    deferredPrompt = null;
                });
            } else {
                // Fallback: Show manual instructions
                showSearchMessage('Installation not available. Try using Chrome or Edge.', 'warning');
                hidePWAInstallPrompt();
                hidePWAInstallBanner();
            }
        }

        function dismissPWABanner() {
            hidePWAInstallBanner();
            pwaPromptDismissed = true;
            localStorage.setItem('pwaPromptDismissed', 'true');
            
            showSearchMessage('You can still install Second Brain from your browser menu', 'info');
        }

        function dismissPWAPrompt() {
            hidePWAInstallPrompt();
            pwaPromptDismissed = true;
            localStorage.setItem('pwaPromptDismissed', 'true');
        }

        function showIOSInstallInstructions() {
            document.getElementById('pwaIOSInstructions').classList.remove('hidden');
        }

        function hideIOSInstructions() {
            document.getElementById('pwaIOSInstructions').classList.add('hidden');
            dismissPWAPrompt();
        }

        // Usage tracking for PWA prompts
        function getUsageStats() {
            const stats = JSON.parse(localStorage.getItem('usageStats') || '{"sessionsCount": 0, "lastVisit": null}');
            return stats;
        }

        function updateUsageStats() {
            const stats = getUsageStats();
            const now = Date.now();
            const lastVisit = stats.lastVisit || 0;
            
            // Count as new session if more than 30 minutes since last visit
            if (now - lastVisit > 30 * 60 * 1000) {
                stats.sessionsCount++;
            }
            
            stats.lastVisit = now;
            localStorage.setItem('usageStats', JSON.stringify(stats));
            
            return stats;
        }

        // Discord Bot Management Functions
        async function refreshBotStatus() {
            const statusDot = document.getElementById('discordBotStatusDot');
            const statusText = document.getElementById('discordBotStatusText');
            const connectionStatus = document.getElementById('connectionStatus');
            const connectionStatusIcon = document.getElementById('connectionStatusIcon');
            const connectionUptime = document.getElementById('connectionUptime');
            
            // Show loading state
            statusDot.className = 'w-3 h-3 bg-yellow-400 rounded-full animate-pulse';
            statusText.textContent = 'Checking...';
            
            try {
                // Check bot status via API
                const response = await fetch('/api/discord/status');
                const data = await response.json();
                
                if (data.connected) {
                    statusDot.className = 'w-3 h-3 bg-green-400 rounded-full';
                    statusText.textContent = 'Online';
                    connectionStatus.textContent = 'Online';
                    connectionStatusIcon.className = 'w-5 h-5 text-green-400';
                    connectionUptime.textContent = data.uptime || 'Connected';
                    
                    // Update statistics
                    if (data.stats) {
                        document.getElementById('messageCount').textContent = data.stats.messages || '-';
                        document.getElementById('userCount').textContent = data.stats.users || '-';
                    }
                } else {
                    statusDot.className = 'w-3 h-3 bg-red-400 rounded-full';
                    statusText.textContent = 'Offline';
                    connectionStatus.textContent = 'Offline';
                    connectionStatusIcon.className = 'w-5 h-5 text-red-400';
                    connectionUptime.textContent = 'Disconnected';
                }
                
                // Update activity if available
                if (data.recentActivity) {
                    updateDiscordActivity(data.recentActivity);
                }
                
            } catch (error) {
                console.error('Failed to fetch Discord bot status:', error);
                statusDot.className = 'w-3 h-3 bg-red-400 rounded-full';
                statusText.textContent = 'Error';
                connectionStatus.textContent = 'Error';
                connectionStatusIcon.className = 'w-5 h-5 text-red-400';
                connectionUptime.textContent = 'Failed to check';
            }
        }
        
        function updateDiscordActivity(activities) {
            const container = document.getElementById('discordActivity');
            
            if (!activities || activities.length === 0) {
                container.innerHTML = `
                    <div class="p-6 text-center text-slate-400">
                        <svg class="w-12 h-12 mx-auto mb-3 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <p>No recent bot activity</p>
                        <p class="text-sm text-slate-500 mt-1">Discord interactions will appear here</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = activities.map(activity => `
                <div class="p-4 border-b border-slate-700 last:border-b-0">
                    <div class="flex items-start space-x-3">
                        <div class="w-8 h-8 bg-indigo-500 bg-opacity-20 rounded-lg flex items-center justify-center">
                            <span class="text-sm">${activity.icon || 'ü§ñ'}</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center space-x-2 mb-1">
                                <span class="text-sm font-medium text-white">${activity.user || 'Unknown User'}</span>
                                <span class="text-xs px-2 py-1 bg-indigo-500 bg-opacity-20 text-indigo-400 rounded-full">${activity.command || 'interaction'}</span>
                            </div>
                            <p class="text-sm text-slate-400">${activity.description || 'Bot interaction'}</p>
                            <div class="text-xs text-slate-500 mt-1">${activity.timestamp || 'Just now'}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        async function testBotConnection() {
            showMessage('Testing Discord bot connection...', 'info');
            
            try {
                const response = await fetch('/api/discord/test', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    showMessage('Discord bot connection test successful!', 'success');
                    // Refresh status to get updated info
                    setTimeout(refreshBotStatus, 1000);
                } else {
                    showMessage(`Connection test failed: ${data.error || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                console.error('Bot connection test failed:', error);
                showMessage('Failed to test bot connection. Check console for details.', 'error');
            }
        }
        
        async function viewBotLogs() {
            try {
                const response = await fetch('/api/discord/activity?limit=100');
                const data = await response.json();
                
                if (data.activities && data.activities.length > 0) {
                    showActivityLogsModal(data.activities, data.total);
                } else {
                    showMessage('No Discord bot activity logs found', 'info');
                }
            } catch (error) {
                console.error('Failed to fetch Discord activity logs:', error);
                showMessage('Failed to load activity logs. Check console for details.', 'error');
            }
        }
        
        function showActivityLogsModal(activities, total) {
            // Create modal HTML
            const modalHTML = `
                <div id="activityLogsModal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                    <div class="glass-dark rounded-2xl max-w-5xl w-full max-h-[80vh] overflow-hidden shadow-large animate-scale-in">
                        <div class="flex items-center justify-between p-6 border-b border-slate-700">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 bg-indigo-500 rounded-xl flex items-center justify-center">
                                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                    </svg>
                                </div>
                                <div>
                                    <h2 class="text-xl font-bold text-white">Discord Bot Activity Logs</h2>
                                    <p class="text-sm text-slate-400">Total activities: ${total}</p>
                                </div>
                            </div>
                            <button onclick="closeActivityLogsModal()" class="text-slate-400 hover:text-white transition-colors">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        
                        <div class="overflow-y-auto max-h-[60vh] custom-scrollbar">
                            ${activities.map(activity => `
                                <div class="p-4 border-b border-slate-700 last:border-b-0 hover:bg-slate-800 hover:bg-opacity-30 transition-colors">
                                    <div class="flex items-start space-x-3">
                                        <div class="w-10 h-10 bg-indigo-500 bg-opacity-20 rounded-lg flex items-center justify-center flex-shrink-0">
                                            <span class="text-lg">${activity.icon}</span>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <div class="flex items-start justify-between mb-2">
                                                <div class="flex items-center space-x-2 flex-wrap">
                                                    <span class="text-sm font-medium text-white">${activity.user}</span>
                                                    ${activity.command ? `<span class="text-xs px-2 py-1 bg-indigo-500 bg-opacity-20 text-indigo-400 rounded-full">/${activity.command}</span>` : ''}
                                                    ${activity.success ? '<span class="text-xs px-2 py-1 bg-green-500 bg-opacity-20 text-green-400 rounded-full">Success</span>' : '<span class="text-xs px-2 py-1 bg-red-500 bg-opacity-20 text-red-400 rounded-full">Failed</span>'}
                                                </div>
                                                <span class="text-xs text-slate-500 whitespace-nowrap ml-2">${formatTimestamp(activity.timestamp)}</span>
                                            </div>
                                            <p class="text-sm text-slate-300 mb-1">${activity.description}</p>
                                            ${activity.error ? `<p class="text-xs text-red-400 mt-1">Error: ${activity.error}</p>` : ''}
                                            <div class="text-xs text-slate-500">Action: ${activity.action}</div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="p-4 border-t border-slate-700 flex justify-end space-x-3">
                            <button onclick="refreshActivityLogs()" class="px-4 py-2 bg-indigo-500 bg-opacity-20 text-indigo-400 rounded-lg hover:bg-opacity-30 transition-all">
                                Refresh
                            </button>
                            <button onclick="closeActivityLogsModal()" class="px-4 py-2 bg-slate-600 text-white rounded-lg hover:bg-slate-500 transition-all">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Add modal to DOM
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Add close on backdrop click
            document.getElementById('activityLogsModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeActivityLogsModal();
                }
            });
        }
        
        function closeActivityLogsModal() {
            const modal = document.getElementById('activityLogsModal');
            if (modal) {
                modal.remove();
            }
        }
        
        async function refreshActivityLogs() {
            closeActivityLogsModal();
            setTimeout(() => viewBotLogs(), 200);
        }
        
        function formatTimestamp(timestamp) {
            try {
                const date = new Date(timestamp);
                return date.toLocaleString();
            } catch {
                return timestamp;
            }
        }
        
        function showMessage(message, type = 'info') {
            // Use the existing search message system for notifications
            if (typeof showSearchMessage === 'function') {
                showSearchMessage(message, type);
            } else {
                // Fallback to alert if showSearchMessage is not available
                alert(message);
            }
        }
        
        function openBotInviteLink() {
            // Show message about bot invite link
            showMessage('To invite your Discord bot to a server, use the Discord Developer Portal to generate an invite link with the appropriate permissions (Send Messages, Read Message History, Attach Files, Use Slash Commands, Embed Links, Add Reactions).', 'info');
            
            // Open Discord Developer Portal in a new tab
            window.open('https://discord.com/developers/applications', '_blank');
        }
        
        // Auto-refresh Discord bot status when Discord view is shown
        function initDiscordView() {
            refreshBotStatus();
            updateTokenStatus();
            
            // Set up periodic status checks
            const statusInterval = setInterval(() => {
                if (document.getElementById('discord-view').classList.contains('active')) {
                    refreshBotStatus();
                } else {
                    // Stop checking if view is not active
                    clearInterval(statusInterval);
                }
            }, 30000); // Check every 30 seconds
        }
        
        async function updateTokenStatus() {
            const tokenStatusDot = document.getElementById('tokenStatusDot');
            const tokenStatusText = document.getElementById('tokenStatusText');
            
            try {
                const response = await fetch('/api/discord/test', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    tokenStatusDot.className = 'w-2 h-2 bg-green-400 rounded-full';
                    tokenStatusText.textContent = 'Token configured and valid';
                } else {
                    tokenStatusDot.className = 'w-2 h-2 bg-red-400 rounded-full';
                    tokenStatusText.textContent = data.error || 'Token not configured';
                }
            } catch (error) {
                tokenStatusDot.className = 'w-2 h-2 bg-yellow-400 rounded-full';
                tokenStatusText.textContent = 'Unable to check token status';
            }
        }
        
        // Analytics Functions
        let analyticsData = {}; // Global analytics data storage
        let activityChart = null;
        let contentTypesChart = null;
        let hourlyPatternChart = null;
        let currentActivityView = 'daily';

        async function loadAnalytics(silent = false) {
            try {
                const response = await fetch('/api/analytics');
                analyticsData = await response.json();

                // Update overview stats
                document.getElementById('totalNotes').textContent = analyticsData.total_notes || 0;
                document.getElementById('thisWeekNotes').textContent = analyticsData.this_week || 0;
                document.getElementById('contentTypes').textContent = analyticsData.by_type?.length || 0;
                document.getElementById('popularTagsCount').textContent = analyticsData.popular_tags?.length || 0;

                // Update enhanced stats
                document.getElementById('avgNotesPerDay').textContent = analyticsData.avg_notes_per_day || 0;
                document.getElementById('daysActive').textContent = analyticsData.days_active || 0;
                document.getElementById('thisMonth').textContent = analyticsData.this_month || 0;

                // Update growth indicator
                updateGrowthIndicator(analyticsData.growth_rate || 0);

                // Load content types breakdown
                loadContentTypes(analyticsData.by_type || []);

                // Load popular tags
                loadPopularTags(analyticsData.popular_tags || []);

                // Create charts
                createActivityChart();
                createContentTypesChart();
                createHourlyPatternChart();

                // Load recent activity for analytics
                loadAnalyticsActivity();

                // Update Discord health status
                updateDiscordHealthInAnalytics();

            } catch (error) {
                console.error('Failed to load analytics:', error);
                // Only show error message if not in silent mode (e.g., during background refresh)
                if (!silent) {
                    showMessage('Failed to load analytics data', 'error');
                }
            }
        }

        function updateGrowthIndicator(growthRate) {
            const element = document.getElementById('weeklyGrowth');
            if (growthRate > 0) {
                element.innerHTML = `<span class="text-green-400">+${growthRate}% from last week</span>`;
                element.className = 'text-xs text-green-400';
            } else if (growthRate < 0) {
                element.innerHTML = `<span class="text-red-400">${growthRate}% from last week</span>`;
                element.className = 'text-xs text-red-400';
            } else {
                element.innerHTML = 'Last 7 days';
                element.className = 'text-xs text-slate-400';
            }
        }

        function createActivityChart() {
            const ctx = document.getElementById('activityChart').getContext('2d');
            
            // Destroy existing chart
            if (activityChart) {
                activityChart.destroy();
            }

            const data = currentActivityView === 'daily' 
                ? analyticsData.daily_activity || []
                : analyticsData.weekly_activity || [];

            const labels = data.map(item => 
                currentActivityView === 'daily' 
                    ? new Date(item.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
                    : item.week
            );
            const values = data.map(item => item.count);

            activityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: currentActivityView === 'daily' ? 'Daily Notes' : 'Weekly Notes',
                        data: values,
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(148, 163, 184, 0.1)'
                            },
                            ticks: {
                                color: '#94a3b8',
                                maxTicksLimit: 8
                            }
                        },
                        y: {
                            grid: {
                                color: 'rgba(148, 163, 184, 0.1)'
                            },
                            ticks: {
                                color: '#94a3b8'
                            }
                        }
                    }
                }
            });
        }

        function createContentTypesChart() {
            const ctx = document.getElementById('contentTypesChart').getContext('2d');
            
            // Destroy existing chart
            if (contentTypesChart) {
                contentTypesChart.destroy();
            }

            const data = analyticsData.by_type || [];
            if (data.length === 0) {
                ctx.fillStyle = '#64748b';
                ctx.font = '16px system-ui';
                ctx.textAlign = 'center';
                ctx.fillText('No data available', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }

            const colors = ['#8b5cf6', '#06b6d4', '#10b981', '#f59e0b', '#ef4444', '#6366f1'];
            
            contentTypesChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.map(item => item.type || 'Note'),
                    datasets: [{
                        data: data.map(item => item.count),
                        backgroundColor: colors.slice(0, data.length),
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: '#e2e8f0',
                                usePointStyle: true,
                                padding: 15
                            }
                        }
                    }
                }
            });
        }

        function createHourlyPatternChart() {
            const ctx = document.getElementById('hourlyPatternChart').getContext('2d');
            
            // Destroy existing chart
            if (hourlyPatternChart) {
                hourlyPatternChart.destroy();
            }

            const data = analyticsData.hourly_patterns || [];
            
            // Fill in missing hours with 0
            const hourlyData = new Array(24).fill(0);
            data.forEach(item => {
                hourlyData[item.hour] = item.count;
            });

            const labels = Array.from({ length: 24 }, (_, i) => `${i}:00`);

            hourlyPatternChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Notes Created',
                        data: hourlyData,
                        backgroundColor: 'rgba(34, 197, 94, 0.6)',
                        borderColor: '#22c55e',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(148, 163, 184, 0.1)'
                            },
                            ticks: {
                                color: '#94a3b8',
                                maxTicksLimit: 12
                            }
                        },
                        y: {
                            grid: {
                                color: 'rgba(148, 163, 184, 0.1)'
                            },
                            ticks: {
                                color: '#94a3b8'
                            }
                        }
                    }
                }
            });
        }

        function switchActivityView(view) {
            currentActivityView = view;
            
            // Update button styles
            document.getElementById('dailyBtn').className = view === 'daily' 
                ? 'px-3 py-1 bg-purple-500 bg-opacity-30 text-purple-300 rounded-lg text-sm'
                : 'px-3 py-1 bg-slate-600 text-slate-400 rounded-lg text-sm';
            document.getElementById('weeklyBtn').className = view === 'weekly'
                ? 'px-3 py-1 bg-purple-500 bg-opacity-30 text-purple-300 rounded-lg text-sm'
                : 'px-3 py-1 bg-slate-600 text-slate-400 rounded-lg text-sm';
            
            // Recreate the activity chart
            createActivityChart();
        }
        
        function loadContentTypes(contentTypes) {
            const container = document.getElementById('contentTypesList');
            
            if (contentTypes.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-slate-400 py-8">
                        <div class="text-2xl mb-2">üìù</div>
                        <div>No content yet</div>
                    </div>
                `;
                return;
            }
            
            const total = contentTypes.reduce((sum, item) => sum + item.count, 0);
            
            container.innerHTML = contentTypes.map(item => {
                const percentage = total > 0 ? (item.count / total * 100).toFixed(1) : 0;
                const icon = getContentTypeIcon(item.type);
                
                return `
                    <div class="flex items-center justify-between p-3 rounded-lg bg-slate-700 bg-opacity-30">
                        <div class="flex items-center space-x-3">
                            <span class="text-lg">${icon}</span>
                            <div>
                                <div class="text-sm font-medium text-white capitalize">${item.type || 'Note'}</div>
                                <div class="text-xs text-slate-400">${item.count} items</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm font-medium text-white">${percentage}%</div>
                            <div class="w-16 h-2 bg-slate-600 rounded-full overflow-hidden">
                                <div class="h-full bg-gradient-to-r from-purple-500 to-blue-500 transition-all duration-500" style="width: ${percentage}%"></div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function loadPopularTags(popularTags) {
            const container = document.getElementById('popularTagsList');
            
            if (popularTags.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-slate-400 py-8">
                        <div class="text-2xl mb-2">üè∑Ô∏è</div>
                        <div>No tags yet</div>
                    </div>
                `;
                return;
            }
            
            const maxCount = Math.max(...popularTags.map(tag => tag.count));
            
            container.innerHTML = popularTags.slice(0, 8).map(tag => {
                const percentage = maxCount > 0 ? (tag.count / maxCount * 100).toFixed(1) : 0;
                
                return `
                    <div class="flex items-center justify-between p-3 rounded-lg bg-slate-700 bg-opacity-30">
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 bg-yellow-500 bg-opacity-20 rounded-lg flex items-center justify-center">
                                <span class="text-sm">üè∑Ô∏è</span>
                            </div>
                            <div>
                                <div class="text-sm font-medium text-white">${tag.name}</div>
                                <div class="text-xs text-slate-400">${tag.count} notes</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="w-12 h-2 bg-slate-600 rounded-full overflow-hidden">
                                <div class="h-full bg-gradient-to-r from-yellow-500 to-orange-500 transition-all duration-500" style="width: ${percentage}%"></div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        async function loadAnalyticsActivity() {
            try {
                const response = await fetch('/api/recent-activity?limit=15');
                const data = await response.json();
                const container = document.getElementById('activityTimeline');
                
                if (data.activities && data.activities.length > 0) {
                    container.innerHTML = data.activities.map(activity => `
                        <div class="flex items-start space-x-3 p-3 rounded-lg hover:bg-slate-700 hover:bg-opacity-30 transition-colors">
                            <div class="w-10 h-10 bg-slate-600 rounded-lg flex items-center justify-center flex-shrink-0">
                                <span class="text-sm">${activity.icon}</span>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="text-sm font-medium text-white">${activity.title}</div>
                                <div class="text-xs text-slate-400 mt-1">${activity.description}</div>
                            </div>
                            <div class="text-xs text-slate-500 whitespace-nowrap">
                                ${formatTimeAgo(activity.timestamp)}
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = `
                        <div class="text-center text-slate-400 py-8">
                            <div class="text-2xl mb-2">üìä</div>
                            <div>No recent activity</div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Failed to load analytics activity:', error);
            }
        }
        
        async function updateDiscordHealthInAnalytics() {
            try {
                const response = await fetch('/api/discord/status');
                const data = await response.json();
                const icon = document.getElementById('discordHealthIcon');
                const status = document.getElementById('discordHealthStatus');
                
                if (data.connected) {
                    icon.className = 'w-12 h-12 bg-green-500 bg-opacity-20 rounded-lg flex items-center justify-center mx-auto mb-2';
                    icon.querySelector('svg').className = 'w-6 h-6 text-green-400';
                    status.className = 'text-xs text-green-400';
                    status.textContent = 'Online';
                } else {
                    icon.className = 'w-12 h-12 bg-red-500 bg-opacity-20 rounded-lg flex items-center justify-center mx-auto mb-2';
                    icon.querySelector('svg').className = 'w-6 h-6 text-red-400';
                    status.className = 'text-xs text-red-400';
                    status.textContent = 'Offline';
                }
            } catch (error) {
                // Keep default gray state
            }
        }
        
        function getContentTypeIcon(type) {
            const icons = {
                'audio': 'üé§',
                'file': 'üìÅ',
                'web': 'üåê',
                'image': 'üñºÔ∏è',
                'video': 'üé•',
                'pdf': 'üìÑ',
                'text': 'üìù',
                'note': 'üìù'
            };
            return icons[type] || 'üìù';
        }
        
        async function refreshAnalytics() {
            showMessage('Refreshing analytics...', 'info');
            await loadAnalytics();
            showMessage('Analytics updated!', 'success');
        }

        function exportAnalytics() {
            if (!analyticsData || Object.keys(analyticsData).length === 0) {
                showMessage('No analytics data to export', 'warning');
                return;
            }

            // Prepare export data with user-friendly formatting
            const exportData = {
                summary: {
                    total_notes: analyticsData.total_notes || 0,
                    this_week: analyticsData.this_week || 0,
                    last_week: analyticsData.last_week || 0,
                    this_month: analyticsData.this_month || 0,
                    growth_rate: analyticsData.growth_rate || 0,
                    avg_notes_per_day: analyticsData.avg_notes_per_day || 0,
                    days_active: analyticsData.days_active || 0
                },
                content_types: analyticsData.by_type || [],
                popular_tags: analyticsData.popular_tags || [],
                daily_activity: analyticsData.daily_activity || [],
                weekly_activity: analyticsData.weekly_activity || [],
                hourly_patterns: analyticsData.hourly_patterns || [],
                exported_at: new Date().toISOString(),
                export_version: '1.0'
            };

            // Create and download the file
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `second-brain-analytics-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showMessage('Analytics data exported successfully', 'success');
        }

        // Alias for loadAnalytics to match the reference in refreshDashboard
        const loadAnalyticsData = loadAnalytics;

        // Performance System Integration Functions
        function clearPerformanceCaches() {
            if (window.dashboardPerformance) {
                window.dashboardPerformance.clearAllCaches();
            } else {
                showMessage('Performance system not loaded', 'warning');
            }
        }

        function togglePerformanceFeatures() {
            // Show a modal with performance settings
            showPerformanceSettings();
        }

        function showPerformanceSettings() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-slate-800 rounded-lg p-6 max-w-md w-full mx-4">
                    <h3 class="text-lg font-semibold mb-4">Performance Settings</h3>
                    <div class="space-y-4">
                        <label class="flex items-center space-x-3">
                            <input type="checkbox" id="settingAutoSave" class="rounded" checked>
                            <span>Auto-save functionality</span>
                        </label>
                        <label class="flex items-center space-x-3">
                            <input type="checkbox" id="settingSuggestions" class="rounded" checked>
                            <span>Smart content suggestions</span>
                        </label>
                        <label class="flex items-center space-x-3">
                            <input type="checkbox" id="settingBehaviorTracking" class="rounded" checked>
                            <span>Behavior tracking for recommendations</span>
                        </label>
                        <label class="flex items-center space-x-3">
                            <input type="checkbox" id="settingCaching" class="rounded" checked>
                            <span>Intelligent caching</span>
                        </label>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
                        <button onclick="savePerformanceSettings()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Save</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function savePerformanceSettings() {
            const settings = {
                autoSaveEnabled: document.getElementById('settingAutoSave').checked,
                smartSuggestions: document.getElementById('settingSuggestions').checked,
                behaviorTracking: document.getElementById('settingBehaviorTracking').checked,
                caching: document.getElementById('settingCaching').checked
            };
            
            if (window.dashboardPerformance) {
                Object.keys(settings).forEach(key => {
                    window.dashboardPerformance.toggleSmartFeature(key, settings[key]);
                });
            }
            
            document.querySelector('.fixed').remove();
            showMessage('Performance settings saved', 'success');
        }

        // Update performance display
        function updatePerformanceDisplay() {
            if (!window.dashboardPerformance) return;
            
            const metrics = window.dashboardPerformance.getPerformanceMetrics();
            const cacheStats = window.dashboardPerformance.getCacheStats();
            
            // Update FCP
            const fcpElement = document.getElementById('perfFCP');
            const fcpBadge = document.getElementById('perfFCPBadge');
            if (fcpElement && metrics.fcpTime > 0) {
                fcpElement.textContent = Math.round(metrics.fcpTime);
                fcpBadge.textContent = metrics.fcpTime < 1500 ? 'Excellent' : metrics.fcpTime < 2500 ? 'Good' : 'Needs Improvement';
                fcpBadge.className = 'performance-badge ' + (metrics.fcpTime < 1500 ? 'excellent' : metrics.fcpTime < 2500 ? 'good' : 'needs-improvement');
            }
            
            // Update LCP
            const lcpElement = document.getElementById('perfLCP');
            const lcpBadge = document.getElementById('perfLCPBadge');
            if (lcpElement && metrics.lcpTime > 0) {
                lcpElement.textContent = Math.round(metrics.lcpTime);
                lcpBadge.textContent = metrics.lcpTime < 2500 ? 'Excellent' : metrics.lcpTime < 4000 ? 'Good' : 'Needs Improvement';
                lcpBadge.className = 'performance-badge ' + (metrics.lcpTime < 2500 ? 'excellent' : metrics.lcpTime < 4000 ? 'good' : 'needs-improvement');
            }
            
            // Update CLS
            const clsElement = document.getElementById('perfCLS');
            const clsBadge = document.getElementById('perfCLSBadge');
            if (clsElement) {
                clsElement.textContent = metrics.clsScore.toFixed(3);
                clsBadge.textContent = metrics.clsScore < 0.1 ? 'Excellent' : metrics.clsScore < 0.25 ? 'Good' : 'Needs Improvement';
                clsBadge.className = 'performance-badge ' + (metrics.clsScore < 0.1 ? 'excellent' : metrics.clsScore < 0.25 ? 'good' : 'needs-improvement');
            }
            
            // Update FID
            const fidElement = document.getElementById('perfFID');
            const fidBadge = document.getElementById('perfFIDBadge');
            if (fidElement && metrics.fidTime > 0) {
                fidElement.textContent = Math.round(metrics.fidTime);
                fidBadge.textContent = metrics.fidTime < 100 ? 'Excellent' : metrics.fidTime < 300 ? 'Good' : 'Needs Improvement';
                fidBadge.className = 'performance-badge ' + (metrics.fidTime < 100 ? 'excellent' : metrics.fidTime < 300 ? 'good' : 'needs-improvement');
            }
            
            // Update Memory
            const memoryElement = document.getElementById('perfMemory');
            const memoryBadge = document.getElementById('perfMemoryBadge');
            if (memoryElement) {
                memoryElement.textContent = Math.round(metrics.memoryUsage);
                memoryBadge.textContent = metrics.memoryUsage < 50 ? 'Excellent' : metrics.memoryUsage < 100 ? 'Good' : 'Needs Improvement';
                memoryBadge.className = 'performance-badge ' + (metrics.memoryUsage < 50 ? 'excellent' : metrics.memoryUsage < 100 ? 'good' : 'needs-improvement');
            }
            
            // Update Cache Hit Rate
            const cacheElement = document.getElementById('perfCacheHit');
            const cacheBadge = document.getElementById('perfCacheHitBadge');
            if (cacheElement) {
                const hitRate = Math.round(cacheStats.hitRate);
                cacheElement.textContent = hitRate;
                cacheBadge.textContent = hitRate > 80 ? 'Excellent' : hitRate > 60 ? 'Good' : 'Needs Improvement';
                cacheBadge.className = 'performance-badge ' + (hitRate > 80 ? 'excellent' : hitRate > 60 ? 'good' : 'needs-improvement');
            }
        }

        // Start performance monitoring when analytics view is shown
        const originalLoadAnalytics = loadAnalytics;
        loadAnalytics = async function() {
            await originalLoadAnalytics();
            updatePerformanceDisplay();
            
            // Update performance display every 10 seconds when analytics view is visible
            const interval = setInterval(() => {
                if (document.getElementById('analytics-view').classList.contains('hidden')) {
                    clearInterval(interval);
                } else {
                    updatePerformanceDisplay();
                }
            }, 10000);
        };

        // Override showView to initialize Discord view when shown
        const originalShowView = showView;
        showView = function(viewName) {
            originalShowView(viewName);
            
            if (viewName === 'discord') {
                // Initialize Discord view when shown
                setTimeout(initDiscordView, 100);
            } else if (viewName === 'analytics') {
                // Initialize Analytics view when shown
                setTimeout(loadAnalytics, 100);
            }
        };

        // Initialize PWA functionality
        document.addEventListener('DOMContentLoaded', function() {
            updateUsageStats();
            setupPWAPrompts();
        });
    </script>

    <style>
        /* Navigation styles */
        .nav-item {
            color: #94a3b8;
            transition: all 0.2s;
        }
        
        .nav-item:hover {
            color: #e2e8f0;
            background-color: #e2e8f0;
        }
        
        .nav-item.active {
            color: #5145cd;
            background-color: #f0f4ff;
            font-weight: 600;
        }
        
        .nav-item.active svg {
            color: #5145cd;
        }

        /* View transitions */
        .view {
            transition: all 0.2s;
        }
        
        .view.active {
            animation: fadeIn 0.2s ease-in;
        }

        /* Responsive sidebar */
        #sidebar {
            transition: transform 0.3s ease-in-out;
        }
        
        @media (max-width: 1023px) {
            #sidebar {
                position: absolute;
                z-index: 40;
                height: 100%;
                transform: translateX(-100%);
            }
        }

        /* Line clamp utility */
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* Content Management Styles */
        .note-card {
            transition: all 0.2s ease;
            position: relative;
        }
        
        .note-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 25px -8px rgba(0, 0, 0, 0.1);
        }
        
        .note-card.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }
        
        /* View modes */
        .notes-container[data-view-mode="list"] .note-card {
            display: flex;
            align-items: center;
            padding: 12px 16px;
        }
        
        .notes-container[data-view-mode="list"] .note-card .ml-6 {
            margin-left: 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }
        
        .notes-container[data-view-mode="compact"] .note-card {
            padding: 8px 12px;
        }
        
        .notes-container[data-view-mode="compact"] .note-card h4 {
            font-size: 0.75rem;
        }
        
        /* Inline editing styles */
        .inline-editor {
            transition: all 0.2s ease;
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.3);
            border-radius: 4px;
        }
        
        .inline-editor:focus {
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.4);
        }
        
        /* Tag suggestions */
        .tag-suggestions {
            max-height: 200px;
            backdrop-filter: blur(8px);
            border: 1px solid rgba(148, 163, 184, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .tag-suggestion.active {
            background-color: rgba(99, 102, 241, 0.1);
        }
        
        /* Smart selection styles */
        .note-card.selected {
            background: rgba(99, 102, 241, 0.05);
            border-color: rgba(99, 102, 241, 0.3);
        }
        
        .note-card.selected::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 3px;
            height: 100%;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            border-radius: 0 4px 4px 0;
        }
        
        /* Drag and drop styles */
        .drag-over {
            background: rgba(99, 102, 241, 0.05);
            border: 2px dashed rgba(99, 102, 241, 0.3);
        }
        
        .drop-zone {
            min-height: 60px;
            border: 2px dashed rgba(148, 163, 184, 0.3);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(148, 163, 184, 0.7);
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }
        
        .drop-zone.active {
            border-color: rgba(99, 102, 241, 0.5);
            background: rgba(99, 102, 241, 0.05);
            color: rgba(99, 102, 241, 0.8);
        }
        
        /* Enhanced search overlay */
        .search-overlay {
            backdrop-filter: blur(8px);
            animation: fadeIn 0.2s ease;
        }
        
        .search-result {
            transition: all 0.1s ease;
        }
        
        .search-result.active {
            background: rgba(99, 102, 241, 0.1);
            border-left-color: #6366f1;
        }
        
        /* Bulk operations bar */
        #bulk-action-bar {
            animation: slideUp 0.3s ease;
        }
        
        /* Template dropdown */
        .template-dropdown {
            animation: slideDown 0.2s ease;
            backdrop-filter: blur(8px);
        }
        
        /* Error fallback styles */
        .error-fallback {
            animation: shake 0.5s ease-in-out;
        }
        
        /* Performance indicators */
        .saving-indicator {
            animation: pulse 1s ease-in-out infinite;
        }
        
        /* Responsive design for content management */
        @media (max-width: 768px) {
            .notes-container[data-view-mode="card"] .note-card {
                padding: 12px;
            }
            
            .note-card .flex.items-center.space-x-1 {
                display: none;
            }
            
            .note-card:hover .flex.items-center.space-x-1 {
                display: flex;
                position: absolute;
                top: 8px;
                right: 8px;
                background: white;
                padding: 4px;
                border-radius: 4px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            }
            
            .bulk-selection-bar {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                z-index: 50;
            }
        }
        
        /* Dark mode support for content management */
        @media (prefers-color-scheme: dark) {
            .note-card {
                background: rgba(22, 32, 43, 0.9);
                border-color: rgba(148, 163, 184, 0.2);
            }
            
            .note-card:hover {
                background: rgba(26, 37, 47, 0.95);
                border-color: rgba(99, 102, 241, 0.4);
            }
            
            .inline-editor {
                background: rgba(22, 32, 43, 0.95);
                color: #e2e8f0;
            }
            
            .tag-suggestions {
                background: rgba(22, 32, 43, 0.95);
                border-color: rgba(148, 163, 184, 0.2);
            }
        }

        /* Performance & Advanced Features CSS */
        /* Search Suggestions */
        .search-suggestions {
            position: absolute;
            z-index: 50;
            background-color: white;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            max-height: 16rem;
            overflow-y: auto;
        }
        
        .dark .search-suggestions {
            background-color: #1e293b;
            border-color: #4b5563;
        }

        .search-suggestion {
            display: flex;
            align-items: center;
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.15s ease;
        }
        
        .search-suggestion:hover {
            background-color: #f8fafc;
        }
        
        .dark .search-suggestion:hover {
            background-color: #374151;
        }

        .search-suggestion:hover {
            transform: translateX(2px);
        }

        /* Smart Recommendation */
        .smart-recommendation {
            animation: slideInFromRight 0.3s ease-out;
            backdrop-filter: blur(8px);
        }

        @keyframes slideInFromRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Content Suggestions */
        .content-suggestions {
            background-color: white;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            padding: 0.75rem;
            margin-top: 0.25rem;
            max-width: 24rem;
            animation: fadeInUp 0.2s ease-out;
        }
        
        .dark .content-suggestions {
            background-color: #1e293b;
            border-color: #4b5563;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .suggestion-item {
            @apply block w-full text-left px-2 py-1 hover:bg-slate-100 dark:hover:bg-slate-700 rounded text-sm;
            transition: all 0.15s ease;
        }
        
        .suggestion-item.highlighted {
            @apply bg-indigo-100 text-indigo-800 border-indigo-300;
        }

        /* Chart Tooltip */
        .chart-tooltip {
            pointer-events: none;
            transform: translateX(-50%);
        }

        /* Drag & Drop */
        .drag-active {
            @apply relative;
        }

        .drag-active::before {
            content: '';
            @apply fixed inset-0 bg-blue-500 bg-opacity-10 backdrop-blur-sm z-30 pointer-events-none;
            animation: pulse 1s infinite;
        }

        .drop-zone-visible {
            @apply border-2 border-dashed border-blue-500 bg-blue-50 dark:bg-blue-900 dark:bg-opacity-20;
            animation: borderPulse 1s infinite;
        }

        .drag-over {
            @apply border-blue-600 bg-blue-100 dark:bg-blue-800 dark:bg-opacity-30;
        }

        @keyframes borderPulse {
            0%, 100% { border-color: rgb(59 130 246); }
            50% { border-color: rgb(147 197 253); }
        }

        /* Virtual Scrolling */
        .virtual-item {
            @apply border-b border-slate-200 dark:border-slate-700;
        }

        /* Auto-save indicator */
        .auto-save-indicator {
            @apply absolute -top-6 right-0 text-xs px-2 py-1 rounded transition-all duration-200 opacity-0;
        }

        .auto-save-indicator.show {
            @apply opacity-100;
        }

        .auto-save-indicator.saving {
            @apply bg-yellow-100 text-yellow-800;
        }

        .auto-save-indicator.saved {
            @apply bg-green-100 text-green-800;
        }

        .auto-save-indicator.error {
            @apply bg-red-100 text-red-800;
        }

        .auto-save-indicator.loaded {
            @apply bg-blue-100 text-blue-800;
        }

        /* Data Controls */
        .data-controls select,
        .data-controls button {
            @apply transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50;
        }

        /* Performance Metrics */
        .performance-badge {
            @apply inline-flex items-center px-2 py-1 rounded-full text-xs font-medium;
        }

        .performance-badge.excellent {
            @apply bg-green-100 text-green-800;
        }

        .performance-badge.good {
            @apply bg-yellow-100 text-yellow-800;
        }

        .performance-badge.needs-improvement {
            @apply bg-red-100 text-red-800;
        }

        /* Keyboard shortcut styling */
        kbd {
            @apply inline-flex items-center px-2 py-1 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded text-xs font-mono;
        }

        /* Upload progress */
        .upload-progress {
            @apply transition-all duration-300 ease-in-out;
        }

        /* Memory usage warning */
        .memory-warning {
            @apply fixed bottom-4 left-4 bg-orange-500 text-white px-4 py-2 rounded-lg shadow-lg z-50;
            animation: pulse 2s infinite;
        }

        /* Smooth scrolling for virtual lists */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            @apply bg-slate-100 dark:bg-slate-800;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            @apply bg-slate-300 dark:bg-slate-600 rounded-full hover:bg-slate-400 dark:hover:bg-slate-500;
        }

        /* Enhanced animations */
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        .animate-slide-in-right {
            animation: slideInRight 0.3s ease-out;
        }

        .animate-bounce-success {
            animation: bounceSuccess 0.6s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideInRight {
            from { transform: translateX(20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes bounceSuccess {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        /* Responsive enhancements */
        @media (max-width: 640px) {
            .smart-recommendation {
                @apply max-w-xs text-sm;
            }
            
            .content-suggestions {
                @apply max-w-xs;
            }
            
            .search-suggestions {
                @apply max-h-48;
            }
        }

        /* Mobile Interface Revolution Styles */
        
        /* Mobile breakpoint optimizations */
        @media (max-width: 768px) {
            /* Mobile-first layout */
            .bp-mobile #sidebar {
                @apply fixed inset-y-0 left-0 z-50 w-full max-w-sm -translate-x-full;
            }
            
            .bp-mobile #sidebar.open {
                @apply translate-x-0;
            }
            
            .bp-mobile .main-content {
                @apply pb-20; /* Space for mobile bottom navigation */
            }
            
            /* Touch-optimized elements */
            .note-card {
                @apply min-h-[44px] cursor-pointer;
                touch-action: pan-y;
            }
            
            .note-card[data-swipeable="true"] {
                position: relative;
                transition: transform 0.2s ease-out;
            }
            
            /* Mobile edit buttons */
            .mobile-edit-overlay {
                @apply absolute inset-0 bg-black bg-opacity-20 flex items-center justify-center opacity-0 pointer-events-none transition-opacity;
            }
            
            .note-card:hover .mobile-edit-overlay {
                @apply opacity-100 pointer-events-auto;
            }
        }
        
        /* Tablet optimizations */
        @media (min-width: 768px) and (max-width: 1024px) {
            .bp-tablet #sidebar {
                @apply w-80;
            }
            
            .bp-tablet .note-card {
                @apply p-4;
            }
        }
        
        /* Content density variations */
        .density-compact .note-card {
            @apply p-2 mb-1;
        }
        
        .density-compact .note-card h4 {
            @apply text-sm;
        }
        
        .density-comfortable .note-card {
            @apply p-3 mb-2;
        }
        
        .density-spacious .note-card {
            @apply p-5 mb-4;
        }
        
        /* Touch interaction feedback */
        .touch-highlight {
            @apply bg-slate-100;
        }
        
        /* Swipe action indicators */
        .swipe-indicator {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s ease;
            pointer-events: none;
            z-index: 10;
        }
        
        /* Mobile keyboard adjustments */
        .keyboard-visible .main-content {
            padding-bottom: 0 !important;
        }
        
        .keyboard-visible #mobile-bottom-nav {
            @apply translate-y-full;
        }
        
        .keyboard-visible #mobile-fab {
            @apply scale-0;
        }
        
        /* High contrast mode support */
        @media (prefers-contrast: high) {
            .note-card {
                @apply border-2 border-slate-300;
            }
            
            .note-card:hover,
            .note-card:focus {
                @apply border-slate-500;
            }
        }
        
        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            .note-card,
            .swipe-indicator,
            .mobile-edit-overlay {
                transition: none !important;
                animation: none !important;
            }
        }
        
        /* Dark mode support for mobile */
        @media (prefers-color-scheme: dark) {
            .note-card {
                @apply bg-slate-800 text-slate-200 border-slate-700;
            }
            
            .swipe-indicator {
                @apply text-white;
            }
        }

        /* PWA specific styles */
        @media (display-mode: standalone) {
            body {
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
                padding-left: env(safe-area-inset-left);
                padding-right: env(safe-area-inset-right);
            }
            
            .safe-top {
                padding-top: env(safe-area-inset-top);
            }
            
            .safe-bottom {
                padding-bottom: env(safe-area-inset-bottom);
            }
        }
        
        /* Mobile animations */
        @keyframes slide-up-mobile {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .animate-slide-up {
            animation: slide-up-mobile 0.3s ease-out;
        }
        
        @keyframes ripple-mobile {
            to {
                transform: scale(2.5);
                opacity: 0;
            }
        }
        
        .ripple-effect {
            animation: ripple-mobile 0.6s ease-out;
        }
        
        /* Performance optimizations */
        .gpu-accelerated {
            transform: translateZ(0);
            backface-visibility: hidden;
        }
        
        /* Loading states optimized for mobile */
        .skeleton-mobile {
            @apply animate-pulse bg-slate-200 rounded;
        }
        
        .skeleton-mobile-title {
            @apply h-4 bg-slate-200 rounded w-3/4 mb-2;
        }
        
        .skeleton-mobile-content {
            @apply h-3 bg-slate-200 rounded w-full mb-1;
        }
    </style>
    <!-- Toast Notification Container -->
    <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>
    
    <!-- Loading Overlay for Full Page Operations -->
    <div id="loadingOverlay" class="fixed inset-0 bg-slate-900 bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl p-8 shadow-2xl flex items-center space-x-4">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-discord-600"></div>
            <span class="text-slate-700 font-medium">Loading...</span>
        </div>
    </div>

    <!-- Note Details Modal -->
    <div id="noteDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm z-50 hidden flex items-start justify-center p-4 overflow-y-auto">
        <div class="bg-slate-900 rounded-xl max-w-4xl w-full my-8 shadow-2xl border border-slate-700">
            <!-- Modal Header -->
            <div class="flex items-center justify-between p-6 border-b border-slate-700">
                <div class="flex items-center space-x-3">
                    <div id="noteTypeIcon" class="w-8 h-8 rounded-full bg-slate-800 flex items-center justify-center">
                        <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                    </div>
                    <h2 id="noteDetailsTitle" class="text-xl font-semibold text-slate-200">Loading...</h2>
                </div>
                <div class="flex items-center space-x-2">
                    <!-- Action buttons -->
                    <button id="editNoteBtn" class="p-2 text-slate-400 hover:text-slate-200 hover:bg-slate-800 rounded-lg transition-all" title="Edit note">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                    </button>
                    <button id="archiveNoteBtn" class="p-2 text-slate-400 hover:text-blue-400 hover:bg-slate-800 rounded-lg transition-all" title="Archive note">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path>
                        </svg>
                    </button>
                    <button id="exportNoteBtn" class="p-2 text-slate-400 hover:text-green-400 hover:bg-slate-800 rounded-lg transition-all" title="Export note">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                        </svg>
                    </button>
                    <button id="deleteNoteBtn" class="p-2 text-slate-400 hover:text-red-400 hover:bg-slate-800 rounded-lg transition-all" title="Delete note">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                    </button>
                    <button onclick="closeNoteDetails()" class="p-2 text-slate-400 hover:text-slate-200 hover:bg-slate-800 rounded-lg transition-all">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Modal Content -->
            <div class="p-6 max-h-[calc(100vh-200px)] overflow-y-auto">
                <!-- Note Metadata -->
                <div id="noteMetadata" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-slate-800 p-3 rounded-lg border border-slate-700">
                        <div class="text-xs text-slate-500 font-medium mb-1">Type</div>
                        <div id="noteTypeDisplay" class="text-sm text-slate-300">-</div>
                    </div>
                    <div class="bg-slate-800 p-3 rounded-lg border border-slate-700">
                        <div class="text-xs text-slate-500 font-medium mb-1">Created</div>
                        <div id="noteCreatedDate" class="text-sm text-slate-300">-</div>
                    </div>
                    <div class="bg-slate-800 p-3 rounded-lg border border-slate-700">
                        <div class="text-xs text-slate-500 font-medium mb-1">Status</div>
                        <div id="noteStatusDisplay" class="text-sm text-slate-300">-</div>
                    </div>
                    <div class="bg-slate-800 p-3 rounded-lg border border-slate-700">
                        <div class="text-xs text-slate-500 font-medium mb-1">Word Count</div>
                        <div id="noteWordCount" class="text-sm text-slate-300">-</div>
                    </div>
                </div>

                <!-- Audio Playback Section -->
                <div id="audioSection" class="hidden mb-6">
                    <h3 class="text-lg font-medium text-slate-300 mb-4 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                        </svg>
                        Audio Recording
                    </h3>
                    <div class="bg-slate-800 p-4 rounded-lg border border-slate-700">
                        <!-- Audio Waveform Container -->
                        <div id="audioWaveform" class="bg-slate-900 relative overflow-hidden rounded-lg mb-4 h-24 flex items-center justify-center">
                            <div id="waveformArtwork" class="waveform-artwork">
                                <div class="waveform-backdrop" aria-hidden="true"></div>
                                <div class="waveform-idle" aria-hidden="true">
                                    <div class="waveform-pill">Audio</div>
                                    <svg viewBox="0 0 320 120" class="waveform-idle-graphic" fill="currentColor">
                                        <rect x="20" y="30" width="8" height="60" rx="4" opacity="0.25" />
                                        <rect x="44" y="20" width="8" height="80" rx="4" opacity="0.5" />
                                        <rect x="68" y="10" width="8" height="100" rx="4" opacity="0.65" />
                                        <rect x="92" y="40" width="8" height="40" rx="4" opacity="0.35" />
                                        <rect x="116" y="18" width="8" height="84" rx="4" opacity="0.6" />
                                        <rect x="140" y="34" width="8" height="52" rx="4" opacity="0.45" />
                                        <rect x="164" y="22" width="8" height="76" rx="4" opacity="0.75" />
                                        <rect x="188" y="10" width="8" height="100" rx="4" opacity="0.8" />
                                        <rect x="212" y="28" width="8" height="64" rx="4" opacity="0.55" />
                                        <rect x="236" y="36" width="8" height="48" rx="4" opacity="0.4" />
                                        <rect x="260" y="18" width="8" height="84" rx="4" opacity="0.65" />
                                        <rect x="284" y="32" width="8" height="56" rx="4" opacity="0.3" />
                                    </svg>
                                    <p class="waveform-caption">Press play to listen to your recording</p>
                                </div>
                                <div class="waveform-playing" aria-hidden="true">
                                    <div class="waveform-bar"></div>
                                    <div class="waveform-bar"></div>
                                    <div class="waveform-bar"></div>
                                    <div class="waveform-bar"></div>
                                    <div class="waveform-bar"></div>
                                    <div class="waveform-bar"></div>
                                    <div class="waveform-bar"></div>
                                    <div class="waveform-bar"></div>
                                </div>
                            </div>
                            <div id="waveformLoading" class="relative z-10 flex items-center gap-2 text-slate-400 text-sm">
                                <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-400"></div>
                                Loading audio...
                            </div>
                        </div>
                        
                        <!-- Audio Controls -->
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <button id="audioPlayBtn" class="flex items-center space-x-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-all">
                                    <svg id="audioPlayIcon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1.586a1 1 0 01.707.293l2.414 2.414a1 1 0 00.707.293H15M9 10v4a2 2 0 002 2h2a2 2 0 002-2v-4M9 10V6a2 2 0 012-2h2a2 2 0 012 2v4"></path>
                                    </svg>
                                    <span id="audioPlayText">Play</span>
                                </button>
                                <div class="text-sm text-slate-400">
                                    <span id="audioCurrentTime">0:00</span>
                                    <span class="mx-1">/</span>
                                    <span id="audioDuration">0:00</span>
                                </div>
                            </div>
                            <div class="flex items-center space-x-3">
                                <label class="text-sm text-slate-400">Speed:</label>
                                <select id="audioSpeedSelect" class="bg-slate-700 border border-slate-600 text-slate-300 text-sm rounded px-2 py-1">
                                    <option value="0.5">0.5x</option>
                                    <option value="0.75">0.75x</option>
                                    <option value="1" selected>1x</option>
                                    <option value="1.25">1.25x</option>
                                    <option value="1.5">1.5x</option>
                                    <option value="2">2x</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Note Content Sections -->
                <div class="space-y-6">
                    <!-- Summary Section -->
                    <div id="summarySection" class="hidden">
                        <h3 class="text-lg font-medium text-slate-300 mb-3">Summary</h3>
                        <div id="noteSummary" class="bg-slate-800 p-4 rounded-lg border border-slate-700 text-slate-300 whitespace-pre-line leading-relaxed"></div>
                    </div>

                    <!-- Action Items Section -->
                    <div id="actionsSection" class="hidden">
                        <h3 class="text-lg font-medium text-slate-300 mb-3">Action Items</h3>
                        <div id="noteActions" class="bg-slate-800 p-4 rounded-lg border border-slate-700">
                            <ul id="actionsList" class="space-y-2 text-slate-300"></ul>
                        </div>
                    </div>

                    <!-- Note Content Section -->
                    <div id="contentSection" class="hidden">
                        <h3 class="text-lg font-medium text-slate-300 mb-3">Note Content</h3>
                        <div id="noteContent" class="bg-slate-800 p-4 rounded-lg border border-slate-700 text-slate-300 whitespace-pre-line leading-relaxed"></div>
                    </div>

                    <!-- Extracted Text Section (OCR/PDF) -->
                    <div id="extractedTextSection" class="hidden">
                        <h3 class="text-lg font-medium text-slate-300 mb-3">Extracted Text (OCR/PDF)</h3>
                        <div id="noteExtractedText" class="bg-slate-800 p-4 rounded-lg border border-slate-700 text-slate-400 whitespace-pre-line leading-relaxed"></div>
                    </div>

                    <!-- Tags Section -->
                    <div id="tagsSection" class="hidden">
                        <h3 class="text-lg font-medium text-slate-300 mb-3">Tags</h3>
                        <div id="noteTags" class="flex flex-wrap gap-2"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global Theme Handling: dashboard default = dark, stored in localStorage
        (function(){
            const applyTheme = (mode) => {
                document.body.classList.remove('theme-light','theme-dark');
                document.body.classList.add(mode === 'dark' ? 'theme-dark' : 'theme-light');
                const btn = document.getElementById('theme-toggle');
                if (btn) btn.textContent = mode === 'dark' ? 'Dark' : 'Light';
            };
            const saved = localStorage.getItem('sb_theme') || 'dark';
            applyTheme(saved);
            const btn = document.getElementById('theme-toggle');
            if (btn) {
                btn.addEventListener('click', () => {
                    const current = document.body.classList.contains('theme-dark') ? 'dark' : 'light';
                    const next = current === 'dark' ? 'light' : 'dark';
                    localStorage.setItem('sb_theme', next);
                    applyTheme(next);
                });
            }
        })();

        // Session Storage for Form Data Management
        // Prevents sensitive content from appearing in URLs
        const SessionFormManager = {
            // Save form data to sessionStorage
            saveFormData: function(data) {
                try {
                    sessionStorage.setItem('sb_form_data', JSON.stringify({
                        ...data,
                        timestamp: Date.now()
                    }));
                    console.log('Form data saved to session storage');
                } catch (e) {
                    console.warn('Failed to save form data to session storage:', e);
                }
            },

            // Load and populate form fields from sessionStorage
            loadFormData: function() {
                try {
                    const stored = sessionStorage.getItem('sb_form_data');
                    if (!stored) return null;

                    const data = JSON.parse(stored);
                    
                    // Check if data is not too old (1 hour max)
                    if (Date.now() - data.timestamp > 3600000) {
                        this.clearFormData();
                        return null;
                    }

                    return data;
                } catch (e) {
                    console.warn('Failed to load form data from session storage:', e);
                    this.clearFormData();
                    return null;
                }
            },

            // Clear stored form data
            clearFormData: function() {
                try {
                    sessionStorage.removeItem('sb_form_data');
                    console.log('Form data cleared from session storage');
                } catch (e) {
                    console.warn('Failed to clear form data:', e);
                }
            },

            // Auto-populate forms when page loads
            populateFormsFromStorage: function() {
                const data = this.loadFormData();
                if (!data) return;

                // Populate main note creation form
                const titleField = document.getElementById('quickTitle');
                const contentField = document.getElementById('note');
                const tagsField = document.getElementById('tags');

                if (titleField && data.title) titleField.value = data.title;
                if (contentField && data.content) contentField.value = data.content;
                if (tagsField && data.tags) tagsField.value = data.tags;

                // Clear the data after populating to avoid persistent state
                this.clearFormData();
            },

            // Save current form state before navigation
            saveCurrentFormState: function() {
                const titleField = document.getElementById('quickTitle');
                const contentField = document.getElementById('note');
                const tagsField = document.getElementById('tags');

                const hasContent = (titleField && titleField.value.trim()) ||
                                 (contentField && contentField.value.trim()) ||
                                 (tagsField && tagsField.value.trim());

                if (hasContent) {
                    this.saveFormData({
                        title: titleField ? titleField.value : '',
                        content: contentField ? contentField.value : '',
                        tags: tagsField ? tagsField.value : ''
                    });
                }
            }
        };

        // Initialize session form manager on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Auto-populate forms from stored data
            SessionFormManager.populateFormsFromStorage();

            // Save form state before page unload
            window.addEventListener('beforeunload', function() {
                SessionFormManager.saveCurrentFormState();
            });

            // Also save form state on form submission to preserve data on error redirects
            const forms = document.querySelectorAll('form');
            forms.forEach(form => {
                form.addEventListener('submit', function() {
                    // Clear form data on successful submission
                    setTimeout(() => SessionFormManager.clearFormData(), 100);
                });
            });
        });

        // Make SessionFormManager globally available for other scripts
        window.SessionFormManager = SessionFormManager;
    </script>

</body>
</html>
