<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Forwarding Setup - Second Brain</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h1 class="text-3xl font-bold text-gray-900 mb-6">
                üìß Email Forwarding Setup
            </h1>
            
            <div class="prose max-w-none">
                <p class="text-lg text-gray-700 mb-8">
                    Forward important emails directly to your Second Brain for automatic processing and knowledge capture.
                </p>

                <!-- Current Status -->
                <div id="currentStatus" class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-8">
                    <h2 class="text-xl font-semibold text-blue-900 mb-4">üìä Current Status</h2>
                    <div id="statusContent">
                        <div class="flex items-center justify-center py-4">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                            <span class="ml-2 text-blue-700">Loading configuration...</span>
                        </div>
                    </div>
                </div>

                <!-- Quick Setup -->
                <div class="bg-green-50 border border-green-200 rounded-lg p-6 mb-8">
                    <h2 class="text-xl font-semibold text-green-900 mb-4">üöÄ Quick Setup</h2>
                    
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Choose your email provider:</label>
                        <select id="providerSelect" class="block w-full border border-gray-300 rounded px-3 py-2 bg-white">
                            <option value="gmail">Gmail</option>
                            <option value="outlook">Outlook.com</option>
                            <option value="apple">Apple Mail / iCloud</option>
                            <option value="thunderbird">Thunderbird</option>
                        </select>
                    </div>
                    
                    <button id="setupButton" class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition font-semibold">
                        üìß Generate Forwarding Address
                    </button>
                </div>

                <!-- Setup Instructions (hidden until generated) -->
                <div id="setupInstructions" class="hidden mb-8">
                    <h2 class="text-2xl font-bold text-gray-900 mb-6">üìã Setup Instructions</h2>
                    <div id="instructionsContent"></div>
                </div>

                <!-- Email Provider Guides -->
                <div class="grid md:grid-cols-2 gap-6 mb-8">
                    <!-- Gmail -->
                    <div class="border border-gray-200 rounded-lg p-6">
                        <div class="flex items-center mb-4">
                            <span class="text-2xl mr-3">üìÆ</span>
                            <h3 class="text-lg font-semibold">Gmail</h3>
                        </div>
                        <p class="text-gray-600 mb-4">Forward emails using Gmail's built-in forwarding feature.</p>
                        <div class="space-y-2 text-sm">
                            <div class="flex items-center">
                                <span class="w-2 h-2 bg-green-400 rounded-full mr-2"></span>
                                <span>Automatic forwarding</span>
                            </div>
                            <div class="flex items-center">
                                <span class="w-2 h-2 bg-green-400 rounded-full mr-2"></span>
                                <span>Filter-based forwarding</span>
                            </div>
                            <div class="flex items-center">
                                <span class="w-2 h-2 bg-green-400 rounded-full mr-2"></span>
                                <span>Label organization</span>
                            </div>
                        </div>
                    </div>

                    <!-- Outlook -->
                    <div class="border border-gray-200 rounded-lg p-6">
                        <div class="flex items-center mb-4">
                            <span class="text-2xl mr-3">üì¨</span>
                            <h3 class="text-lg font-semibold">Outlook.com</h3>
                        </div>
                        <p class="text-gray-600 mb-4">Use Outlook's rules and forwarding settings.</p>
                        <div class="space-y-2 text-sm">
                            <div class="flex items-center">
                                <span class="w-2 h-2 bg-blue-400 rounded-full mr-2"></span>
                                <span>Rule-based forwarding</span>
                            </div>
                            <div class="flex items-center">
                                <span class="w-2 h-2 bg-blue-400 rounded-full mr-2"></span>
                                <span>Conditional processing</span>
                            </div>
                            <div class="flex items-center">
                                <span class="w-2 h-2 bg-blue-400 rounded-full mr-2"></span>
                                <span>Calendar integration</span>
                            </div>
                        </div>
                    </div>

                    <!-- Apple Mail -->
                    <div class="border border-gray-200 rounded-lg p-6">
                        <div class="flex items-center mb-4">
                            <span class="text-2xl mr-3">üçé</span>
                            <h3 class="text-lg font-semibold">Apple Mail</h3>
                        </div>
                        <p class="text-gray-600 mb-4">Set up rules in macOS Mail app or iCloud.</p>
                        <div class="space-y-2 text-sm">
                            <div class="flex items-center">
                                <span class="w-2 h-2 bg-purple-400 rounded-full mr-2"></span>
                                <span>Mail rules</span>
                            </div>
                            <div class="flex items-center">
                                <span class="w-2 h-2 bg-purple-400 rounded-full mr-2"></span>
                                <span>VIP forwarding</span>
                            </div>
                            <div class="flex items-center">
                                <span class="w-2 h-2 bg-purple-400 rounded-full mr-2"></span>
                                <span>Smart mailboxes</span>
                            </div>
                        </div>
                    </div>

                    <!-- Generic -->
                    <div class="border border-gray-200 rounded-lg p-6">
                        <div class="flex items-center mb-4">
                            <span class="text-2xl mr-3">‚ö°</span>
                            <h3 class="text-lg font-semibold">Other Providers</h3>
                        </div>
                        <p class="text-gray-600 mb-4">Most email providers support forwarding or rules.</p>
                        <div class="space-y-2 text-sm">
                            <div class="flex items-center">
                                <span class="w-2 h-2 bg-gray-400 rounded-full mr-2"></span>
                                <span>IMAP integration</span>
                            </div>
                            <div class="flex items-center">
                                <span class="w-2 h-2 bg-gray-400 rounded-full mr-2"></span>
                                <span>Webhook support</span>
                            </div>
                            <div class="flex items-center">
                                <span class="w-2 h-2 bg-gray-400 rounded-full mr-2"></span>
                                <span>API integration</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Advanced Features -->
                <h2 class="text-2xl font-bold text-gray-900 mb-6">üîß Advanced Features</h2>
                
                <div class="grid md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6">
                        <h3 class="font-semibold text-yellow-900 mb-3">üè∑Ô∏è Smart Filtering</h3>
                        <p class="text-yellow-800 text-sm">
                            Create filters to forward only specific types of emails:
                        </p>
                        <ul class="text-yellow-800 text-sm mt-2 space-y-1">
                            <li>‚Ä¢ Receipts and invoices</li>
                            <li>‚Ä¢ Newsletter subscriptions</li>
                            <li>‚Ä¢ Work communications</li>
                            <li>‚Ä¢ Social media notifications</li>
                        </ul>
                    </div>
                    
                    <div class="bg-purple-50 border border-purple-200 rounded-lg p-6">
                        <h3 class="font-semibold text-purple-900 mb-3">ü§ñ AI Processing</h3>
                        <p class="text-purple-800 text-sm">
                            Emails are automatically processed with:
                        </p>
                        <ul class="text-purple-800 text-sm mt-2 space-y-1">
                            <li>‚Ä¢ Content summarization</li>
                            <li>‚Ä¢ Smart tagging</li>
                            <li>‚Ä¢ Action item extraction</li>
                            <li>‚Ä¢ Attachment processing</li>
                        </ul>
                    </div>
                    
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                        <h3 class="font-semibold text-blue-900 mb-3">üîÑ Integration</h3>
                        <p class="text-blue-800 text-sm">
                            Email forwarding works with:
                        </p>
                        <ul class="text-blue-800 text-sm mt-2 space-y-1">
                            <li>‚Ä¢ Calendar events</li>
                            <li>‚Ä¢ Contact information</li>
                            <li>‚Ä¢ Document attachments</li>
                            <li>‚Ä¢ Task creation</li>
                        </ul>
                    </div>
                </div>

                <!-- Statistics -->
                <div id="statisticsSection" class="bg-gray-50 border border-gray-200 rounded-lg p-6 mb-8 hidden">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">üìà Processing Statistics</h2>
                    <div id="statsContent" class="grid md:grid-cols-3 gap-6">
                        <!-- Stats will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Test Section -->
                <h2 class="text-2xl font-bold text-gray-900 mb-6">üß™ Test Your Setup</h2>
                
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-6 mb-8">
                    <h3 class="text-lg font-semibold mb-4">Quick Test</h3>
                    <p class="text-gray-700 mb-4">
                        Once you've set up forwarding, send a test email to verify everything is working:
                    </p>
                    
                    <div class="bg-white border border-gray-300 rounded p-4 mb-4">
                        <p class="text-sm text-gray-600 mb-2"><strong>To:</strong> <span id="testEmailAddress">Set up forwarding first</span></p>
                        <p class="text-sm text-gray-600 mb-2"><strong>Subject:</strong> Test Email for Second Brain</p>
                        <p class="text-sm text-gray-600"><strong>Body:</strong> This is a test email to verify my Second Brain email forwarding is working correctly.</p>
                    </div>
                    
                    <div class="flex space-x-4">
                        <button id="sendTestEmail" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition" disabled>
                            üìß Send Test Email
                        </button>
                        <button id="refreshStats" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 transition">
                            üîÑ Refresh Stats
                        </button>
                    </div>
                </div>

                <!-- Troubleshooting -->
                <h2 class="text-2xl font-bold text-gray-900 mb-6">üîß Troubleshooting</h2>
                
                <div class="space-y-4">
                    <details class="border border-gray-200 rounded-lg">
                        <summary class="p-4 cursor-pointer font-medium">Emails not appearing in Second Brain</summary>
                        <div class="p-4 border-t border-gray-200">
                            <ul class="list-disc list-inside space-y-2 text-sm text-gray-700">
                                <li>Check your email provider's forwarding settings are active</li>
                                <li>Verify the forwarding address is correct</li>
                                <li>Look in your email provider's sent folder to confirm forwards are being sent</li>
                                <li>Check your Second Brain dashboard after a few minutes (processing takes time)</li>
                                <li>Ensure your forwarding rules aren't too restrictive</li>
                            </ul>
                        </div>
                    </details>
                    
                    <details class="border border-gray-200 rounded-lg">
                        <summary class="p-4 cursor-pointer font-medium">Forwarding verification failed</summary>
                        <div class="p-4 border-t border-gray-200">
                            <ul class="list-disc list-inside space-y-2 text-sm text-gray-700">
                                <li>Check your email for verification messages</li>
                                <li>Look in spam/junk folders</li>
                                <li>Try generating a new forwarding address</li>
                                <li>Contact support if verification emails aren't arriving</li>
                            </ul>
                        </div>
                    </details>
                    
                    <details class="border border-gray-200 rounded-lg">
                        <summary class="p-4 cursor-pointer font-medium">Only some emails are being forwarded</summary>
                        <div class="p-4 border-t border-gray-200">
                            <ul class="list-disc list-inside space-y-2 text-sm text-gray-700">
                                <li>Review your forwarding filters and rules</li>
                                <li>Check if emails are being marked as spam</li>
                                <li>Verify sender addresses aren't blocked</li>
                                <li>Consider using broader filter criteria</li>
                            </ul>
                        </div>
                    </details>
                    
                    <details class="border border-gray-200 rounded-lg">
                        <summary class="p-4 cursor-pointer font-medium">Attachments not processing correctly</summary>
                        <div class="p-4 border-t border-gray-200">
                            <ul class="list-disc list-inside space-y-2 text-sm text-gray-700">
                                <li>Large attachments may take longer to process</li>
                                <li>Some file types may not be fully supported</li>
                                <li>Check attachment file sizes (limits may apply)</li>
                                <li>PDF and image files generally work best</li>
                            </ul>
                        </div>
                    </details>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentConfig = null;
        let forwardingAddress = null;

        // Load current configuration on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadCurrentConfig();
        });

        // Setup button click
        document.getElementById('setupButton').addEventListener('click', async function() {
            const provider = document.getElementById('providerSelect').value;
            this.disabled = true;
            this.innerHTML = '‚è≥ Setting up...';
            
            try {
                const response = await fetch('/api/mobile/email/setup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ provider: provider })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    forwardingAddress = result.forwarding_address;
                    showSetupInstructions(result.setup_instructions, provider);
                    updateTestEmailAddress();
                    loadCurrentConfig(); // Refresh status
                } else {
                    throw new Error('Setup failed');
                }
            } catch (error) {
                alert('Setup failed. Please try again.');
            } finally {
                this.disabled = false;
                this.innerHTML = 'üìß Generate Forwarding Address';
            }
        });

        // Refresh stats button
        document.getElementById('refreshStats').addEventListener('click', function() {
            loadEmailStats();
        });

        async function loadCurrentConfig() {
            try {
                const response = await fetch('/api/mobile/email/config');
                if (response.ok) {
                    currentConfig = await response.json();
                    if (currentConfig.forwarding_address) {
                        forwardingAddress = currentConfig.forwarding_address;
                        showCurrentStatus(currentConfig);
                        updateTestEmailAddress();
                        loadEmailStats();
                    } else {
                        showNoConfigStatus();
                    }
                } else {
                    showNoConfigStatus();
                }
            } catch (error) {
                console.error('Failed to load config:', error);
                showNoConfigStatus();
            }
        }

        async function loadEmailStats() {
            try {
                const response = await fetch('/api/mobile/email/stats');
                if (response.ok) {
                    const stats = await response.json();
                    showStatistics(stats);
                }
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        function showCurrentStatus(config) {
            const statusContent = document.getElementById('statusContent');
            const createdDate = new Date(config.created_at).toLocaleDateString();
            
            statusContent.innerHTML = `
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <h3 class="font-semibold text-blue-900 mb-2">‚úÖ Forwarding Active</h3>
                        <p class="text-sm text-blue-800"><strong>Address:</strong> ${config.forwarding_address}</p>
                        <p class="text-sm text-blue-800"><strong>Created:</strong> ${createdDate}</p>
                    </div>
                    <div>
                        <h3 class="font-semibold text-blue-900 mb-2">üìä Status</h3>
                        <p class="text-sm text-blue-800">Active and ready to receive emails</p>
                        <p class="text-sm text-blue-800">Processing emails automatically</p>
                    </div>
                </div>
            `;
        }

        function showNoConfigStatus() {
            const statusContent = document.getElementById('statusContent');
            statusContent.innerHTML = `
                <div class="text-center py-4">
                    <p class="text-blue-700 mb-2">üì§ No email forwarding configured</p>
                    <p class="text-sm text-blue-600">Use the quick setup below to get started</p>
                </div>
            `;
        }

        function showSetupInstructions(instructions, provider) {
            const instructionsDiv = document.getElementById('setupInstructions');
            const contentDiv = document.getElementById('instructionsContent');
            
            let stepsHtml = instructions.steps.map((step, index) => 
                `<li class="flex items-start space-x-3 mb-2">
                    <span class="bg-blue-500 text-white w-6 h-6 rounded-full flex items-center justify-center text-sm font-bold flex-shrink-0">${index + 1}</span>
                    <span class="text-gray-700">${step}</span>
                </li>`
            ).join('');

            let filtersHtml = '';
            if (instructions.filters) {
                filtersHtml = `
                    <div class="mt-6">
                        <h4 class="font-semibold text-gray-900 mb-3">üîç Smart Filtering Tips</h4>
                        <ul class="space-y-2">
                            ${instructions.filters.map(filter => `<li class="text-sm text-gray-600">‚Ä¢ ${filter}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            let tipsHtml = '';
            if (instructions.tips) {
                tipsHtml = `
                    <div class="mt-6">
                        <h4 class="font-semibold text-gray-900 mb-3">üí° Pro Tips</h4>
                        <ul class="space-y-2">
                            ${instructions.tips.map(tip => `<li class="text-sm text-gray-600">‚Ä¢ ${tip}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            contentDiv.innerHTML = `
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-6">
                    <div class="flex items-center mb-4">
                        <span class="text-2xl mr-3">üìß</span>
                        <h3 class="text-lg font-semibold">Your Forwarding Address</h3>
                    </div>
                    <div class="bg-white border rounded p-4 mb-4">
                        <code class="text-lg font-mono text-blue-600 select-all">${forwardingAddress}</code>
                        <button onclick="navigator.clipboard.writeText('${forwardingAddress}')" class="ml-4 text-sm bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 transition">
                            üìã Copy
                        </button>
                    </div>
                    <p class="text-sm text-blue-700">Use this address in your ${instructions.name || provider} forwarding settings.</p>
                </div>
                
                <div class="bg-white border border-gray-200 rounded-lg p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">${instructions.name || provider} Setup Steps</h3>
                    <ol class="space-y-4">
                        ${stepsHtml}
                    </ol>
                    ${filtersHtml}
                    ${tipsHtml}
                </div>
            `;
            
            instructionsDiv.classList.remove('hidden');
        }

        function updateTestEmailAddress() {
            if (forwardingAddress) {
                document.getElementById('testEmailAddress').textContent = forwardingAddress;
                document.getElementById('sendTestEmail').disabled = false;
            }
        }

        function showStatistics(stats) {
            const statsSection = document.getElementById('statisticsSection');
            const statsContent = document.getElementById('statsContent');
            
            let topSendersHtml = '';
            if (stats.top_senders && stats.top_senders.length > 0) {
                topSendersHtml = stats.top_senders.map(sender => 
                    `<div class="text-sm">${sender.sender}: ${sender.count} emails</div>`
                ).join('');
            } else {
                topSendersHtml = '<div class="text-sm text-gray-500">No emails processed yet</div>';
            }
            
            statsContent.innerHTML = `
                <div class="text-center">
                    <div class="text-2xl font-bold text-blue-600">${stats.total_processed}</div>
                    <div class="text-sm text-gray-600">Total Processed</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-green-600">${stats.success_rate}%</div>
                    <div class="text-sm text-gray-600">Success Rate</div>
                </div>
                <div>
                    <div class="text-sm font-semibold text-gray-700 mb-2">Top Senders</div>
                    ${topSendersHtml}
                </div>
            `;
            
            statsSection.classList.remove('hidden');
        }
    </script>
</body>
</html>